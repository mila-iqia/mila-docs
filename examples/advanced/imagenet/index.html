
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
        <link rel="canonical" href="https://mila-iqia.github.io/docs/examples/advanced/imagenet/">
      
      
        <link rel="prev" href="../">
      
      
        <link rel="next" href="../../../Theory_cluster_parts/">
      
      
        
      
      
      <link rel="icon" href="../../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.7.1">
    
    
      
        <title>Multi-Node / Multi-GPU ImageNet Training - Mila Technical Documentation</title>
      
    
    
      <link rel="stylesheet" href="../../../assets/stylesheets/main.484c7ddc.min.css">
      
        
        <link rel="stylesheet" href="../../../assets/stylesheets/palette.ab4e12ef.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("../../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#multi-node-multi-gpu-imagenet-training" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
        <aside class="md-banner">
          <div class="md-banner__inner md-grid md-typeset">
            
              <button class="md-banner__button md-icon" aria-label="Don't show this again">
                
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
              </button>
            
            
üéâ We're giving the docs a fresh makeover! You can expect things to move around a bit while we redesign and reorganize the documentation.
Fear not ‚Äî the old docs are still available at <a href="https://mila-docs.readthedocs.io">mila-docs.readthedocs.io</a>.
Spotted a
bug? üêõ <a href="https://github.com/mila-iqia/mila-docs/issues/new">File a
    ticket</a> and we'll take a look at it!

          </div>
          
            <script>var el=document.querySelector("[data-md-component=announce]");if(el){var content=el.querySelector(".md-typeset");__md_hash(content.innerHTML)===__md_get("__announce")&&(el.hidden=!0)}</script>
          
        </aside>
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../../.." title="Mila Technical Documentation" class="md-header__button md-logo" aria-label="Mila Technical Documentation" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Mila Technical Documentation
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Multi-Node / Multi-GPU ImageNet Training
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme)" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="m14.3 16-.7-2h-3.2l-.7 2H7.8L11 7h2l3.2 9zM20 8.69V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12zm-9.15 3.96h2.3L12 9z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_2" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme="slate" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to system preference"  type="radio" name="__palette" id="__palette_2">
    
      <label class="md-header__button md-icon" title="Switch to system preference" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12s-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
          <a href="javascript:void(0)" class="md-search__icon md-icon" title="Share" aria-label="Share" data-clipboard data-clipboard-text="" data-md-component="search-share" tabindex="-1">
            
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9a3 3 0 0 0-3 3 3 3 0 0 0 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.15c-.05.21-.08.43-.08.66 0 1.61 1.31 2.91 2.92 2.91s2.92-1.3 2.92-2.91A2.92 2.92 0 0 0 18 16.08"/></svg>
          </a>
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
      <div class="md-header__source">
        <a href="https://www.github.com/mila-iqia/mila-docs" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    mila-docs
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../.." title="Mila Technical Documentation" class="md-nav__button md-logo" aria-label="Mila Technical Documentation" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    Mila Technical Documentation
  </label>
  
    <div class="md-nav__source">
      <a href="https://www.github.com/mila-iqia/mila-docs" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    mila-docs
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    
    
      
        
      
        
      
    
    
    
      
        
        
      
    
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_1" >
        
          
          <label class="md-nav__link" for="__nav_1" id="__nav_1_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    
  
    Introduction
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_1">
            <span class="md-nav__icon md-icon"></span>
            
  
    Introduction
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Purpose/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Purpose of this documentation
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../CONTRIBUTING/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Contributing
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    
      
        
        
      
    
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" >
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    
  
    How-tos and Guides
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            
  
    How-tos and Guides
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Userguide_quick_start/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Quick Start
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Userguide_login/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Logging in to the cluster
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Userguide_running_code/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Running your code
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Userguide_portability/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Portability concerns and solutions
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Userguide_containers/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Using containers
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Userguide_sharing_data/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Sharing Data with ACLs
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Userguide_datasets/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Contributing datasets
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Userguide_data_transfer/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Data Transmission using Globus Connect Personal
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Userguide_multigpu/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Advanced SLURM usage and Multiple GPU jobs
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Userguide_multinode/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Multiple Nodes
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Userguide_wandb/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Weights and Biases (WandB)
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Userguide_comet/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Comet
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Userguide_jupyterhub/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    JupyterHub
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Userguide_singularity/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Singularity
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Userguide_faq/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Frequently asked questions (FAQ)
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
    
    
    
      
        
        
      
    
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" >
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    
  
    Systems and services
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            
  
    Systems and services
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_1" >
        
          
          <label class="md-nav__link" for="__nav_3_1" id="__nav_3_1_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Computing infrastructure and policies
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_1">
            <span class="md-nav__icon md-icon"></span>
            
  
    Computing infrastructure and policies
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Information/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Computing infrastructure and policies
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Information_roles_and_resources/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Roles and computing resources
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Information_nodes/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Node profile description
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Information_storage/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Storage
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Information_sharing_policies/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Data sharing policies
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Information_data_transmission/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Data Transmission
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Information_monitoring/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Monitoring
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Extra_compute/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Computational resources outside of Mila
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
    
    
    
      
        
        
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" checked>
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    
  
    Minimal Examples
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            
  
    Minimal Examples
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    
    
      
        
          
        
      
        
      
        
      
        
      
    
    
    
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_1" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../frameworks/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    
  
    Software Frameworks
  

    
  </span>
  
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_4_1" id="__nav_4_1_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_4_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4_1">
            <span class="md-nav__icon md-icon"></span>
            
  
    Software Frameworks
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../frameworks/pytorch_setup/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    PyTorch Setup
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../frameworks/jax_setup/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Jax Setup
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../frameworks/jax/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Jax
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
          
        
      
        
      
        
      
        
      
    
    
    
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_2" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../distributed/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    
  
    Distributed Training
  

    
  </span>
  
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_4_2" id="__nav_4_2_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_4_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4_2">
            <span class="md-nav__icon md-icon"></span>
            
  
    Distributed Training
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../distributed/single_gpu/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Single GPU Job
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../distributed/multi_gpu/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Multi-GPU Job
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../distributed/multi_node/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Multi-node Job
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
          
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_3" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../good_practices/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    
  
    Good Practices
  

    
  </span>
  
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_4_3" id="__nav_4_3_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_4_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4_3">
            <span class="md-nav__icon md-icon"></span>
            
  
    Good Practices
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../good_practices/checkpointing/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Checkpointing
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../good_practices/wandb_setup/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Weights & Biases (wandb) setup
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../good_practices/launch_many_jobs/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Launch many jobs from same shell script
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../good_practices/hpo_with_orion/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Hyperparameter Optimization with Orion
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../good_practices/many_tasks_per_gpu/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Launch many tasks on the same GPU
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../good_practices/slurm_job_arrays/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Launch many jobs using SLURM job arrays
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
    
  
  
  
    
    
      
        
          
        
      
        
      
    
    
    
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_4" checked>
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    
  
    Advanced Examples
  

    
  </span>
  
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_4_4" id="__nav_4_4_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_4_4_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_4_4">
            <span class="md-nav__icon md-icon"></span>
            
  
    Advanced Examples
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    
  
    Multi-Node / Multi-GPU ImageNet Training
  

    
  </span>
  
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    
  
    Multi-Node / Multi-GPU ImageNet Training
  

    
  </span>
  
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#running-this-example" class="md-nav__link">
    <span class="md-ellipsis">
      
        Running this example
      
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="https://mila-iqia.github.io/ResearchTemplate" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    üîó Research Project Template
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
    
    
    
      
        
        
      
    
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5" >
        
          
          <label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    
  
    General Theory
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5">
            <span class="md-nav__icon md-icon"></span>
            
  
    General Theory
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Theory_cluster_parts/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    What is a computer cluster?
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Theory_cluster_unix/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Unix
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Theory_cluster_batch_scheduling/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    The workload manager
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Theory_cluster_data/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Processing data
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Theory_cluster_software_deps/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Software on the cluster
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    
      
        
        
      
    
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6" >
        
          
          <label class="md-nav__link" for="__nav_6" id="__nav_6_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    
  
    Extras
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6">
            <span class="md-nav__icon md-icon"></span>
            
  
    Extras
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Acknowledgement/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Acknowledging Mila
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="https://datasets.server.mila.quebec/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Mila Datasets
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Audio_video/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Audio and video resources at Mila
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../VSCode/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Visual Studio Code
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../IDT/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Who, what, where is IDT
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Cheatsheet/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Cheat Sheet
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Environmental_impact/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Environmental Impact
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#running-this-example" class="md-nav__link">
    <span class="md-ellipsis">
      
        Running this example
      
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              
                




  <nav class="md-path" aria-label="Navigation" >
    <ol class="md-path__list">
      
      
        
  
  
    
    
      
  
  
    
    
      <li class="md-path__item">
        <a href="../../frameworks/" class="md-path__link">
          
  <span class="md-ellipsis">
    Minimal Examples
  </span>

        </a>
      </li>
    
  

    
  

      
        
  
  
    
    
      <li class="md-path__item">
        <a href="../" class="md-path__link">
          
  <span class="md-ellipsis">
    Advanced Examples
  </span>

        </a>
      </li>
    
  

      
    </ol>
  </nav>

              
              <article class="md-content__inner md-typeset">
                
                  



<h1 id="multi-node-multi-gpu-imagenet-training">Multi-Node / Multi-GPU ImageNet Training<a class="headerlink" href="#multi-node-multi-gpu-imagenet-training" title="Permanent link">&para;</a></h1>
<p>Prerequisites:</p>
<ul>
<li><a href="../../frameworks/pytorch_setup/">PyTorch Setup</a></li>
<li><a href="../../distributed/single_gpu/">Single GPU</a></li>
<li><a href="../../distributed/multi_gpu/">Multi-GPU</a></li>
<li><a href="../../distributed/multi_node/">Multi-node</a></li>
<li><a href="../../good_practices/checkpointing/">Checkpointing</a></li>
<li><a href="../../good_practices/launch_many_jobs/">Launch many jobs</a></li>
</ul>
<p>Other interesting resources:</p>
<ul>
<li><a href="https://sebarnold.net/dist_blog/">https://sebarnold.net/dist_blog/</a></li>
<li><a href="https://lambdalabs.com/blog/multi-node-pytorch-distributed-training-guide">Multi-node PyTorch distributed training guide</a></li>
</ul>
<p>Click here to see <a href="https://github.com/mila-iqia/mila-docs/tree/master/docs/examples/advanced/imagenet">the source code for this example</a></p>
<p>This is an advanced and quite lengthy example. We recommend viewing the files directly
on GitHub to get the best experience.</p>
<p><strong>pyproject.toml</strong></p>
<p>This is the configuration file for UV, which manages the dependencies for this project.</p>
<div class="language-toml highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="k">[project]</span>
</span><span id="__span-0-2"><a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;distributed-imagenet-example&quot;</span>
</span><span id="__span-0-3"><a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a><span class="n">version</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;0.1.0&quot;</span>
</span><span id="__span-0-4"><a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a><span class="n">description</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;Add your description here&quot;</span>
</span><span id="__span-0-5"><a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a><span class="n">readme</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;README.md&quot;</span>
</span><span id="__span-0-6"><a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a><span class="n">requires-python</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;&gt;=3.11,&lt;3.14&quot;</span>
</span><span id="__span-0-7"><a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a><span class="n">dependencies</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span>
</span><span id="__span-0-8"><a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a><span class="w">    </span><span class="s2">&quot;debugpy&gt;=1.8.16&quot;</span><span class="p">,</span>
</span><span id="__span-0-9"><a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a><span class="w">    </span><span class="s2">&quot;scipy&gt;=1.16.2&quot;</span><span class="p">,</span>
</span><span id="__span-0-10"><a id="__codelineno-0-10" name="__codelineno-0-10" href="#__codelineno-0-10"></a><span class="w">    </span><span class="s2">&quot;torch&gt;=2.7.1&quot;</span><span class="p">,</span>
</span><span id="__span-0-11"><a id="__codelineno-0-11" name="__codelineno-0-11" href="#__codelineno-0-11"></a><span class="w">    </span><span class="s2">&quot;torch-tb-profiler&gt;=0.4.3&quot;</span><span class="p">,</span>
</span><span id="__span-0-12"><a id="__codelineno-0-12" name="__codelineno-0-12" href="#__codelineno-0-12"></a><span class="w">    </span><span class="s2">&quot;torchvision&gt;=0.22.1&quot;</span><span class="p">,</span>
</span><span id="__span-0-13"><a id="__codelineno-0-13" name="__codelineno-0-13" href="#__codelineno-0-13"></a><span class="w">    </span><span class="s2">&quot;tqdm&gt;=4.67.1&quot;</span><span class="p">,</span>
</span><span id="__span-0-14"><a id="__codelineno-0-14" name="__codelineno-0-14" href="#__codelineno-0-14"></a><span class="w">    </span><span class="s2">&quot;rich&gt;=14.1.0&quot;</span><span class="p">,</span>
</span><span id="__span-0-15"><a id="__codelineno-0-15" name="__codelineno-0-15" href="#__codelineno-0-15"></a><span class="w">    </span><span class="s2">&quot;simple-parsing&gt;=0.1.7&quot;</span><span class="p">,</span>
</span><span id="__span-0-16"><a id="__codelineno-0-16" name="__codelineno-0-16" href="#__codelineno-0-16"></a><span class="w">    </span><span class="s2">&quot;scikit-learn&gt;=1.7.2&quot;</span><span class="p">,</span>
</span><span id="__span-0-17"><a id="__codelineno-0-17" name="__codelineno-0-17" href="#__codelineno-0-17"></a><span class="w">    </span><span class="s2">&quot;wandb&gt;=0.21.4&quot;</span><span class="p">,</span>
</span><span id="__span-0-18"><a id="__codelineno-0-18" name="__codelineno-0-18" href="#__codelineno-0-18"></a><span class="p">]</span>
</span><span id="__span-0-19"><a id="__codelineno-0-19" name="__codelineno-0-19" href="#__codelineno-0-19"></a>
</span><span id="__span-0-20"><a id="__codelineno-0-20" name="__codelineno-0-20" href="#__codelineno-0-20"></a><span class="c1">#ruff: increase max line length</span>
</span><span id="__span-0-21"><a id="__codelineno-0-21" name="__codelineno-0-21" href="#__codelineno-0-21"></a><span class="k">[tool.ruff]</span>
</span><span id="__span-0-22"><a id="__codelineno-0-22" name="__codelineno-0-22" href="#__codelineno-0-22"></a><span class="n">line-length</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">100</span>
</span></code></pre></div>
<p><strong>safe_sbatch</strong></p>
<p>This job script uses the <code>safe_sbatch</code> submission script to submit a job at the current git state.
This practice is recommended to ensure reproducibility, and to prevent changes in the python files between when the job
is submitted and when it starts to affect the results.</p>
<p>Unlike the script passed to sbatch, which is copied and saved with the job in SLURM (and reused when resuming a job),
the python files are not saved.</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1" href="#__codelineno-1-1"></a><span class="ch">#!/bin/bash</span>
</span><span id="__span-1-2"><a id="__codelineno-1-2" name="__codelineno-1-2" href="#__codelineno-1-2"></a><span class="nb">set</span><span class="w"> </span>-eof<span class="w"> </span>pipefail
</span><span id="__span-1-3"><a id="__codelineno-1-3" name="__codelineno-1-3" href="#__codelineno-1-3"></a><span class="nv">git_status</span><span class="o">=</span><span class="sb">`</span>git<span class="w"> </span>status<span class="w"> </span>--porcelain<span class="sb">`</span>
</span><span id="__span-1-4"><a id="__codelineno-1-4" name="__codelineno-1-4" href="#__codelineno-1-4"></a><span class="c1"># idea: Could add command-line arguments to control whether to add all changes and commit before sbatch.</span>
</span><span id="__span-1-5"><a id="__codelineno-1-5" name="__codelineno-1-5" href="#__codelineno-1-5"></a><span class="k">if</span><span class="w"> </span><span class="o">[[</span><span class="w"> </span>!<span class="w"> </span>-z<span class="w"> </span><span class="nv">$git_status</span><span class="w"> </span><span class="o">]]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
</span><span id="__span-1-6"><a id="__codelineno-1-6" name="__codelineno-1-6" href="#__codelineno-1-6"></a><span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;Your working directory is dirty! Please add and commit changes before continuing.&quot;</span>
</span><span id="__span-1-7"><a id="__codelineno-1-7" name="__codelineno-1-7" href="#__codelineno-1-7"></a><span class="w">    </span><span class="nb">exit</span><span class="w"> </span><span class="m">1</span>
</span><span id="__span-1-8"><a id="__codelineno-1-8" name="__codelineno-1-8" href="#__codelineno-1-8"></a><span class="k">fi</span><span class="p">;</span>
</span><span id="__span-1-9"><a id="__codelineno-1-9" name="__codelineno-1-9" href="#__codelineno-1-9"></a><span class="c1"># This environment variable will be available in the job script.</span>
</span><span id="__span-1-10"><a id="__codelineno-1-10" name="__codelineno-1-10" href="#__codelineno-1-10"></a><span class="c1"># It should be used to checkout the repo at this commit (in a different directory than the original).</span>
</span><span id="__span-1-11"><a id="__codelineno-1-11" name="__codelineno-1-11" href="#__codelineno-1-11"></a><span class="c1"># For example:</span>
</span><span id="__span-1-12"><a id="__codelineno-1-12" name="__codelineno-1-12" href="#__codelineno-1-12"></a><span class="c1"># ```</span>
</span><span id="__span-1-13"><a id="__codelineno-1-13" name="__codelineno-1-13" href="#__codelineno-1-13"></a><span class="c1"># git clone &quot;$repo&quot; &quot;$dest&quot;</span>
</span><span id="__span-1-14"><a id="__codelineno-1-14" name="__codelineno-1-14" href="#__codelineno-1-14"></a><span class="c1"># echo &quot;Checking out commit $GIT_COMMIT&quot;</span>
</span><span id="__span-1-15"><a id="__codelineno-1-15" name="__codelineno-1-15" href="#__codelineno-1-15"></a><span class="c1"># cd &quot;$dest&quot;</span>
</span><span id="__span-1-16"><a id="__codelineno-1-16" name="__codelineno-1-16" href="#__codelineno-1-16"></a><span class="c1"># git checkout $GIT_COMMIT</span>
</span><span id="__span-1-17"><a id="__codelineno-1-17" name="__codelineno-1-17" href="#__codelineno-1-17"></a><span class="c1"># ```</span>
</span><span id="__span-1-18"><a id="__codelineno-1-18" name="__codelineno-1-18" href="#__codelineno-1-18"></a><span class="nb">export</span><span class="w"> </span><span class="nv">GIT_COMMIT</span><span class="o">=</span><span class="sb">`</span>git<span class="w"> </span>rev-parse<span class="w"> </span>HEAD<span class="sb">`</span>
</span><span id="__span-1-19"><a id="__codelineno-1-19" name="__codelineno-1-19" href="#__codelineno-1-19"></a><span class="nb">exec</span><span class="w"> </span>sbatch<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$@</span><span class="s2">&quot;</span>
</span></code></pre></div>
<p><strong>job.sh</strong></p>
<p>This file uses a <code>code_checkpointing.sh</code> utility script.
For now, to keep this already very heavy example a bit lighter,
we do not include it here, but you can find it in the GitHub repository <a href="https://github.com/mila-iqia/mila-docs/tree/master/docs/examples/advanced/imagenet">here</a></p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1" href="#__codelineno-2-1"></a><span class="ch">#!/bin/bash</span>
</span><span id="__span-2-2"><a id="__codelineno-2-2" name="__codelineno-2-2" href="#__codelineno-2-2"></a><span class="c1">#SBATCH --ntasks=1</span>
</span><span id="__span-2-3"><a id="__codelineno-2-3" name="__codelineno-2-3" href="#__codelineno-2-3"></a><span class="c1">#SBATCH --cpus-per-task=4</span>
</span><span id="__span-2-4"><a id="__codelineno-2-4" name="__codelineno-2-4" href="#__codelineno-2-4"></a><span class="c1">#SBATCH --gpus-per-task=l40s:1</span>
</span><span id="__span-2-5"><a id="__codelineno-2-5" name="__codelineno-2-5" href="#__codelineno-2-5"></a><span class="c1">#SBATCH --mem-per-gpu=16G</span>
</span><span id="__span-2-6"><a id="__codelineno-2-6" name="__codelineno-2-6" href="#__codelineno-2-6"></a><span class="c1">#SBATCH --tmp=200G  # We need 200GB of storage on the local disk of each node.</span>
</span><span id="__span-2-7"><a id="__codelineno-2-7" name="__codelineno-2-7" href="#__codelineno-2-7"></a><span class="c1">#SBATCH --time=02:00:00</span>
</span><span id="__span-2-8"><a id="__codelineno-2-8" name="__codelineno-2-8" href="#__codelineno-2-8"></a><span class="c1">#SBATCH --output=checkpoints/%j/out.txt</span>
</span><span id="__span-2-9"><a id="__codelineno-2-9" name="__codelineno-2-9" href="#__codelineno-2-9"></a>
</span><span id="__span-2-10"><a id="__codelineno-2-10" name="__codelineno-2-10" href="#__codelineno-2-10"></a><span class="nb">set</span><span class="w"> </span>-e<span class="w">  </span><span class="c1"># exit on error.</span>
</span><span id="__span-2-11"><a id="__codelineno-2-11" name="__codelineno-2-11" href="#__codelineno-2-11"></a><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;Date:     </span><span class="k">$(</span>date<span class="k">)</span><span class="s2">&quot;</span>
</span><span id="__span-2-12"><a id="__codelineno-2-12" name="__codelineno-2-12" href="#__codelineno-2-12"></a><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;Hostname: </span><span class="k">$(</span>hostname<span class="k">)</span><span class="s2">&quot;</span>
</span><span id="__span-2-13"><a id="__codelineno-2-13" name="__codelineno-2-13" href="#__codelineno-2-13"></a><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;Attempt #</span><span class="si">${</span><span class="nv">SLURM_RESTART_COUNT</span><span class="k">:-</span><span class="nv">0</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="__span-2-14"><a id="__codelineno-2-14" name="__codelineno-2-14" href="#__codelineno-2-14"></a>
</span><span id="__span-2-15"><a id="__codelineno-2-15" name="__codelineno-2-15" href="#__codelineno-2-15"></a><span class="c1"># Make sure to use UV_OFFLINE=1 on DRAC clusters where compute nodes don&#39;t have internet access,</span>
</span><span id="__span-2-16"><a id="__codelineno-2-16" name="__codelineno-2-16" href="#__codelineno-2-16"></a><span class="c1"># or use `module load httpproxy/1.0` if it works.</span>
</span><span id="__span-2-17"><a id="__codelineno-2-17" name="__codelineno-2-17" href="#__codelineno-2-17"></a><span class="c1"># Note: You will either have to warm up the uv cache before submitting your job so  or use the drac wheelhouse as a source.</span>
</span><span id="__span-2-18"><a id="__codelineno-2-18" name="__codelineno-2-18" href="#__codelineno-2-18"></a><span class="c1"># export UV_OFFLINE=1</span>
</span><span id="__span-2-19"><a id="__codelineno-2-19" name="__codelineno-2-19" href="#__codelineno-2-19"></a>
</span><span id="__span-2-20"><a id="__codelineno-2-20" name="__codelineno-2-20" href="#__codelineno-2-20"></a><span class="c1">## Code checkpointing with git to avoid unexpected bugs ##</span>
</span><span id="__span-2-21"><a id="__codelineno-2-21" name="__codelineno-2-21" href="#__codelineno-2-21"></a><span class="nv">UV_DIR</span><span class="o">=</span><span class="k">$(</span>./code_checkpointing.sh<span class="k">)</span>
</span><span id="__span-2-22"><a id="__codelineno-2-22" name="__codelineno-2-22" href="#__codelineno-2-22"></a><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;Git commit used for this job: </span><span class="si">${</span><span class="nv">GIT_COMMIT</span><span class="k">:-</span><span class="nv">not</span><span class="p"> set - code checkpointing is not enabled</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="__span-2-23"><a id="__codelineno-2-23" name="__codelineno-2-23" href="#__codelineno-2-23"></a><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;Running uv commands in directory: </span><span class="nv">$UV_DIR</span><span class="s2">&quot;</span>
</span><span id="__span-2-24"><a id="__codelineno-2-24" name="__codelineno-2-24" href="#__codelineno-2-24"></a>
</span><span id="__span-2-25"><a id="__codelineno-2-25" name="__codelineno-2-25" href="#__codelineno-2-25"></a><span class="c1"># Stage dataset into $SLURM_TMPDIR</span>
</span><span id="__span-2-26"><a id="__codelineno-2-26" name="__codelineno-2-26" href="#__codelineno-2-26"></a><span class="c1"># Prepare the dataset on each node&#39;s local storage using all the CPUs (and memory) of each node.</span>
</span><span id="__span-2-27"><a id="__codelineno-2-27" name="__codelineno-2-27" href="#__codelineno-2-27"></a>mkdir<span class="w"> </span>-p<span class="w"> </span><span class="nv">$SLURM_TMPDIR</span>/data
</span><span id="__span-2-28"><a id="__codelineno-2-28" name="__codelineno-2-28" href="#__codelineno-2-28"></a>srun<span class="w"> </span>--ntasks-per-node<span class="o">=</span><span class="m">1</span><span class="w"> </span>--ntasks<span class="o">=</span><span class="si">${</span><span class="nv">SLURM_JOB_NUM_NODES</span><span class="k">:-</span><span class="nv">1</span><span class="si">}</span><span class="w"> </span>bash<span class="w"> </span>-c<span class="w"> </span><span class="se">\</span>
</span><span id="__span-2-29"><a id="__codelineno-2-29" name="__codelineno-2-29" href="#__codelineno-2-29"></a><span class="w">    </span><span class="s2">&quot;uv run --directory=</span><span class="nv">$UV_DIR</span><span class="s2"> python prepare_data.py --dest \$SLURM_TMPDIR/data&quot;</span>
</span><span id="__span-2-30"><a id="__codelineno-2-30" name="__codelineno-2-30" href="#__codelineno-2-30"></a>
</span><span id="__span-2-31"><a id="__codelineno-2-31" name="__codelineno-2-31" href="#__codelineno-2-31"></a>
</span><span id="__span-2-32"><a id="__codelineno-2-32" name="__codelineno-2-32" href="#__codelineno-2-32"></a><span class="c1"># These environment variables are used by torch.distributed and should ideally be set</span>
</span><span id="__span-2-33"><a id="__codelineno-2-33" name="__codelineno-2-33" href="#__codelineno-2-33"></a><span class="c1"># before running the python script, or at the very beginning of the python script.</span>
</span><span id="__span-2-34"><a id="__codelineno-2-34" name="__codelineno-2-34" href="#__codelineno-2-34"></a><span class="c1"># Master address is the hostname of the first node in the job.</span>
</span><span id="__span-2-35"><a id="__codelineno-2-35" name="__codelineno-2-35" href="#__codelineno-2-35"></a><span class="nb">export</span><span class="w"> </span><span class="nv">MASTER_ADDR</span><span class="o">=</span><span class="k">$(</span>scontrol<span class="w"> </span>show<span class="w"> </span>hostnames<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$SLURM_JOB_NODELIST</span><span class="s2">&quot;</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>head<span class="w"> </span>-n<span class="w"> </span><span class="m">1</span><span class="k">)</span>
</span><span id="__span-2-36"><a id="__codelineno-2-36" name="__codelineno-2-36" href="#__codelineno-2-36"></a><span class="c1"># Get a unique port for this job based on the job ID</span>
</span><span id="__span-2-37"><a id="__codelineno-2-37" name="__codelineno-2-37" href="#__codelineno-2-37"></a><span class="nb">export</span><span class="w"> </span><span class="nv">MASTER_PORT</span><span class="o">=</span><span class="k">$(</span>expr<span class="w"> </span><span class="m">10000</span><span class="w"> </span>+<span class="w"> </span><span class="k">$(</span><span class="nb">echo</span><span class="w"> </span>-n<span class="w"> </span><span class="nv">$SLURM_JOB_ID</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>tail<span class="w"> </span>-c<span class="w"> </span><span class="m">4</span><span class="k">))</span>
</span><span id="__span-2-38"><a id="__codelineno-2-38" name="__codelineno-2-38" href="#__codelineno-2-38"></a><span class="nb">export</span><span class="w"> </span><span class="nv">WORLD_SIZE</span><span class="o">=</span><span class="nv">$SLURM_NTASKS</span>
</span><span id="__span-2-39"><a id="__codelineno-2-39" name="__codelineno-2-39" href="#__codelineno-2-39"></a>
</span><span id="__span-2-40"><a id="__codelineno-2-40" name="__codelineno-2-40" href="#__codelineno-2-40"></a><span class="c1"># srun is always used to launch the tasks.</span>
</span><span id="__span-2-41"><a id="__codelineno-2-41" name="__codelineno-2-41" href="#__codelineno-2-41"></a><span class="c1"># Whether there is one &#39;task&#39; per GPU or one task per node can vary based on your setup.</span>
</span><span id="__span-2-42"><a id="__codelineno-2-42" name="__codelineno-2-42" href="#__codelineno-2-42"></a><span class="c1"># In the latter case, you would typically use torchrun or accelerate to launch one processes</span>
</span><span id="__span-2-43"><a id="__codelineno-2-43" name="__codelineno-2-43" href="#__codelineno-2-43"></a><span class="c1"># per GPU within each task.</span>
</span><span id="__span-2-44"><a id="__codelineno-2-44" name="__codelineno-2-44" href="#__codelineno-2-44"></a><span class="c1"># See the commented examples below for different ways to launch the training script.</span>
</span><span id="__span-2-45"><a id="__codelineno-2-45" name="__codelineno-2-45" href="#__codelineno-2-45"></a>
</span><span id="__span-2-46"><a id="__codelineno-2-46" name="__codelineno-2-46" href="#__codelineno-2-46"></a><span class="c1"># Important note: In all cases, some variables (for example RANK, LOCAL_RANK, or machine_rank</span>
</span><span id="__span-2-47"><a id="__codelineno-2-47" name="__codelineno-2-47" href="#__codelineno-2-47"></a><span class="c1"># in accelerate) vary between tasks, so we need to escape env variables such as $SLURM_PROCID,</span>
</span><span id="__span-2-48"><a id="__codelineno-2-48" name="__codelineno-2-48" href="#__codelineno-2-48"></a><span class="c1"># $SLURM_TMPDIR and $SLURM_NODEID so they are evaluated within each task, not just once here</span>
</span><span id="__span-2-49"><a id="__codelineno-2-49" name="__codelineno-2-49" href="#__codelineno-2-49"></a><span class="c1"># on the first node.</span>
</span><span id="__span-2-50"><a id="__codelineno-2-50" name="__codelineno-2-50" href="#__codelineno-2-50"></a>
</span><span id="__span-2-51"><a id="__codelineno-2-51" name="__codelineno-2-51" href="#__codelineno-2-51"></a><span class="c1">## Pure Slurm version ##</span>
</span><span id="__span-2-52"><a id="__codelineno-2-52" name="__codelineno-2-52" href="#__codelineno-2-52"></a><span class="c1"># They can either be set here or as early as possible in the Python script.</span>
</span><span id="__span-2-53"><a id="__codelineno-2-53" name="__codelineno-2-53" href="#__codelineno-2-53"></a><span class="c1"># Use `uv run --offline` on clusters without internet access on compute nodes.</span>
</span><span id="__span-2-54"><a id="__codelineno-2-54" name="__codelineno-2-54" href="#__codelineno-2-54"></a><span class="c1"># Using `srun` executes the command once per task, once per GPU in our case.</span>
</span><span id="__span-2-55"><a id="__codelineno-2-55" name="__codelineno-2-55" href="#__codelineno-2-55"></a><span class="c1"># --gres-flags=allow-task-sharing is required to allow tasks on the same node to</span>
</span><span id="__span-2-56"><a id="__codelineno-2-56" name="__codelineno-2-56" href="#__codelineno-2-56"></a><span class="c1"># access GPUs allocated to other tasks on that node. Without this flag,</span>
</span><span id="__span-2-57"><a id="__codelineno-2-57" name="__codelineno-2-57" href="#__codelineno-2-57"></a><span class="c1"># --gpus-per-task=1 would isolate each task to only see its own GPU, which</span>
</span><span id="__span-2-58"><a id="__codelineno-2-58" name="__codelineno-2-58" href="#__codelineno-2-58"></a><span class="c1"># causes a a mysterious NCCL error in</span>
</span><span id="__span-2-59"><a id="__codelineno-2-59" name="__codelineno-2-59" href="#__codelineno-2-59"></a><span class="c1"># nn.parallel.DistributedDataParallel:</span>
</span><span id="__span-2-60"><a id="__codelineno-2-60" name="__codelineno-2-60" href="#__codelineno-2-60"></a><span class="c1"># ncclUnhandledCudaError: Call to CUDA function failed.</span>
</span><span id="__span-2-61"><a id="__codelineno-2-61" name="__codelineno-2-61" href="#__codelineno-2-61"></a><span class="c1"># when NCCL tries to communicate to local GPUs via shared memory but fails due</span>
</span><span id="__span-2-62"><a id="__codelineno-2-62" name="__codelineno-2-62" href="#__codelineno-2-62"></a><span class="c1"># to cgroups isolation. See https://slurm.schedmd.com/srun.html#OPT_gres-flags</span>
</span><span id="__span-2-63"><a id="__codelineno-2-63" name="__codelineno-2-63" href="#__codelineno-2-63"></a><span class="c1"># and https://support.schedmd.com/show_bug.cgi?id=17875 for details.</span>
</span><span id="__span-2-64"><a id="__codelineno-2-64" name="__codelineno-2-64" href="#__codelineno-2-64"></a>srun<span class="w"> </span>--gres-flags<span class="o">=</span>allow-task-sharing<span class="w"> </span>bash<span class="w"> </span>-c<span class="w"> </span><span class="se">\</span>
</span><span id="__span-2-65"><a id="__codelineno-2-65" name="__codelineno-2-65" href="#__codelineno-2-65"></a><span class="w">    </span><span class="s2">&quot;RANK=\$SLURM_PROCID LOCAL_RANK=\$SLURM_LOCALID \</span>
</span><span id="__span-2-66"><a id="__codelineno-2-66" name="__codelineno-2-66" href="#__codelineno-2-66"></a><span class="s2">    uv run --directory=</span><span class="nv">$UV_DIR</span><span class="s2"> \</span>
</span><span id="__span-2-67"><a id="__codelineno-2-67" name="__codelineno-2-67" href="#__codelineno-2-67"></a><span class="s2">    python main.py --dataset_path=\$SLURM_TMPDIR/data </span><span class="nv">$@</span><span class="s2">&quot;</span>
</span><span id="__span-2-68"><a id="__codelineno-2-68" name="__codelineno-2-68" href="#__codelineno-2-68"></a>
</span><span id="__span-2-69"><a id="__codelineno-2-69" name="__codelineno-2-69" href="#__codelineno-2-69"></a><span class="c1">## srun + torchrun version ##</span>
</span><span id="__span-2-70"><a id="__codelineno-2-70" name="__codelineno-2-70" href="#__codelineno-2-70"></a><span class="c1"># srun --ntasks-per-node=1 bash -c &quot;\</span>
</span><span id="__span-2-71"><a id="__codelineno-2-71" name="__codelineno-2-71" href="#__codelineno-2-71"></a><span class="c1">#     uv run torchrun --node-rank=\$SLURM_NODEID --nnodes=\$SLURM_STEP_NUM_NODES \</span>
</span><span id="__span-2-72"><a id="__codelineno-2-72" name="__codelineno-2-72" href="#__codelineno-2-72"></a><span class="c1">#     --master-addr=$MASTER_ADDR --master-port=$MASTER_PORT --nproc-per-node=gpu \</span>
</span><span id="__span-2-73"><a id="__codelineno-2-73" name="__codelineno-2-73" href="#__codelineno-2-73"></a><span class="c1">#     main.py $@&quot;</span>
</span><span id="__span-2-74"><a id="__codelineno-2-74" name="__codelineno-2-74" href="#__codelineno-2-74"></a>
</span><span id="__span-2-75"><a id="__codelineno-2-75" name="__codelineno-2-75" href="#__codelineno-2-75"></a><span class="c1">## srun + accelerate version ##</span>
</span><span id="__span-2-76"><a id="__codelineno-2-76" name="__codelineno-2-76" href="#__codelineno-2-76"></a><span class="c1">## NOTE: This particular example doesn&#39;t use accelerate, this is just here to illustrate.</span>
</span><span id="__span-2-77"><a id="__codelineno-2-77" name="__codelineno-2-77" href="#__codelineno-2-77"></a><span class="c1"># srun --ntasks-per-node=1 bash -c &quot;\</span>
</span><span id="__span-2-78"><a id="__codelineno-2-78" name="__codelineno-2-78" href="#__codelineno-2-78"></a><span class="c1">#     uv run --directory=$UV_DIR \</span>
</span><span id="__span-2-79"><a id="__codelineno-2-79" name="__codelineno-2-79" href="#__codelineno-2-79"></a><span class="c1">#     accelerate launch \</span>
</span><span id="__span-2-80"><a id="__codelineno-2-80" name="__codelineno-2-80" href="#__codelineno-2-80"></a><span class="c1">#     --machine_rank \$SLURM_NODEID \</span>
</span><span id="__span-2-81"><a id="__codelineno-2-81" name="__codelineno-2-81" href="#__codelineno-2-81"></a><span class="c1">#     --main_process_ip $MASTER_ADDR --main_process_port $MASTER_PORT \</span>
</span><span id="__span-2-82"><a id="__codelineno-2-82" name="__codelineno-2-82" href="#__codelineno-2-82"></a><span class="c1">#     --num_machines  $SLURM_NNODES --num_processes $SLURM_NTASKS \</span>
</span><span id="__span-2-83"><a id="__codelineno-2-83" name="__codelineno-2-83" href="#__codelineno-2-83"></a><span class="c1">#     main.py $@&quot;</span>
</span></code></pre></div>
<p><strong>prepare_data.py</strong></p>
<p>This script downloads and prepares the ImageNet dataset.
You need to run it once before running the main training script.</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-3-1"><a id="__codelineno-3-1" name="__codelineno-3-1" href="#__codelineno-3-1"></a><span class="sd">&quot;&quot;&quot;Dataset preprocessing script.</span>
</span><span id="__span-3-2"><a id="__codelineno-3-2" name="__codelineno-3-2" href="#__codelineno-3-2"></a>
</span><span id="__span-3-3"><a id="__codelineno-3-3" name="__codelineno-3-3" href="#__codelineno-3-3"></a><span class="sd">Run this with `srun --ntasks-per-node=1 --pty uv run python prepare_data.py`</span>
</span><span id="__span-3-4"><a id="__codelineno-3-4" name="__codelineno-3-4" href="#__codelineno-3-4"></a><span class="sd">&quot;&quot;&quot;</span>
</span><span id="__span-3-5"><a id="__codelineno-3-5" name="__codelineno-3-5" href="#__codelineno-3-5"></a>
</span><span id="__span-3-6"><a id="__codelineno-3-6" name="__codelineno-3-6" href="#__codelineno-3-6"></a><span class="kn">import</span><span class="w"> </span><span class="nn">argparse</span>
</span><span id="__span-3-7"><a id="__codelineno-3-7" name="__codelineno-3-7" href="#__codelineno-3-7"></a><span class="kn">import</span><span class="w"> </span><span class="nn">datetime</span>
</span><span id="__span-3-8"><a id="__codelineno-3-8" name="__codelineno-3-8" href="#__codelineno-3-8"></a><span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
</span><span id="__span-3-9"><a id="__codelineno-3-9" name="__codelineno-3-9" href="#__codelineno-3-9"></a><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Literal</span>
</span><span id="__span-3-10"><a id="__codelineno-3-10" name="__codelineno-3-10" href="#__codelineno-3-10"></a><span class="kn">from</span><span class="w"> </span><span class="nn">torchvision.datasets</span><span class="w"> </span><span class="kn">import</span> <span class="n">ImageNet</span>
</span><span id="__span-3-11"><a id="__codelineno-3-11" name="__codelineno-3-11" href="#__codelineno-3-11"></a><span class="kn">from</span><span class="w"> </span><span class="nn">pathlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">Path</span>
</span><span id="__span-3-12"><a id="__codelineno-3-12" name="__codelineno-3-12" href="#__codelineno-3-12"></a>
</span><span id="__span-3-13"><a id="__codelineno-3-13" name="__codelineno-3-13" href="#__codelineno-3-13"></a><span class="n">SLURM_TMPDIR</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;SLURM_TMPDIR&quot;</span><span class="p">])</span>
</span><span id="__span-3-14"><a id="__codelineno-3-14" name="__codelineno-3-14" href="#__codelineno-3-14"></a><span class="n">NETWORK_IMAGENET_DIR</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s2">&quot;/network/datasets/imagenet&quot;</span><span class="p">)</span>
</span><span id="__span-3-15"><a id="__codelineno-3-15" name="__codelineno-3-15" href="#__codelineno-3-15"></a>
</span><span id="__span-3-16"><a id="__codelineno-3-16" name="__codelineno-3-16" href="#__codelineno-3-16"></a>
</span><span id="__span-3-17"><a id="__codelineno-3-17" name="__codelineno-3-17" href="#__codelineno-3-17"></a><span class="k">def</span><span class="w"> </span><span class="nf">main</span><span class="p">():</span>
</span><span id="__span-3-18"><a id="__codelineno-3-18" name="__codelineno-3-18" href="#__codelineno-3-18"></a>    <span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">(</span>
</span><span id="__span-3-19"><a id="__codelineno-3-19" name="__codelineno-3-19" href="#__codelineno-3-19"></a>        <span class="n">description</span><span class="o">=</span><span class="vm">__doc__</span><span class="p">,</span> <span class="n">formatter_class</span><span class="o">=</span><span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentDefaultsHelpFormatter</span>
</span><span id="__span-3-20"><a id="__codelineno-3-20" name="__codelineno-3-20" href="#__codelineno-3-20"></a>    <span class="p">)</span>
</span><span id="__span-3-21"><a id="__codelineno-3-21" name="__codelineno-3-21" href="#__codelineno-3-21"></a>    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="__span-3-22"><a id="__codelineno-3-22" name="__codelineno-3-22" href="#__codelineno-3-22"></a>        <span class="s2">&quot;--dest&quot;</span><span class="p">,</span>
</span><span id="__span-3-23"><a id="__codelineno-3-23" name="__codelineno-3-23" href="#__codelineno-3-23"></a>        <span class="nb">type</span><span class="o">=</span><span class="n">Path</span><span class="p">,</span>
</span><span id="__span-3-24"><a id="__codelineno-3-24" name="__codelineno-3-24" href="#__codelineno-3-24"></a>        <span class="n">default</span><span class="o">=</span><span class="n">SLURM_TMPDIR</span> <span class="o">/</span> <span class="s2">&quot;data&quot;</span><span class="p">,</span>
</span><span id="__span-3-25"><a id="__codelineno-3-25" name="__codelineno-3-25" href="#__codelineno-3-25"></a>        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Where to prepare the dataset.&quot;</span><span class="p">,</span>
</span><span id="__span-3-26"><a id="__codelineno-3-26" name="__codelineno-3-26" href="#__codelineno-3-26"></a>    <span class="p">)</span>
</span><span id="__span-3-27"><a id="__codelineno-3-27" name="__codelineno-3-27" href="#__codelineno-3-27"></a>    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span><span id="__span-3-28"><a id="__codelineno-3-28" name="__codelineno-3-28" href="#__codelineno-3-28"></a>        <span class="s2">&quot;--network-imagenet-dir&quot;</span><span class="p">,</span>
</span><span id="__span-3-29"><a id="__codelineno-3-29" name="__codelineno-3-29" href="#__codelineno-3-29"></a>        <span class="nb">type</span><span class="o">=</span><span class="n">Path</span><span class="p">,</span>
</span><span id="__span-3-30"><a id="__codelineno-3-30" name="__codelineno-3-30" href="#__codelineno-3-30"></a>        <span class="n">default</span><span class="o">=</span><span class="n">NETWORK_IMAGENET_DIR</span><span class="p">,</span>
</span><span id="__span-3-31"><a id="__codelineno-3-31" name="__codelineno-3-31" href="#__codelineno-3-31"></a>        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;The path to the folder containing the ILSVRC2012 train and val archives and devkit.&quot;</span><span class="p">,</span>
</span><span id="__span-3-32"><a id="__codelineno-3-32" name="__codelineno-3-32" href="#__codelineno-3-32"></a>    <span class="p">)</span>
</span><span id="__span-3-33"><a id="__codelineno-3-33" name="__codelineno-3-33" href="#__codelineno-3-33"></a>    <span class="n">dest</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">()</span><span class="o">.</span><span class="n">dest</span>
</span><span id="__span-3-34"><a id="__codelineno-3-34" name="__codelineno-3-34" href="#__codelineno-3-34"></a>    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dest</span><span class="p">,</span> <span class="n">Path</span><span class="p">)</span>
</span><span id="__span-3-35"><a id="__codelineno-3-35" name="__codelineno-3-35" href="#__codelineno-3-35"></a>    <span class="c1"># to see it as soon as it happens in logs.</span>
</span><span id="__span-3-36"><a id="__codelineno-3-36" name="__codelineno-3-36" href="#__codelineno-3-36"></a>    <span class="c1"># `srun` can keep output in a buffer for quite a while otherwise.</span>
</span><span id="__span-3-37"><a id="__codelineno-3-37" name="__codelineno-3-37" href="#__codelineno-3-37"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Preparing ImageNet dataset in </span><span class="si">{</span><span class="n">dest</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="__span-3-38"><a id="__codelineno-3-38" name="__codelineno-3-38" href="#__codelineno-3-38"></a>    <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">prepare_imagenet</span><span class="p">(</span><span class="n">dest</span><span class="p">)</span>
</span><span id="__span-3-39"><a id="__codelineno-3-39" name="__codelineno-3-39" href="#__codelineno-3-39"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Done preparing ImageNet dataset in </span><span class="si">{</span><span class="n">dest</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-3-40"><a id="__codelineno-3-40" name="__codelineno-3-40" href="#__codelineno-3-40"></a>
</span><span id="__span-3-41"><a id="__codelineno-3-41" name="__codelineno-3-41" href="#__codelineno-3-41"></a>
</span><span id="__span-3-42"><a id="__codelineno-3-42" name="__codelineno-3-42" href="#__codelineno-3-42"></a><span class="k">def</span><span class="w"> </span><span class="nf">prepare_imagenet</span><span class="p">(</span><span class="n">output_directory</span><span class="p">:</span> <span class="n">Path</span><span class="p">,</span> <span class="n">network_imagenet_dir</span><span class="p">:</span> <span class="n">Path</span> <span class="o">=</span> <span class="n">NETWORK_IMAGENET_DIR</span><span class="p">):</span>
</span><span id="__span-3-43"><a id="__codelineno-3-43" name="__codelineno-3-43" href="#__codelineno-3-43"></a>    <span class="n">devkit_archive</span> <span class="o">=</span> <span class="n">network_imagenet_dir</span> <span class="o">/</span> <span class="s2">&quot;ILSVRC2012_devkit_t12.tar.gz&quot;</span>
</span><span id="__span-3-44"><a id="__codelineno-3-44" name="__codelineno-3-44" href="#__codelineno-3-44"></a>    <span class="n">train_archive</span> <span class="o">=</span> <span class="n">network_imagenet_dir</span> <span class="o">/</span> <span class="s2">&quot;ILSVRC2012_img_train.tar&quot;</span>
</span><span id="__span-3-45"><a id="__codelineno-3-45" name="__codelineno-3-45" href="#__codelineno-3-45"></a>    <span class="n">val_archive</span> <span class="o">=</span> <span class="n">network_imagenet_dir</span> <span class="o">/</span> <span class="s2">&quot;ILSVRC2012_img_val.tar&quot;</span>
</span><span id="__span-3-46"><a id="__codelineno-3-46" name="__codelineno-3-46" href="#__codelineno-3-46"></a>    <span class="n">checksums_file</span> <span class="o">=</span> <span class="n">network_imagenet_dir</span> <span class="o">/</span> <span class="s2">&quot;md5sums&quot;</span>
</span><span id="__span-3-47"><a id="__codelineno-3-47" name="__codelineno-3-47" href="#__codelineno-3-47"></a>    <span class="k">if</span> <span class="nb">any</span><span class="p">(</span>
</span><span id="__span-3-48"><a id="__codelineno-3-48" name="__codelineno-3-48" href="#__codelineno-3-48"></a>        <span class="ow">not</span> <span class="n">p</span><span class="o">.</span><span class="n">exists</span><span class="p">()</span>
</span><span id="__span-3-49"><a id="__codelineno-3-49" name="__codelineno-3-49" href="#__codelineno-3-49"></a>        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="p">(</span><span class="n">network_imagenet_dir</span><span class="p">,</span> <span class="n">devkit_archive</span><span class="p">,</span> <span class="n">train_archive</span><span class="p">,</span> <span class="n">val_archive</span><span class="p">,</span> <span class="n">checksums_file</span><span class="p">)</span>
</span><span id="__span-3-50"><a id="__codelineno-3-50" name="__codelineno-3-50" href="#__codelineno-3-50"></a>    <span class="p">):</span>
</span><span id="__span-3-51"><a id="__codelineno-3-51" name="__codelineno-3-51" href="#__codelineno-3-51"></a>        <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span>
</span><span id="__span-3-52"><a id="__codelineno-3-52" name="__codelineno-3-52" href="#__codelineno-3-52"></a>            <span class="sa">f</span><span class="s2">&quot;Could not find the ImageNet dataset archives at </span><span class="si">{</span><span class="n">network_imagenet_dir</span><span class="si">}</span><span class="s2">! &quot;</span>
</span><span id="__span-3-53"><a id="__codelineno-3-53" name="__codelineno-3-53" href="#__codelineno-3-53"></a>            <span class="s2">&quot;Adjust the location with the argument as needed. &quot;</span>
</span><span id="__span-3-54"><a id="__codelineno-3-54" name="__codelineno-3-54" href="#__codelineno-3-54"></a>        <span class="p">)</span>
</span><span id="__span-3-55"><a id="__codelineno-3-55" name="__codelineno-3-55" href="#__codelineno-3-55"></a>    <span class="n">output_directory</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="__span-3-56"><a id="__codelineno-3-56" name="__codelineno-3-56" href="#__codelineno-3-56"></a>
</span><span id="__span-3-57"><a id="__codelineno-3-57" name="__codelineno-3-57" href="#__codelineno-3-57"></a>    <span class="n">_make_symlink_in_dest</span><span class="p">(</span><span class="n">devkit_archive</span><span class="p">,</span> <span class="n">output_directory</span><span class="p">)</span>
</span><span id="__span-3-58"><a id="__codelineno-3-58" name="__codelineno-3-58" href="#__codelineno-3-58"></a>    <span class="n">_make_symlink_in_dest</span><span class="p">(</span><span class="n">train_archive</span><span class="p">,</span> <span class="n">output_directory</span><span class="p">)</span>
</span><span id="__span-3-59"><a id="__codelineno-3-59" name="__codelineno-3-59" href="#__codelineno-3-59"></a>    <span class="n">_make_symlink_in_dest</span><span class="p">(</span><span class="n">val_archive</span><span class="p">,</span> <span class="n">output_directory</span><span class="p">)</span>
</span><span id="__span-3-60"><a id="__codelineno-3-60" name="__codelineno-3-60" href="#__codelineno-3-60"></a>    <span class="n">_make_symlink_in_dest</span><span class="p">(</span><span class="n">checksums_file</span><span class="p">,</span> <span class="n">output_directory</span><span class="p">)</span>
</span><span id="__span-3-61"><a id="__codelineno-3-61" name="__codelineno-3-61" href="#__codelineno-3-61"></a>
</span><span id="__span-3-62"><a id="__codelineno-3-62" name="__codelineno-3-62" href="#__codelineno-3-62"></a>    <span class="n">train_dataset</span> <span class="o">=</span> <span class="n">_make_split</span><span class="p">(</span><span class="n">output_directory</span><span class="p">,</span> <span class="s2">&quot;train&quot;</span><span class="p">)</span>
</span><span id="__span-3-63"><a id="__codelineno-3-63" name="__codelineno-3-63" href="#__codelineno-3-63"></a>    <span class="n">test_dataset</span> <span class="o">=</span> <span class="n">_make_split</span><span class="p">(</span><span class="n">output_directory</span><span class="p">,</span> <span class="s2">&quot;val&quot;</span><span class="p">)</span>
</span><span id="__span-3-64"><a id="__codelineno-3-64" name="__codelineno-3-64" href="#__codelineno-3-64"></a>    <span class="k">return</span> <span class="n">train_dataset</span><span class="p">,</span> <span class="n">test_dataset</span>
</span><span id="__span-3-65"><a id="__codelineno-3-65" name="__codelineno-3-65" href="#__codelineno-3-65"></a>
</span><span id="__span-3-66"><a id="__codelineno-3-66" name="__codelineno-3-66" href="#__codelineno-3-66"></a>
</span><span id="__span-3-67"><a id="__codelineno-3-67" name="__codelineno-3-67" href="#__codelineno-3-67"></a><span class="k">def</span><span class="w"> </span><span class="nf">_make_symlink_in_dest</span><span class="p">(</span><span class="n">file</span><span class="p">:</span> <span class="n">Path</span><span class="p">,</span> <span class="n">dest_dir</span><span class="p">:</span> <span class="n">Path</span><span class="p">):</span>
</span><span id="__span-3-68"><a id="__codelineno-3-68" name="__codelineno-3-68" href="#__codelineno-3-68"></a>    <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">symlink_to_file</span> <span class="o">:=</span> <span class="p">(</span><span class="n">dest_dir</span> <span class="o">/</span> <span class="n">file</span><span class="o">.</span><span class="n">name</span><span class="p">))</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
</span><span id="__span-3-69"><a id="__codelineno-3-69" name="__codelineno-3-69" href="#__codelineno-3-69"></a>        <span class="n">symlink_to_file</span><span class="o">.</span><span class="n">symlink_to</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
</span><span id="__span-3-70"><a id="__codelineno-3-70" name="__codelineno-3-70" href="#__codelineno-3-70"></a>    <span class="k">return</span> <span class="n">symlink_to_file</span>
</span><span id="__span-3-71"><a id="__codelineno-3-71" name="__codelineno-3-71" href="#__codelineno-3-71"></a>
</span><span id="__span-3-72"><a id="__codelineno-3-72" name="__codelineno-3-72" href="#__codelineno-3-72"></a>
</span><span id="__span-3-73"><a id="__codelineno-3-73" name="__codelineno-3-73" href="#__codelineno-3-73"></a><span class="k">def</span><span class="w"> </span><span class="nf">_make_split</span><span class="p">(</span><span class="n">root</span><span class="p">:</span> <span class="n">Path</span><span class="p">,</span> <span class="n">split</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;train&quot;</span><span class="p">,</span> <span class="s2">&quot;val&quot;</span><span class="p">]):</span>
</span><span id="__span-3-74"><a id="__codelineno-3-74" name="__codelineno-3-74" href="#__codelineno-3-74"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Use the torchvision.datasets.ImageNet class constructor to prepare the data.</span>
</span><span id="__span-3-75"><a id="__codelineno-3-75" name="__codelineno-3-75" href="#__codelineno-3-75"></a>
</span><span id="__span-3-76"><a id="__codelineno-3-76" name="__codelineno-3-76" href="#__codelineno-3-76"></a><span class="sd">    There are faster ways of doing this with the `tarfile` package or fancy bash</span>
</span><span id="__span-3-77"><a id="__codelineno-3-77" name="__codelineno-3-77" href="#__codelineno-3-77"></a><span class="sd">    commands but this is simplest.</span>
</span><span id="__span-3-78"><a id="__codelineno-3-78" name="__codelineno-3-78" href="#__codelineno-3-78"></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="__span-3-79"><a id="__codelineno-3-79" name="__codelineno-3-79" href="#__codelineno-3-79"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Preparing ImageNet </span><span class="si">{</span><span class="n">split</span><span class="si">}</span><span class="s2"> split in </span><span class="si">{</span><span class="n">root</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="__span-3-80"><a id="__codelineno-3-80" name="__codelineno-3-80" href="#__codelineno-3-80"></a>    <span class="n">t</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
</span><span id="__span-3-81"><a id="__codelineno-3-81" name="__codelineno-3-81" href="#__codelineno-3-81"></a>    <span class="n">d</span> <span class="o">=</span> <span class="n">ImageNet</span><span class="p">(</span><span class="n">root</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">root</span><span class="p">),</span> <span class="n">split</span><span class="o">=</span><span class="n">split</span><span class="p">)</span>
</span><span id="__span-3-82"><a id="__codelineno-3-82" name="__codelineno-3-82" href="#__codelineno-3-82"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Preparing ImageNet </span><span class="si">{</span><span class="n">split</span><span class="si">}</span><span class="s2"> split took </span><span class="si">{</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">t</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-3-83"><a id="__codelineno-3-83" name="__codelineno-3-83" href="#__codelineno-3-83"></a>    <span class="k">return</span> <span class="n">d</span>
</span><span id="__span-3-84"><a id="__codelineno-3-84" name="__codelineno-3-84" href="#__codelineno-3-84"></a>
</span><span id="__span-3-85"><a id="__codelineno-3-85" name="__codelineno-3-85" href="#__codelineno-3-85"></a>
</span><span id="__span-3-86"><a id="__codelineno-3-86" name="__codelineno-3-86" href="#__codelineno-3-86"></a><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
</span><span id="__span-3-87"><a id="__codelineno-3-87" name="__codelineno-3-87" href="#__codelineno-3-87"></a>    <span class="n">main</span><span class="p">()</span>
</span></code></pre></div>
<p><strong>main.py</strong></p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-4-1"><a id="__codelineno-4-1" name="__codelineno-4-1" href="#__codelineno-4-1"></a><span class="sd">&quot;&quot;&quot;ImageNet Distributed training script.</span>
</span><span id="__span-4-2"><a id="__codelineno-4-2" name="__codelineno-4-2" href="#__codelineno-4-2"></a>
</span><span id="__span-4-3"><a id="__codelineno-4-3" name="__codelineno-4-3" href="#__codelineno-4-3"></a><span class="sd"># Features:</span>
</span><span id="__span-4-4"><a id="__codelineno-4-4" name="__codelineno-4-4" href="#__codelineno-4-4"></a><span class="sd">- Multi-GPU / Multi-node training with DDP</span>
</span><span id="__span-4-5"><a id="__codelineno-4-5" name="__codelineno-4-5" href="#__codelineno-4-5"></a><span class="sd">- Wandb logging</span>
</span><span id="__span-4-6"><a id="__codelineno-4-6" name="__codelineno-4-6" href="#__codelineno-4-6"></a><span class="sd">- Checkpointing</span>
</span><span id="__span-4-7"><a id="__codelineno-4-7" name="__codelineno-4-7" href="#__codelineno-4-7"></a><span class="sd">- Profiling with the PyTorch profiler and tensorboard</span>
</span><span id="__span-4-8"><a id="__codelineno-4-8" name="__codelineno-4-8" href="#__codelineno-4-8"></a><span class="sd">- Good sanity checks</span>
</span><span id="__span-4-9"><a id="__codelineno-4-9" name="__codelineno-4-9" href="#__codelineno-4-9"></a><span class="sd">- Automatic mixed precision (AMP) support</span>
</span><span id="__span-4-10"><a id="__codelineno-4-10" name="__codelineno-4-10" href="#__codelineno-4-10"></a>
</span><span id="__span-4-11"><a id="__codelineno-4-11" name="__codelineno-4-11" href="#__codelineno-4-11"></a><span class="sd"># Potential Improvements - to be added as an exercise! üòâ</span>
</span><span id="__span-4-12"><a id="__codelineno-4-12" name="__codelineno-4-12" href="#__codelineno-4-12"></a><span class="sd">- Use a larger model from HuggingFace or change the dataset from ImageNet to a language dataset from HuggingFace</span>
</span><span id="__span-4-13"><a id="__codelineno-4-13" name="__codelineno-4-13" href="#__codelineno-4-13"></a><span class="sd">- Use FSDP to train a larger model that doesn&#39;t fit inside a single GPU</span>
</span><span id="__span-4-14"><a id="__codelineno-4-14" name="__codelineno-4-14" href="#__codelineno-4-14"></a>
</span><span id="__span-4-15"><a id="__codelineno-4-15" name="__codelineno-4-15" href="#__codelineno-4-15"></a>
</span><span id="__span-4-16"><a id="__codelineno-4-16" name="__codelineno-4-16" href="#__codelineno-4-16"></a><span class="sd">Example:</span>
</span><span id="__span-4-17"><a id="__codelineno-4-17" name="__codelineno-4-17" href="#__codelineno-4-17"></a>
</span><span id="__span-4-18"><a id="__codelineno-4-18" name="__codelineno-4-18" href="#__codelineno-4-18"></a><span class="sd">srun --ntasks=2 --pty uv run python main.py --epochs=1 --limit_train_samples=50_000 \</span>
</span><span id="__span-4-19"><a id="__codelineno-4-19" name="__codelineno-4-19" href="#__codelineno-4-19"></a><span class="sd">    --limit_val_samples=2000 --batch_size=512 --use_amp --compile=default \</span>
</span><span id="__span-4-20"><a id="__codelineno-4-20" name="__codelineno-4-20" href="#__codelineno-4-20"></a><span class="sd">    --run_name=1024_amp_compile_default</span>
</span><span id="__span-4-21"><a id="__codelineno-4-21" name="__codelineno-4-21" href="#__codelineno-4-21"></a><span class="sd">&quot;&quot;&quot;</span>
</span><span id="__span-4-22"><a id="__codelineno-4-22" name="__codelineno-4-22" href="#__codelineno-4-22"></a>
</span><span id="__span-4-23"><a id="__codelineno-4-23" name="__codelineno-4-23" href="#__codelineno-4-23"></a><span class="kn">import</span><span class="w"> </span><span class="nn">contextlib</span>
</span><span id="__span-4-24"><a id="__codelineno-4-24" name="__codelineno-4-24" href="#__codelineno-4-24"></a><span class="kn">import</span><span class="w"> </span><span class="nn">dataclasses</span>
</span><span id="__span-4-25"><a id="__codelineno-4-25" name="__codelineno-4-25" href="#__codelineno-4-25"></a><span class="kn">import</span><span class="w"> </span><span class="nn">datetime</span>
</span><span id="__span-4-26"><a id="__codelineno-4-26" name="__codelineno-4-26" href="#__codelineno-4-26"></a><span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>
</span><span id="__span-4-27"><a id="__codelineno-4-27" name="__codelineno-4-27" href="#__codelineno-4-27"></a><span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
</span><span id="__span-4-28"><a id="__codelineno-4-28" name="__codelineno-4-28" href="#__codelineno-4-28"></a><span class="kn">import</span><span class="w"> </span><span class="nn">random</span>
</span><span id="__span-4-29"><a id="__codelineno-4-29" name="__codelineno-4-29" href="#__codelineno-4-29"></a><span class="kn">import</span><span class="w"> </span><span class="nn">subprocess</span>
</span><span id="__span-4-30"><a id="__codelineno-4-30" name="__codelineno-4-30" href="#__codelineno-4-30"></a><span class="kn">import</span><span class="w"> </span><span class="nn">sys</span>
</span><span id="__span-4-31"><a id="__codelineno-4-31" name="__codelineno-4-31" href="#__codelineno-4-31"></a><span class="kn">import</span><span class="w"> </span><span class="nn">time</span>
</span><span id="__span-4-32"><a id="__codelineno-4-32" name="__codelineno-4-32" href="#__codelineno-4-32"></a><span class="kn">from</span><span class="w"> </span><span class="nn">dataclasses</span><span class="w"> </span><span class="kn">import</span> <span class="n">dataclass</span>
</span><span id="__span-4-33"><a id="__codelineno-4-33" name="__codelineno-4-33" href="#__codelineno-4-33"></a><span class="kn">from</span><span class="w"> </span><span class="nn">pathlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">Path</span>
</span><span id="__span-4-34"><a id="__codelineno-4-34" name="__codelineno-4-34" href="#__codelineno-4-34"></a><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Callable</span><span class="p">,</span> <span class="n">Iterable</span><span class="p">,</span> <span class="n">TypeVar</span>
</span><span id="__span-4-35"><a id="__codelineno-4-35" name="__codelineno-4-35" href="#__codelineno-4-35"></a>
</span><span id="__span-4-36"><a id="__codelineno-4-36" name="__codelineno-4-36" href="#__codelineno-4-36"></a><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
</span><span id="__span-4-37"><a id="__codelineno-4-37" name="__codelineno-4-37" href="#__codelineno-4-37"></a><span class="kn">import</span><span class="w"> </span><span class="nn">rich.logging</span>
</span><span id="__span-4-38"><a id="__codelineno-4-38" name="__codelineno-4-38" href="#__codelineno-4-38"></a><span class="kn">import</span><span class="w"> </span><span class="nn">rich.pretty</span>
</span><span id="__span-4-39"><a id="__codelineno-4-39" name="__codelineno-4-39" href="#__codelineno-4-39"></a><span class="kn">import</span><span class="w"> </span><span class="nn">simple_parsing</span>
</span><span id="__span-4-40"><a id="__codelineno-4-40" name="__codelineno-4-40" href="#__codelineno-4-40"></a><span class="kn">import</span><span class="w"> </span><span class="nn">sklearn</span>
</span><span id="__span-4-41"><a id="__codelineno-4-41" name="__codelineno-4-41" href="#__codelineno-4-41"></a><span class="kn">import</span><span class="w"> </span><span class="nn">sklearn.model_selection</span>
</span><span id="__span-4-42"><a id="__codelineno-4-42" name="__codelineno-4-42" href="#__codelineno-4-42"></a><span class="kn">import</span><span class="w"> </span><span class="nn">torch</span>
</span><span id="__span-4-43"><a id="__codelineno-4-43" name="__codelineno-4-43" href="#__codelineno-4-43"></a><span class="kn">import</span><span class="w"> </span><span class="nn">torchvision</span>
</span><span id="__span-4-44"><a id="__codelineno-4-44" name="__codelineno-4-44" href="#__codelineno-4-44"></a><span class="kn">import</span><span class="w"> </span><span class="nn">tqdm</span>
</span><span id="__span-4-45"><a id="__codelineno-4-45" name="__codelineno-4-45" href="#__codelineno-4-45"></a><span class="kn">import</span><span class="w"> </span><span class="nn">tqdm.rich</span>
</span><span id="__span-4-46"><a id="__codelineno-4-46" name="__codelineno-4-46" href="#__codelineno-4-46"></a><span class="kn">import</span><span class="w"> </span><span class="nn">wandb</span>
</span><span id="__span-4-47"><a id="__codelineno-4-47" name="__codelineno-4-47" href="#__codelineno-4-47"></a><span class="kn">from</span><span class="w"> </span><span class="nn">torch</span><span class="w"> </span><span class="kn">import</span> <span class="n">Tensor</span><span class="p">,</span> <span class="n">nn</span>
</span><span id="__span-4-48"><a id="__codelineno-4-48" name="__codelineno-4-48" href="#__codelineno-4-48"></a><span class="kn">from</span><span class="w"> </span><span class="nn">torch.distributed</span><span class="w"> </span><span class="kn">import</span> <span class="n">ReduceOp</span>
</span><span id="__span-4-49"><a id="__codelineno-4-49" name="__codelineno-4-49" href="#__codelineno-4-49"></a><span class="kn">from</span><span class="w"> </span><span class="nn">torch.nn</span><span class="w"> </span><span class="kn">import</span> <span class="n">functional</span> <span class="k">as</span> <span class="n">F</span>
</span><span id="__span-4-50"><a id="__codelineno-4-50" name="__codelineno-4-50" href="#__codelineno-4-50"></a><span class="kn">from</span><span class="w"> </span><span class="nn">torch.profiler</span><span class="w"> </span><span class="kn">import</span> <span class="n">profile</span><span class="p">,</span> <span class="n">tensorboard_trace_handler</span>
</span><span id="__span-4-51"><a id="__codelineno-4-51" name="__codelineno-4-51" href="#__codelineno-4-51"></a><span class="kn">from</span><span class="w"> </span><span class="nn">torch.utils.data</span><span class="w"> </span><span class="kn">import</span> <span class="n">DataLoader</span>
</span><span id="__span-4-52"><a id="__codelineno-4-52" name="__codelineno-4-52" href="#__codelineno-4-52"></a><span class="kn">from</span><span class="w"> </span><span class="nn">torch.utils.data.distributed</span><span class="w"> </span><span class="kn">import</span> <span class="n">DistributedSampler</span>
</span><span id="__span-4-53"><a id="__codelineno-4-53" name="__codelineno-4-53" href="#__codelineno-4-53"></a><span class="kn">from</span><span class="w"> </span><span class="nn">torchvision.datasets</span><span class="w"> </span><span class="kn">import</span> <span class="n">ImageNet</span>
</span><span id="__span-4-54"><a id="__codelineno-4-54" name="__codelineno-4-54" href="#__codelineno-4-54"></a><span class="kn">from</span><span class="w"> </span><span class="nn">torchvision.transforms</span><span class="w"> </span><span class="kn">import</span> <span class="n">v2</span> <span class="k">as</span> <span class="n">transforms</span>
</span><span id="__span-4-55"><a id="__codelineno-4-55" name="__codelineno-4-55" href="#__codelineno-4-55"></a>
</span><span id="__span-4-56"><a id="__codelineno-4-56" name="__codelineno-4-56" href="#__codelineno-4-56"></a><span class="n">JOB_ID</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;SLURM_JOB_ID&quot;</span><span class="p">]</span>  <span class="c1"># you absolutely need to be within a slurm job!</span>
</span><span id="__span-4-57"><a id="__codelineno-4-57" name="__codelineno-4-57" href="#__codelineno-4-57"></a><span class="n">SCRATCH</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;SCRATCH&quot;</span><span class="p">])</span>
</span><span id="__span-4-58"><a id="__codelineno-4-58" name="__codelineno-4-58" href="#__codelineno-4-58"></a><span class="n">SLURM_TMPDIR</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;SLURM_TMPDIR&quot;</span><span class="p">,</span> <span class="s2">&quot;/tmp&quot;</span><span class="p">))</span>
</span><span id="__span-4-59"><a id="__codelineno-4-59" name="__codelineno-4-59" href="#__codelineno-4-59"></a><span class="k">assert</span> <span class="n">SLURM_TMPDIR</span><span class="o">.</span><span class="n">exists</span><span class="p">(),</span> <span class="sa">f</span><span class="s2">&quot;SLURM_TMPDIR (assumed </span><span class="si">{</span><span class="n">SLURM_TMPDIR</span><span class="si">}</span><span class="s2">) should exist!&quot;</span>
</span><span id="__span-4-60"><a id="__codelineno-4-60" name="__codelineno-4-60" href="#__codelineno-4-60"></a>
</span><span id="__span-4-61"><a id="__codelineno-4-61" name="__codelineno-4-61" href="#__codelineno-4-61"></a><span class="c1"># Set any missing environment variables so that `torch.distributed.init_process_group`</span>
</span><span id="__span-4-62"><a id="__codelineno-4-62" name="__codelineno-4-62" href="#__codelineno-4-62"></a><span class="c1"># works properly, namely RANK, WORLD_SIZE, MASTER_ADDR, MASTER_PORT, (LOCAL_RANK).</span>
</span><span id="__span-4-63"><a id="__codelineno-4-63" name="__codelineno-4-63" href="#__codelineno-4-63"></a><span class="c1">#</span>
</span><span id="__span-4-64"><a id="__codelineno-4-64" name="__codelineno-4-64" href="#__codelineno-4-64"></a><span class="c1"># The accompanying sbatch script already does this in bash, which is preferable, since</span>
</span><span id="__span-4-65"><a id="__codelineno-4-65" name="__codelineno-4-65" href="#__codelineno-4-65"></a><span class="c1"># you need to make sure that these environment variables are set before any torch operations</span>
</span><span id="__span-4-66"><a id="__codelineno-4-66" name="__codelineno-4-66" href="#__codelineno-4-66"></a><span class="c1"># are executed. (Some modules might inadvertently initialize cuda when imported which is a problem).</span>
</span><span id="__span-4-67"><a id="__codelineno-4-67" name="__codelineno-4-67" href="#__codelineno-4-67"></a><span class="c1">#</span>
</span><span id="__span-4-68"><a id="__codelineno-4-68" name="__codelineno-4-68" href="#__codelineno-4-68"></a><span class="c1"># Also doing this here just in case you&#39;re using a different sbatch script or running this from</span>
</span><span id="__span-4-69"><a id="__codelineno-4-69" name="__codelineno-4-69" href="#__codelineno-4-69"></a><span class="c1"># the vscode terminal or with the vscode debugger.</span>
</span><span id="__span-4-70"><a id="__codelineno-4-70" name="__codelineno-4-70" href="#__codelineno-4-70"></a><span class="c1"># Using the Vscode debugger to debug multi-gpu jobs is very convenient.</span>
</span><span id="__span-4-71"><a id="__codelineno-4-71" name="__codelineno-4-71" href="#__codelineno-4-71"></a><span class="c1">#</span>
</span><span id="__span-4-72"><a id="__codelineno-4-72" name="__codelineno-4-72" href="#__codelineno-4-72"></a><span class="c1"># Note: here by using .setdefault we don&#39;t overwrite env variables that are already set,</span>
</span><span id="__span-4-73"><a id="__codelineno-4-73" name="__codelineno-4-73" href="#__codelineno-4-73"></a><span class="c1"># so you could in principle use this in a workflow based on srun + torchrun or</span>
</span><span id="__span-4-74"><a id="__codelineno-4-74" name="__codelineno-4-74" href="#__codelineno-4-74"></a><span class="c1"># srun + &#39;accelerate launch&#39;.</span>
</span><span id="__span-4-75"><a id="__codelineno-4-75" name="__codelineno-4-75" href="#__codelineno-4-75"></a>
</span><span id="__span-4-76"><a id="__codelineno-4-76" name="__codelineno-4-76" href="#__codelineno-4-76"></a><span class="k">if</span> <span class="s2">&quot;SLURM_PROCID&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span> <span class="ow">and</span> <span class="s2">&quot;RANK&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">:</span>
</span><span id="__span-4-77"><a id="__codelineno-4-77" name="__codelineno-4-77" href="#__codelineno-4-77"></a>    <span class="c1"># If neither the SLURM nor the torch distributed env vars are set, raise an error.</span>
</span><span id="__span-4-78"><a id="__codelineno-4-78" name="__codelineno-4-78" href="#__codelineno-4-78"></a>    <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
</span><span id="__span-4-79"><a id="__codelineno-4-79" name="__codelineno-4-79" href="#__codelineno-4-79"></a>        <span class="s2">&quot;Both the SLURM and the torch distributed env vars are not set! &quot;</span>
</span><span id="__span-4-80"><a id="__codelineno-4-80" name="__codelineno-4-80" href="#__codelineno-4-80"></a>        <span class="s2">&quot;This indicates that you might be running this script in something like the &quot;</span>
</span><span id="__span-4-81"><a id="__codelineno-4-81" name="__codelineno-4-81" href="#__codelineno-4-81"></a>        <span class="s2">&quot;vscode terminal with `python main.py&gt;`.</span><span class="se">\n</span><span class="s2">&quot;</span>
</span><span id="__span-4-82"><a id="__codelineno-4-82" name="__codelineno-4-82" href="#__codelineno-4-82"></a>        <span class="sa">f</span><span class="s2">&quot;Consider relaunching the same command with srun instead, like so: </span><span class="se">\n</span><span class="s2">&quot;</span>
</span><span id="__span-4-83"><a id="__codelineno-4-83" name="__codelineno-4-83" href="#__codelineno-4-83"></a>        <span class="sa">f</span><span class="s2">&quot;‚û°Ô∏è    srun --pty python main.py </span><span class="si">{</span><span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">)</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
</span><span id="__span-4-84"><a id="__codelineno-4-84" name="__codelineno-4-84" href="#__codelineno-4-84"></a>        <span class="s2">&quot;See https://slurm.schedmd.com/srun.html for more info.&quot;</span>
</span><span id="__span-4-85"><a id="__codelineno-4-85" name="__codelineno-4-85" href="#__codelineno-4-85"></a>    <span class="p">)</span>
</span><span id="__span-4-86"><a id="__codelineno-4-86" name="__codelineno-4-86" href="#__codelineno-4-86"></a>
</span><span id="__span-4-87"><a id="__codelineno-4-87" name="__codelineno-4-87" href="#__codelineno-4-87"></a><span class="c1"># This will raise an error if both are unset. This is expected (see above).</span>
</span><span id="__span-4-88"><a id="__codelineno-4-88" name="__codelineno-4-88" href="#__codelineno-4-88"></a><span class="n">RANK</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;RANK&quot;</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;SLURM_PROCID&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)))</span>
</span><span id="__span-4-89"><a id="__codelineno-4-89" name="__codelineno-4-89" href="#__codelineno-4-89"></a><span class="n">LOCAL_RANK</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;LOCAL_RANK&quot;</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;SLURM_LOCALID&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)))</span>
</span><span id="__span-4-90"><a id="__codelineno-4-90" name="__codelineno-4-90" href="#__codelineno-4-90"></a><span class="n">WORLD_SIZE</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;WORLD_SIZE&quot;</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;SLURM_NTASKS&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)))</span>
</span><span id="__span-4-91"><a id="__codelineno-4-91" name="__codelineno-4-91" href="#__codelineno-4-91"></a><span class="n">MASTER_PORT</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;MASTER_PORT&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="mi">10000</span> <span class="o">+</span> <span class="nb">int</span><span class="p">(</span><span class="n">JOB_ID</span><span class="p">)</span> <span class="o">%</span> <span class="mi">10000</span><span class="p">)))</span>
</span><span id="__span-4-92"><a id="__codelineno-4-92" name="__codelineno-4-92" href="#__codelineno-4-92"></a><span class="k">if</span> <span class="s2">&quot;SLURM_JOB_NODELIST&quot;</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">:</span>
</span><span id="__span-4-93"><a id="__codelineno-4-93" name="__codelineno-4-93" href="#__codelineno-4-93"></a>    <span class="c1"># Get the hostname of the first node, for example: &quot;cn-l[084-085]&quot; --&gt; cn-l084</span>
</span><span id="__span-4-94"><a id="__codelineno-4-94" name="__codelineno-4-94" href="#__codelineno-4-94"></a>    <span class="n">_first_node</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">check_output</span><span class="p">(</span>
</span><span id="__span-4-95"><a id="__codelineno-4-95" name="__codelineno-4-95" href="#__codelineno-4-95"></a>        <span class="sa">f</span><span class="s2">&quot;scontrol show hostnames </span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;SLURM_JOB_NODELIST&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="kc">True</span>
</span><span id="__span-4-96"><a id="__codelineno-4-96" name="__codelineno-4-96" href="#__codelineno-4-96"></a>    <span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="__span-4-97"><a id="__codelineno-4-97" name="__codelineno-4-97" href="#__codelineno-4-97"></a>    <span class="n">MASTER_ADDR</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;MASTER_ADDR&quot;</span><span class="p">,</span> <span class="n">_first_node</span><span class="p">)</span>
</span><span id="__span-4-98"><a id="__codelineno-4-98" name="__codelineno-4-98" href="#__codelineno-4-98"></a><span class="k">else</span><span class="p">:</span>
</span><span id="__span-4-99"><a id="__codelineno-4-99" name="__codelineno-4-99" href="#__codelineno-4-99"></a>    <span class="n">MASTER_ADDR</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;MASTER_ADDR&quot;</span><span class="p">,</span> <span class="s2">&quot;127.0.0.1&quot;</span><span class="p">)</span>
</span><span id="__span-4-100"><a id="__codelineno-4-100" name="__codelineno-4-100" href="#__codelineno-4-100"></a>
</span><span id="__span-4-101"><a id="__codelineno-4-101" name="__codelineno-4-101" href="#__codelineno-4-101"></a><span class="c1"># Setup logging</span>
</span><span id="__span-4-102"><a id="__codelineno-4-102" name="__codelineno-4-102" href="#__codelineno-4-102"></a><span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">(</span>
</span><span id="__span-4-103"><a id="__codelineno-4-103" name="__codelineno-4-103" href="#__codelineno-4-103"></a>    <span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">,</span>
</span><span id="__span-4-104"><a id="__codelineno-4-104" name="__codelineno-4-104" href="#__codelineno-4-104"></a>    <span class="nb">format</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="n">RANK</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">WORLD_SIZE</span><span class="si">}</span><span class="s2">] - %(message)s &quot;</span><span class="p">,</span>
</span><span id="__span-4-105"><a id="__codelineno-4-105" name="__codelineno-4-105" href="#__codelineno-4-105"></a>    <span class="n">handlers</span><span class="o">=</span><span class="p">[</span><span class="n">rich</span><span class="o">.</span><span class="n">logging</span><span class="o">.</span><span class="n">RichHandler</span><span class="p">(</span><span class="n">markup</span><span class="o">=</span><span class="kc">True</span><span class="p">)],</span>
</span><span id="__span-4-106"><a id="__codelineno-4-106" name="__codelineno-4-106" href="#__codelineno-4-106"></a>    <span class="n">force</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="__span-4-107"><a id="__codelineno-4-107" name="__codelineno-4-107" href="#__codelineno-4-107"></a><span class="p">)</span>
</span><span id="__span-4-108"><a id="__codelineno-4-108" name="__codelineno-4-108" href="#__codelineno-4-108"></a><span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
</span><span id="__span-4-109"><a id="__codelineno-4-109" name="__codelineno-4-109" href="#__codelineno-4-109"></a>
</span><span id="__span-4-110"><a id="__codelineno-4-110" name="__codelineno-4-110" href="#__codelineno-4-110"></a>
</span><span id="__span-4-111"><a id="__codelineno-4-111" name="__codelineno-4-111" href="#__codelineno-4-111"></a><span class="k">class</span><span class="w"> </span><span class="nc">DummyModel</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
</span><span id="__span-4-112"><a id="__codelineno-4-112" name="__codelineno-4-112" href="#__codelineno-4-112"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Dummy model used while debugging - uses almost no compute or memory.</span>
</span><span id="__span-4-113"><a id="__codelineno-4-113" name="__codelineno-4-113" href="#__codelineno-4-113"></a>
</span><span id="__span-4-114"><a id="__codelineno-4-114" name="__codelineno-4-114" href="#__codelineno-4-114"></a><span class="sd">    Examples of when this is useful:</span>
</span><span id="__span-4-115"><a id="__codelineno-4-115" name="__codelineno-4-115" href="#__codelineno-4-115"></a><span class="sd">    -   to check if data loading is the bottleneck, we can pull samples from the dataloader</span>
</span><span id="__span-4-116"><a id="__codelineno-4-116" name="__codelineno-4-116" href="#__codelineno-4-116"></a><span class="sd">        as fast as possible and compare that throughput (in samples/second) to the same</span>
</span><span id="__span-4-117"><a id="__codelineno-4-117" name="__codelineno-4-117" href="#__codelineno-4-117"></a><span class="sd">        during training. If the two are similar, then the dataloader is the bottleneck.</span>
</span><span id="__span-4-118"><a id="__codelineno-4-118" name="__codelineno-4-118" href="#__codelineno-4-118"></a><span class="sd">        Using a dummy model like this makes it so we don&#39;t have to modify our training loop</span>
</span><span id="__span-4-119"><a id="__codelineno-4-119" name="__codelineno-4-119" href="#__codelineno-4-119"></a><span class="sd">        to do this kind of sanity check.</span>
</span><span id="__span-4-120"><a id="__codelineno-4-120" name="__codelineno-4-120" href="#__codelineno-4-120"></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="__span-4-121"><a id="__codelineno-4-121" name="__codelineno-4-121" href="#__codelineno-4-121"></a>
</span><span id="__span-4-122"><a id="__codelineno-4-122" name="__codelineno-4-122" href="#__codelineno-4-122"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">num_classes</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="o">**</span><span class="n">_kwargs</span><span class="p">):</span>
</span><span id="__span-4-123"><a id="__codelineno-4-123" name="__codelineno-4-123" href="#__codelineno-4-123"></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
</span><span id="__span-4-124"><a id="__codelineno-4-124" name="__codelineno-4-124" href="#__codelineno-4-124"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">num_classes</span> <span class="o">=</span> <span class="n">num_classes</span>
</span><span id="__span-4-125"><a id="__codelineno-4-125" name="__codelineno-4-125" href="#__codelineno-4-125"></a>        <span class="c1"># A dummy weight..</span>
</span><span id="__span-4-126"><a id="__codelineno-4-126" name="__codelineno-4-126" href="#__codelineno-4-126"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">linear</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">num_classes</span><span class="p">)</span>
</span><span id="__span-4-127"><a id="__codelineno-4-127" name="__codelineno-4-127" href="#__codelineno-4-127"></a>
</span><span id="__span-4-128"><a id="__codelineno-4-128" name="__codelineno-4-128" href="#__codelineno-4-128"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="n">Tensor</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tensor</span><span class="p">:</span>
</span><span id="__span-4-129"><a id="__codelineno-4-129" name="__codelineno-4-129" href="#__codelineno-4-129"></a>        <span class="n">mean_of_each_xi</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">keepdim</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>  <span class="c1"># [batch_size, 1]</span>
</span><span id="__span-4-130"><a id="__codelineno-4-130" name="__codelineno-4-130" href="#__codelineno-4-130"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">linear</span><span class="p">(</span><span class="n">mean_of_each_xi</span><span class="p">)</span>  <span class="c1"># [batch_size, num_classes]</span>
</span><span id="__span-4-131"><a id="__codelineno-4-131" name="__codelineno-4-131" href="#__codelineno-4-131"></a>
</span><span id="__span-4-132"><a id="__codelineno-4-132" name="__codelineno-4-132" href="#__codelineno-4-132"></a>
</span><span id="__span-4-133"><a id="__codelineno-4-133" name="__codelineno-4-133" href="#__codelineno-4-133"></a><span class="n">models</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Callable</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="__span-4-134"><a id="__codelineno-4-134" name="__codelineno-4-134" href="#__codelineno-4-134"></a>    <span class="s2">&quot;dummy&quot;</span><span class="p">:</span> <span class="n">DummyModel</span><span class="p">,</span>
</span><span id="__span-4-135"><a id="__codelineno-4-135" name="__codelineno-4-135" href="#__codelineno-4-135"></a>    <span class="s2">&quot;resnet18&quot;</span><span class="p">:</span> <span class="n">torchvision</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">resnet18</span><span class="p">,</span>
</span><span id="__span-4-136"><a id="__codelineno-4-136" name="__codelineno-4-136" href="#__codelineno-4-136"></a>    <span class="s2">&quot;resnet34&quot;</span><span class="p">:</span> <span class="n">torchvision</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">resnet34</span><span class="p">,</span>
</span><span id="__span-4-137"><a id="__codelineno-4-137" name="__codelineno-4-137" href="#__codelineno-4-137"></a>    <span class="s2">&quot;resnet50&quot;</span><span class="p">:</span> <span class="n">torchvision</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">resnet50</span><span class="p">,</span>
</span><span id="__span-4-138"><a id="__codelineno-4-138" name="__codelineno-4-138" href="#__codelineno-4-138"></a>    <span class="s2">&quot;resnet101&quot;</span><span class="p">:</span> <span class="n">torchvision</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">resnet101</span><span class="p">,</span>
</span><span id="__span-4-139"><a id="__codelineno-4-139" name="__codelineno-4-139" href="#__codelineno-4-139"></a>    <span class="s2">&quot;resnet152&quot;</span><span class="p">:</span> <span class="n">torchvision</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">resnet152</span><span class="p">,</span>
</span><span id="__span-4-140"><a id="__codelineno-4-140" name="__codelineno-4-140" href="#__codelineno-4-140"></a>    <span class="s2">&quot;vit_b_16&quot;</span><span class="p">:</span> <span class="n">torchvision</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">vit_b_16</span><span class="p">,</span>
</span><span id="__span-4-141"><a id="__codelineno-4-141" name="__codelineno-4-141" href="#__codelineno-4-141"></a>    <span class="s2">&quot;vit_b_32&quot;</span><span class="p">:</span> <span class="n">torchvision</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">vit_b_32</span><span class="p">,</span>  <span class="c1"># default model</span>
</span><span id="__span-4-142"><a id="__codelineno-4-142" name="__codelineno-4-142" href="#__codelineno-4-142"></a>    <span class="s2">&quot;vit_l_16&quot;</span><span class="p">:</span> <span class="n">torchvision</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">vit_l_16</span><span class="p">,</span>
</span><span id="__span-4-143"><a id="__codelineno-4-143" name="__codelineno-4-143" href="#__codelineno-4-143"></a>    <span class="s2">&quot;vit_l_32&quot;</span><span class="p">:</span> <span class="n">torchvision</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">vit_l_32</span><span class="p">,</span>
</span><span id="__span-4-144"><a id="__codelineno-4-144" name="__codelineno-4-144" href="#__codelineno-4-144"></a><span class="p">}</span>
</span><span id="__span-4-145"><a id="__codelineno-4-145" name="__codelineno-4-145" href="#__codelineno-4-145"></a>
</span><span id="__span-4-146"><a id="__codelineno-4-146" name="__codelineno-4-146" href="#__codelineno-4-146"></a>
</span><span id="__span-4-147"><a id="__codelineno-4-147" name="__codelineno-4-147" href="#__codelineno-4-147"></a><span class="nd">@dataclass</span>
</span><span id="__span-4-148"><a id="__codelineno-4-148" name="__codelineno-4-148" href="#__codelineno-4-148"></a><span class="k">class</span><span class="w"> </span><span class="nc">Args</span><span class="p">:</span>
</span><span id="__span-4-149"><a id="__codelineno-4-149" name="__codelineno-4-149" href="#__codelineno-4-149"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Dataclass that contains the command-line arguments for this script.&quot;&quot;&quot;</span>
</span><span id="__span-4-150"><a id="__codelineno-4-150" name="__codelineno-4-150" href="#__codelineno-4-150"></a>
</span><span id="__span-4-151"><a id="__codelineno-4-151" name="__codelineno-4-151" href="#__codelineno-4-151"></a>    <span class="n">epochs</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span>
</span><span id="__span-4-152"><a id="__codelineno-4-152" name="__codelineno-4-152" href="#__codelineno-4-152"></a>    <span class="n">learning_rate</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">3e-4</span>
</span><span id="__span-4-153"><a id="__codelineno-4-153" name="__codelineno-4-153" href="#__codelineno-4-153"></a>    <span class="n">weight_decay</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1e-4</span>
</span><span id="__span-4-154"><a id="__codelineno-4-154" name="__codelineno-4-154" href="#__codelineno-4-154"></a>    <span class="n">batch_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">512</span>
</span><span id="__span-4-155"><a id="__codelineno-4-155" name="__codelineno-4-155" href="#__codelineno-4-155"></a>
</span><span id="__span-4-156"><a id="__codelineno-4-156" name="__codelineno-4-156" href="#__codelineno-4-156"></a>    <span class="n">pretrained</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="__span-4-157"><a id="__codelineno-4-157" name="__codelineno-4-157" href="#__codelineno-4-157"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Whether to use a pretrained model or start from a random initialization.&quot;&quot;&quot;</span>
</span><span id="__span-4-158"><a id="__codelineno-4-158" name="__codelineno-4-158" href="#__codelineno-4-158"></a>
</span><span id="__span-4-159"><a id="__codelineno-4-159" name="__codelineno-4-159" href="#__codelineno-4-159"></a>    <span class="n">checkpoint_dir</span><span class="p">:</span> <span class="n">Path</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="__span-4-160"><a id="__codelineno-4-160" name="__codelineno-4-160" href="#__codelineno-4-160"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Where checkpoints are stored.&quot;&quot;&quot;</span>
</span><span id="__span-4-161"><a id="__codelineno-4-161" name="__codelineno-4-161" href="#__codelineno-4-161"></a>
</span><span id="__span-4-162"><a id="__codelineno-4-162" name="__codelineno-4-162" href="#__codelineno-4-162"></a>    <span class="n">checkpoint_interval_epochs</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span>
</span><span id="__span-4-163"><a id="__codelineno-4-163" name="__codelineno-4-163" href="#__codelineno-4-163"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Interval (in epochs) between saving checkpoints.&quot;&quot;&quot;</span>
</span><span id="__span-4-164"><a id="__codelineno-4-164" name="__codelineno-4-164" href="#__codelineno-4-164"></a>
</span><span id="__span-4-165"><a id="__codelineno-4-165" name="__codelineno-4-165" href="#__codelineno-4-165"></a>    <span class="n">dataset_path</span><span class="p">:</span> <span class="n">Path</span> <span class="o">=</span> <span class="n">SLURM_TMPDIR</span> <span class="o">/</span> <span class="s2">&quot;data&quot;</span>
</span><span id="__span-4-166"><a id="__codelineno-4-166" name="__codelineno-4-166" href="#__codelineno-4-166"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Where to look for the dataset.&quot;&quot;&quot;</span>
</span><span id="__span-4-167"><a id="__codelineno-4-167" name="__codelineno-4-167" href="#__codelineno-4-167"></a>
</span><span id="__span-4-168"><a id="__codelineno-4-168" name="__codelineno-4-168" href="#__codelineno-4-168"></a>    <span class="n">use_fake_data</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="__span-4-169"><a id="__codelineno-4-169" name="__codelineno-4-169" href="#__codelineno-4-169"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;If true, use torchvision.datasets.FakeData instead of ImageNet.</span>
</span><span id="__span-4-170"><a id="__codelineno-4-170" name="__codelineno-4-170" href="#__codelineno-4-170"></a>
</span><span id="__span-4-171"><a id="__codelineno-4-171" name="__codelineno-4-171" href="#__codelineno-4-171"></a><span class="sd">    Useful for debugging.</span>
</span><span id="__span-4-172"><a id="__codelineno-4-172" name="__codelineno-4-172" href="#__codelineno-4-172"></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="__span-4-173"><a id="__codelineno-4-173" name="__codelineno-4-173" href="#__codelineno-4-173"></a>
</span><span id="__span-4-174"><a id="__codelineno-4-174" name="__codelineno-4-174" href="#__codelineno-4-174"></a>    <span class="n">limit_train_samples</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="__span-4-175"><a id="__codelineno-4-175" name="__codelineno-4-175" href="#__codelineno-4-175"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot; If &gt; 0, limit the number of training samples to this value.</span>
</span><span id="__span-4-176"><a id="__codelineno-4-176" name="__codelineno-4-176" href="#__codelineno-4-176"></a>
</span><span id="__span-4-177"><a id="__codelineno-4-177" name="__codelineno-4-177" href="#__codelineno-4-177"></a><span class="sd">    This can be very useful to debug the training loop, checkpointing, and validation, or to check that</span>
</span><span id="__span-4-178"><a id="__codelineno-4-178" name="__codelineno-4-178" href="#__codelineno-4-178"></a><span class="sd">    the model can overfit on a small number of samples.</span>
</span><span id="__span-4-179"><a id="__codelineno-4-179" name="__codelineno-4-179" href="#__codelineno-4-179"></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="__span-4-180"><a id="__codelineno-4-180" name="__codelineno-4-180" href="#__codelineno-4-180"></a>
</span><span id="__span-4-181"><a id="__codelineno-4-181" name="__codelineno-4-181" href="#__codelineno-4-181"></a>    <span class="n">limit_val_samples</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="__span-4-182"><a id="__codelineno-4-182" name="__codelineno-4-182" href="#__codelineno-4-182"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot; If &gt; 0, limit the number of validation samples to this value.&quot;&quot;&quot;</span>
</span><span id="__span-4-183"><a id="__codelineno-4-183" name="__codelineno-4-183" href="#__codelineno-4-183"></a>
</span><span id="__span-4-184"><a id="__codelineno-4-184" name="__codelineno-4-184" href="#__codelineno-4-184"></a>    <span class="n">num_workers</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;SLURM_CPUS_PER_TASK&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">sched_getaffinity</span><span class="p">(</span><span class="mi">0</span><span class="p">))))</span>
</span><span id="__span-4-185"><a id="__codelineno-4-185" name="__codelineno-4-185" href="#__codelineno-4-185"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Number of dataloader workers.&quot;&quot;&quot;</span>
</span><span id="__span-4-186"><a id="__codelineno-4-186" name="__codelineno-4-186" href="#__codelineno-4-186"></a>
</span><span id="__span-4-187"><a id="__codelineno-4-187" name="__codelineno-4-187" href="#__codelineno-4-187"></a>    <span class="n">seed</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">42</span>
</span><span id="__span-4-188"><a id="__codelineno-4-188" name="__codelineno-4-188" href="#__codelineno-4-188"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Base random seed for everything except the train/validation split.&quot;&quot;&quot;</span>
</span><span id="__span-4-189"><a id="__codelineno-4-189" name="__codelineno-4-189" href="#__codelineno-4-189"></a>
</span><span id="__span-4-190"><a id="__codelineno-4-190" name="__codelineno-4-190" href="#__codelineno-4-190"></a>    <span class="n">val_seed</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="__span-4-191"><a id="__codelineno-4-191" name="__codelineno-4-191" href="#__codelineno-4-191"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Random seed used to create the train/validation split.&quot;&quot;&quot;</span>
</span><span id="__span-4-192"><a id="__codelineno-4-192" name="__codelineno-4-192" href="#__codelineno-4-192"></a>
</span><span id="__span-4-193"><a id="__codelineno-4-193" name="__codelineno-4-193" href="#__codelineno-4-193"></a>    <span class="n">model_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">simple_parsing</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="o">*</span><span class="n">models</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span> <span class="n">default</span><span class="o">=</span><span class="s2">&quot;vit_b_32&quot;</span><span class="p">)</span>
</span><span id="__span-4-194"><a id="__codelineno-4-194" name="__codelineno-4-194" href="#__codelineno-4-194"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Which model function to use.&quot;&quot;&quot;</span>
</span><span id="__span-4-195"><a id="__codelineno-4-195" name="__codelineno-4-195" href="#__codelineno-4-195"></a>
</span><span id="__span-4-196"><a id="__codelineno-4-196" name="__codelineno-4-196" href="#__codelineno-4-196"></a>    <span class="nb">compile</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
</span><span id="__span-4-197"><a id="__codelineno-4-197" name="__codelineno-4-197" href="#__codelineno-4-197"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;If set, use torch.compile to compile the model with the given string as the &quot;mode&quot; argument.&quot;&quot;&quot;</span>
</span><span id="__span-4-198"><a id="__codelineno-4-198" name="__codelineno-4-198" href="#__codelineno-4-198"></a>
</span><span id="__span-4-199"><a id="__codelineno-4-199" name="__codelineno-4-199" href="#__codelineno-4-199"></a>    <span class="n">verbose</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">simple_parsing</span><span class="o">.</span><span class="n">field</span><span class="p">(</span><span class="n">alias</span><span class="o">=</span><span class="s2">&quot;-v&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;count&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span id="__span-4-200"><a id="__codelineno-4-200" name="__codelineno-4-200" href="#__codelineno-4-200"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Increase logging verbosity (can be specified multiple times).&quot;&quot;&quot;</span>
</span><span id="__span-4-201"><a id="__codelineno-4-201" name="__codelineno-4-201" href="#__codelineno-4-201"></a>
</span><span id="__span-4-202"><a id="__codelineno-4-202" name="__codelineno-4-202" href="#__codelineno-4-202"></a>    <span class="c1"># IDEA: Can we instead use a logging interval in seconds?</span>
</span><span id="__span-4-203"><a id="__codelineno-4-203" name="__codelineno-4-203" href="#__codelineno-4-203"></a>    <span class="c1"># One problem is that this would make it hard to compare metric values at the same step.</span>
</span><span id="__span-4-204"><a id="__codelineno-4-204" name="__codelineno-4-204" href="#__codelineno-4-204"></a>    <span class="n">logging_interval</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">20</span>
</span><span id="__span-4-205"><a id="__codelineno-4-205" name="__codelineno-4-205" href="#__codelineno-4-205"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Interval (in batches) between logging of training metrics to wandb or to the output file.&quot;&quot;&quot;</span>
</span><span id="__span-4-206"><a id="__codelineno-4-206" name="__codelineno-4-206" href="#__codelineno-4-206"></a>
</span><span id="__span-4-207"><a id="__codelineno-4-207" name="__codelineno-4-207" href="#__codelineno-4-207"></a>    <span class="n">use_amp</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="__span-4-208"><a id="__codelineno-4-208" name="__codelineno-4-208" href="#__codelineno-4-208"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;If True, use automatic mixed precision (AMP) for training.&quot;&quot;&quot;</span>
</span><span id="__span-4-209"><a id="__codelineno-4-209" name="__codelineno-4-209" href="#__codelineno-4-209"></a>
</span><span id="__span-4-210"><a id="__codelineno-4-210" name="__codelineno-4-210" href="#__codelineno-4-210"></a>    <span class="n">run_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="n">JOB_ID</span> <span class="o">+</span> <span class="p">(</span>
</span><span id="__span-4-211"><a id="__codelineno-4-211" name="__codelineno-4-211" href="#__codelineno-4-211"></a>        <span class="sa">f</span><span class="s2">&quot;_step</span><span class="si">{</span><span class="n">_step</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="p">(</span><span class="n">_step</span> <span class="o">:=</span> <span class="nb">int</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;SLURM_STEP_ID&quot;</span><span class="p">,</span> <span class="s2">&quot;0&quot;</span><span class="p">)))</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>
</span><span id="__span-4-212"><a id="__codelineno-4-212" name="__codelineno-4-212" href="#__codelineno-4-212"></a>    <span class="p">)</span>
</span><span id="__span-4-213"><a id="__codelineno-4-213" name="__codelineno-4-213" href="#__codelineno-4-213"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Name for the run (in wandb and in tensorboard).&quot;&quot;&quot;</span>
</span><span id="__span-4-214"><a id="__codelineno-4-214" name="__codelineno-4-214" href="#__codelineno-4-214"></a>
</span><span id="__span-4-215"><a id="__codelineno-4-215" name="__codelineno-4-215" href="#__codelineno-4-215"></a>    <span class="n">wandb_run_id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">JOB_ID</span> <span class="o">+</span> <span class="p">(</span>
</span><span id="__span-4-216"><a id="__codelineno-4-216" name="__codelineno-4-216" href="#__codelineno-4-216"></a>        <span class="sa">f</span><span class="s2">&quot;_step</span><span class="si">{</span><span class="n">_step</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="p">(</span><span class="n">_step</span> <span class="o">:=</span> <span class="nb">int</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;SLURM_STEP_ID&quot;</span><span class="p">,</span> <span class="s2">&quot;0&quot;</span><span class="p">)))</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>
</span><span id="__span-4-217"><a id="__codelineno-4-217" name="__codelineno-4-217" href="#__codelineno-4-217"></a>    <span class="p">)</span>
</span><span id="__span-4-218"><a id="__codelineno-4-218" name="__codelineno-4-218" href="#__codelineno-4-218"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Unique ID for the Weights &amp; Biases run.</span>
</span><span id="__span-4-219"><a id="__codelineno-4-219" name="__codelineno-4-219" href="#__codelineno-4-219"></a>
</span><span id="__span-4-220"><a id="__codelineno-4-220" name="__codelineno-4-220" href="#__codelineno-4-220"></a><span class="sd">    Used to resume a run if the job is restarted.</span>
</span><span id="__span-4-221"><a id="__codelineno-4-221" name="__codelineno-4-221" href="#__codelineno-4-221"></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="__span-4-222"><a id="__codelineno-4-222" name="__codelineno-4-222" href="#__codelineno-4-222"></a>
</span><span id="__span-4-223"><a id="__codelineno-4-223" name="__codelineno-4-223" href="#__codelineno-4-223"></a>    <span class="n">wandb_group</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="__span-4-224"><a id="__codelineno-4-224" name="__codelineno-4-224" href="#__codelineno-4-224"></a>
</span><span id="__span-4-225"><a id="__codelineno-4-225" name="__codelineno-4-225" href="#__codelineno-4-225"></a>    <span class="n">wandb_project</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;codingtips_profiling_example&quot;</span>
</span><span id="__span-4-226"><a id="__codelineno-4-226" name="__codelineno-4-226" href="#__codelineno-4-226"></a>
</span><span id="__span-4-227"><a id="__codelineno-4-227" name="__codelineno-4-227" href="#__codelineno-4-227"></a>    <span class="n">no_wandb</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="__span-4-228"><a id="__codelineno-4-228" name="__codelineno-4-228" href="#__codelineno-4-228"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;When set, disables wandb logging.&quot;&quot;&quot;</span>
</span><span id="__span-4-229"><a id="__codelineno-4-229" name="__codelineno-4-229" href="#__codelineno-4-229"></a>
</span><span id="__span-4-230"><a id="__codelineno-4-230" name="__codelineno-4-230" href="#__codelineno-4-230"></a>
</span><span id="__span-4-231"><a id="__codelineno-4-231" name="__codelineno-4-231" href="#__codelineno-4-231"></a><span class="k">def</span><span class="w"> </span><span class="nf">main</span><span class="p">():</span>
</span><span id="__span-4-232"><a id="__codelineno-4-232" name="__codelineno-4-232" href="#__codelineno-4-232"></a>    <span class="c1"># Use an argument parser so we can pass hyperparameters from the command line.</span>
</span><span id="__span-4-233"><a id="__codelineno-4-233" name="__codelineno-4-233" href="#__codelineno-4-233"></a>    <span class="c1"># You can use plain argparse if you like. Simple-parsing is an extension of argparse for dataclasses.</span>
</span><span id="__span-4-234"><a id="__codelineno-4-234" name="__codelineno-4-234" href="#__codelineno-4-234"></a>    <span class="n">args</span><span class="p">:</span> <span class="n">Args</span> <span class="o">=</span> <span class="n">simple_parsing</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">Args</span><span class="p">)</span>
</span><span id="__span-4-235"><a id="__codelineno-4-235" name="__codelineno-4-235" href="#__codelineno-4-235"></a>
</span><span id="__span-4-236"><a id="__codelineno-4-236" name="__codelineno-4-236" href="#__codelineno-4-236"></a>    <span class="c1"># Create a checkpoints directory in $SCRATCH and symlink it so it appears in the current directory.</span>
</span><span id="__span-4-237"><a id="__codelineno-4-237" name="__codelineno-4-237" href="#__codelineno-4-237"></a>    <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">_checkpoints_dir</span> <span class="o">:=</span> <span class="n">Path</span><span class="p">(</span><span class="s2">&quot;checkpoints&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
</span><span id="__span-4-238"><a id="__codelineno-4-238" name="__codelineno-4-238" href="#__codelineno-4-238"></a>        <span class="n">_checkpoints_dir_in_scratch</span> <span class="o">=</span> <span class="n">SCRATCH</span> <span class="o">/</span> <span class="s2">&quot;checkpoints&quot;</span>
</span><span id="__span-4-239"><a id="__codelineno-4-239" name="__codelineno-4-239" href="#__codelineno-4-239"></a>        <span class="n">_checkpoints_dir_in_scratch</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="__span-4-240"><a id="__codelineno-4-240" name="__codelineno-4-240" href="#__codelineno-4-240"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Creating a symlink from </span><span class="si">{</span><span class="n">_checkpoints_dir</span><span class="si">}</span><span class="s2"> --&gt; </span><span class="si">{</span><span class="n">_checkpoints_dir_in_scratch</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-4-241"><a id="__codelineno-4-241" name="__codelineno-4-241" href="#__codelineno-4-241"></a>        <span class="n">_checkpoints_dir</span><span class="o">.</span><span class="n">symlink_to</span><span class="p">(</span><span class="n">_checkpoints_dir_in_scratch</span><span class="p">)</span>
</span><span id="__span-4-242"><a id="__codelineno-4-242" name="__codelineno-4-242" href="#__codelineno-4-242"></a>
</span><span id="__span-4-243"><a id="__codelineno-4-243" name="__codelineno-4-243" href="#__codelineno-4-243"></a>    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">checkpoint_dir</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="__span-4-244"><a id="__codelineno-4-244" name="__codelineno-4-244" href="#__codelineno-4-244"></a>        <span class="c1"># Use the run name or run_id as the checkpoint folder by default if unset.</span>
</span><span id="__span-4-245"><a id="__codelineno-4-245" name="__codelineno-4-245" href="#__codelineno-4-245"></a>        <span class="c1"># This makes it so the names in wandb and the names in tensorboard line up nicely.</span>
</span><span id="__span-4-246"><a id="__codelineno-4-246" name="__codelineno-4-246" href="#__codelineno-4-246"></a>        <span class="n">args</span><span class="o">.</span><span class="n">checkpoint_dir</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="__span-4-247"><a id="__codelineno-4-247" name="__codelineno-4-247" href="#__codelineno-4-247"></a>            <span class="n">SCRATCH</span> <span class="o">/</span> <span class="s2">&quot;checkpoints&quot;</span> <span class="o">/</span> <span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">run_name</span> <span class="ow">or</span> <span class="n">args</span><span class="o">.</span><span class="n">wandb_run_id</span> <span class="ow">or</span> <span class="n">JOB_ID</span><span class="p">)</span>
</span><span id="__span-4-248"><a id="__codelineno-4-248" name="__codelineno-4-248" href="#__codelineno-4-248"></a>        <span class="p">)</span>
</span><span id="__span-4-249"><a id="__codelineno-4-249" name="__codelineno-4-249" href="#__codelineno-4-249"></a>
</span><span id="__span-4-250"><a id="__codelineno-4-250" name="__codelineno-4-250" href="#__codelineno-4-250"></a>    <span class="k">assert</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">()</span> <span class="ow">and</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">device_count</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span>
</span><span id="__span-4-251"><a id="__codelineno-4-251" name="__codelineno-4-251" href="#__codelineno-4-251"></a>    <span class="k">assert</span> <span class="n">torch</span><span class="o">.</span><span class="n">distributed</span><span class="o">.</span><span class="n">is_available</span><span class="p">()</span>
</span><span id="__span-4-252"><a id="__codelineno-4-252" name="__codelineno-4-252" href="#__codelineno-4-252"></a>    <span class="c1"># https://docs.pytorch.org/tutorials/beginner/ddp_series_multigpu.html#constructing-the-process-group</span>
</span><span id="__span-4-253"><a id="__codelineno-4-253" name="__codelineno-4-253" href="#__codelineno-4-253"></a>    <span class="c1"># Default timeout is 30 minutes. Reducing the timeout here, so the job fails quicker if there&#39;s</span>
</span><span id="__span-4-254"><a id="__codelineno-4-254" name="__codelineno-4-254" href="#__codelineno-4-254"></a>    <span class="c1"># a communication problem between nodes.</span>
</span><span id="__span-4-255"><a id="__codelineno-4-255" name="__codelineno-4-255" href="#__codelineno-4-255"></a>    <span class="c1"># NOTE: Since preparing imagenet on each node can take about 12-15 minutes on the Mila cluster,</span>
</span><span id="__span-4-256"><a id="__codelineno-4-256" name="__codelineno-4-256" href="#__codelineno-4-256"></a>    <span class="c1"># we set the timeout to 20 minutes here.</span>
</span><span id="__span-4-257"><a id="__codelineno-4-257" name="__codelineno-4-257" href="#__codelineno-4-257"></a>    <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">set_device</span><span class="p">(</span><span class="n">LOCAL_RANK</span><span class="p">)</span>
</span><span id="__span-4-258"><a id="__codelineno-4-258" name="__codelineno-4-258" href="#__codelineno-4-258"></a>    <span class="n">torch</span><span class="o">.</span><span class="n">distributed</span><span class="o">.</span><span class="n">init_process_group</span><span class="p">(</span>
</span><span id="__span-4-259"><a id="__codelineno-4-259" name="__codelineno-4-259" href="#__codelineno-4-259"></a>        <span class="n">backend</span><span class="o">=</span><span class="s2">&quot;nccl&quot;</span><span class="p">,</span>
</span><span id="__span-4-260"><a id="__codelineno-4-260" name="__codelineno-4-260" href="#__codelineno-4-260"></a>        <span class="n">rank</span><span class="o">=</span><span class="n">RANK</span><span class="p">,</span>
</span><span id="__span-4-261"><a id="__codelineno-4-261" name="__codelineno-4-261" href="#__codelineno-4-261"></a>        <span class="n">world_size</span><span class="o">=</span><span class="n">WORLD_SIZE</span><span class="p">,</span>
</span><span id="__span-4-262"><a id="__codelineno-4-262" name="__codelineno-4-262" href="#__codelineno-4-262"></a>        <span class="n">timeout</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">minutes</span><span class="o">=</span><span class="mi">20</span><span class="p">),</span>
</span><span id="__span-4-263"><a id="__codelineno-4-263" name="__codelineno-4-263" href="#__codelineno-4-263"></a>    <span class="p">)</span>
</span><span id="__span-4-264"><a id="__codelineno-4-264" name="__codelineno-4-264" href="#__codelineno-4-264"></a>    <span class="n">is_master</span> <span class="o">=</span> <span class="n">RANK</span> <span class="o">==</span> <span class="mi">0</span>
</span><span id="__span-4-265"><a id="__codelineno-4-265" name="__codelineno-4-265" href="#__codelineno-4-265"></a>
</span><span id="__span-4-266"><a id="__codelineno-4-266" name="__codelineno-4-266" href="#__codelineno-4-266"></a>    <span class="n">device</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s2">&quot;cuda&quot;</span><span class="p">,</span> <span class="n">LOCAL_RANK</span><span class="p">)</span>
</span><span id="__span-4-267"><a id="__codelineno-4-267" name="__codelineno-4-267" href="#__codelineno-4-267"></a>
</span><span id="__span-4-268"><a id="__codelineno-4-268" name="__codelineno-4-268" href="#__codelineno-4-268"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Using random seed: </span><span class="si">{</span><span class="n">args</span><span class="o">.</span><span class="n">seed</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-4-269"><a id="__codelineno-4-269" name="__codelineno-4-269" href="#__codelineno-4-269"></a>    <span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">seed</span><span class="p">)</span>
</span><span id="__span-4-270"><a id="__codelineno-4-270" name="__codelineno-4-270" href="#__codelineno-4-270"></a>    <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">seed</span><span class="p">)</span>
</span><span id="__span-4-271"><a id="__codelineno-4-271" name="__codelineno-4-271" href="#__codelineno-4-271"></a>    <span class="n">torch</span><span class="o">.</span><span class="n">manual_seed</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">seed</span><span class="p">)</span>
</span><span id="__span-4-272"><a id="__codelineno-4-272" name="__codelineno-4-272" href="#__codelineno-4-272"></a>
</span><span id="__span-4-273"><a id="__codelineno-4-273" name="__codelineno-4-273" href="#__codelineno-4-273"></a>    <span class="n">logger</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span>
</span><span id="__span-4-274"><a id="__codelineno-4-274" name="__codelineno-4-274" href="#__codelineno-4-274"></a>        <span class="n">logging</span><span class="o">.</span><span class="n">WARNING</span>
</span><span id="__span-4-275"><a id="__codelineno-4-275" name="__codelineno-4-275" href="#__codelineno-4-275"></a>        <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">verbose</span> <span class="o">==</span> <span class="mi">0</span>
</span><span id="__span-4-276"><a id="__codelineno-4-276" name="__codelineno-4-276" href="#__codelineno-4-276"></a>        <span class="k">else</span> <span class="n">logging</span><span class="o">.</span><span class="n">INFO</span>
</span><span id="__span-4-277"><a id="__codelineno-4-277" name="__codelineno-4-277" href="#__codelineno-4-277"></a>        <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">verbose</span> <span class="o">==</span> <span class="mi">1</span>
</span><span id="__span-4-278"><a id="__codelineno-4-278" name="__codelineno-4-278" href="#__codelineno-4-278"></a>        <span class="k">else</span> <span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span>
</span><span id="__span-4-279"><a id="__codelineno-4-279" name="__codelineno-4-279" href="#__codelineno-4-279"></a>    <span class="p">)</span>
</span><span id="__span-4-280"><a id="__codelineno-4-280" name="__codelineno-4-280" href="#__codelineno-4-280"></a>    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;World size: </span><span class="si">{</span><span class="n">WORLD_SIZE</span><span class="si">}</span><span class="s2">, global rank: </span><span class="si">{</span><span class="n">RANK</span><span class="si">}</span><span class="s2">, local rank: </span><span class="si">{</span><span class="n">LOCAL_RANK</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-4-281"><a id="__codelineno-4-281" name="__codelineno-4-281" href="#__codelineno-4-281"></a>    <span class="k">if</span> <span class="n">is_master</span><span class="p">:</span>
</span><span id="__span-4-282"><a id="__codelineno-4-282" name="__codelineno-4-282" href="#__codelineno-4-282"></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Args:&quot;</span><span class="p">)</span>
</span><span id="__span-4-283"><a id="__codelineno-4-283" name="__codelineno-4-283" href="#__codelineno-4-283"></a>        <span class="n">rich</span><span class="o">.</span><span class="n">pretty</span><span class="o">.</span><span class="n">pprint</span><span class="p">(</span><span class="n">dataclasses</span><span class="o">.</span><span class="n">asdict</span><span class="p">(</span><span class="n">args</span><span class="p">))</span>
</span><span id="__span-4-284"><a id="__codelineno-4-284" name="__codelineno-4-284" href="#__codelineno-4-284"></a>
</span><span id="__span-4-285"><a id="__codelineno-4-285" name="__codelineno-4-285" href="#__codelineno-4-285"></a>    <span class="c1"># Create a model and move it to the GPU.</span>
</span><span id="__span-4-286"><a id="__codelineno-4-286" name="__codelineno-4-286" href="#__codelineno-4-286"></a>    <span class="n">kwargs</span> <span class="o">=</span> <span class="p">{}</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">args</span><span class="o">.</span><span class="n">pretrained</span> <span class="k">else</span> <span class="p">{</span><span class="s2">&quot;weights&quot;</span><span class="p">:</span> <span class="s2">&quot;DEFAULT&quot;</span><span class="p">}</span>
</span><span id="__span-4-287"><a id="__codelineno-4-287" name="__codelineno-4-287" href="#__codelineno-4-287"></a>    <span class="k">with</span> <span class="n">device</span><span class="p">:</span>
</span><span id="__span-4-288"><a id="__codelineno-4-288" name="__codelineno-4-288" href="#__codelineno-4-288"></a>        <span class="n">model</span> <span class="o">=</span> <span class="n">models</span><span class="p">[</span><span class="n">args</span><span class="o">.</span><span class="n">model_name</span><span class="p">](</span><span class="n">num_classes</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</span><span id="__span-4-289"><a id="__codelineno-4-289" name="__codelineno-4-289" href="#__codelineno-4-289"></a>        <span class="n">model</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
</span><span id="__span-4-290"><a id="__codelineno-4-290" name="__codelineno-4-290" href="#__codelineno-4-290"></a>    <span class="c1"># https://docs.pytorch.org/tutorials/beginner/ddp_series_multigpu.html#multi-gpu-training-with-ddp</span>
</span><span id="__span-4-291"><a id="__codelineno-4-291" name="__codelineno-4-291" href="#__codelineno-4-291"></a>    <span class="n">model</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">SyncBatchNorm</span><span class="o">.</span><span class="n">convert_sync_batchnorm</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
</span><span id="__span-4-292"><a id="__codelineno-4-292" name="__codelineno-4-292" href="#__codelineno-4-292"></a>    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">compile</span><span class="p">:</span>
</span><span id="__span-4-293"><a id="__codelineno-4-293" name="__codelineno-4-293" href="#__codelineno-4-293"></a>        <span class="c1"># TODO: Try different torch.compile modes, see how this affects performance!</span>
</span><span id="__span-4-294"><a id="__codelineno-4-294" name="__codelineno-4-294" href="#__codelineno-4-294"></a>        <span class="n">torch</span><span class="o">.</span><span class="n">set_float32_matmul_precision</span><span class="p">(</span><span class="s2">&quot;high&quot;</span><span class="p">)</span>  <span class="c1"># Use TensorFloat32 tensor cores.</span>
</span><span id="__span-4-295"><a id="__codelineno-4-295" name="__codelineno-4-295" href="#__codelineno-4-295"></a>        <span class="n">model</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">compile</span><span class="p">)</span>
</span><span id="__span-4-296"><a id="__codelineno-4-296" name="__codelineno-4-296" href="#__codelineno-4-296"></a>    <span class="c1"># Wrap the model with DistributedDataParallel</span>
</span><span id="__span-4-297"><a id="__codelineno-4-297" name="__codelineno-4-297" href="#__codelineno-4-297"></a>    <span class="c1"># (See https://pytorch.org/docs/stable/nn.html#torch.nn.parallel.DistributedDataParallel)</span>
</span><span id="__span-4-298"><a id="__codelineno-4-298" name="__codelineno-4-298" href="#__codelineno-4-298"></a>    <span class="n">model</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">parallel</span><span class="o">.</span><span class="n">DistributedDataParallel</span><span class="p">(</span>
</span><span id="__span-4-299"><a id="__codelineno-4-299" name="__codelineno-4-299" href="#__codelineno-4-299"></a>        <span class="n">model</span><span class="p">,</span> <span class="n">device_ids</span><span class="o">=</span><span class="p">[</span><span class="n">LOCAL_RANK</span><span class="p">],</span> <span class="n">output_device</span><span class="o">=</span><span class="n">LOCAL_RANK</span>
</span><span id="__span-4-300"><a id="__codelineno-4-300" name="__codelineno-4-300" href="#__codelineno-4-300"></a>    <span class="p">)</span>
</span><span id="__span-4-301"><a id="__codelineno-4-301" name="__codelineno-4-301" href="#__codelineno-4-301"></a>
</span><span id="__span-4-302"><a id="__codelineno-4-302" name="__codelineno-4-302" href="#__codelineno-4-302"></a>    <span class="n">optimizer</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">AdamW</span><span class="p">(</span>
</span><span id="__span-4-303"><a id="__codelineno-4-303" name="__codelineno-4-303" href="#__codelineno-4-303"></a>        <span class="n">model</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="n">lr</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">learning_rate</span><span class="p">,</span> <span class="n">weight_decay</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">weight_decay</span>
</span><span id="__span-4-304"><a id="__codelineno-4-304" name="__codelineno-4-304" href="#__codelineno-4-304"></a>    <span class="p">)</span>
</span><span id="__span-4-305"><a id="__codelineno-4-305" name="__codelineno-4-305" href="#__codelineno-4-305"></a>    <span class="c1"># https://docs.pytorch.org/tutorials/recipes/recipes/amp_recipe.html</span>
</span><span id="__span-4-306"><a id="__codelineno-4-306" name="__codelineno-4-306" href="#__codelineno-4-306"></a>    <span class="n">scaler</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="__span-4-307"><a id="__codelineno-4-307" name="__codelineno-4-307" href="#__codelineno-4-307"></a>    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">use_amp</span><span class="p">:</span>
</span><span id="__span-4-308"><a id="__codelineno-4-308" name="__codelineno-4-308" href="#__codelineno-4-308"></a>        <span class="n">scaler</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">amp</span><span class="o">.</span><span class="n">grad_scaler</span><span class="o">.</span><span class="n">GradScaler</span><span class="p">(</span><span class="n">enabled</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="__span-4-309"><a id="__codelineno-4-309" name="__codelineno-4-309" href="#__codelineno-4-309"></a>        <span class="n">torch</span><span class="o">.</span><span class="n">set_float32_matmul_precision</span><span class="p">(</span><span class="s2">&quot;high&quot;</span><span class="p">)</span>
</span><span id="__span-4-310"><a id="__codelineno-4-310" name="__codelineno-4-310" href="#__codelineno-4-310"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Using automatic mixed precision (AMP) with bfloat16&quot;</span><span class="p">)</span>
</span><span id="__span-4-311"><a id="__codelineno-4-311" name="__codelineno-4-311" href="#__codelineno-4-311"></a>
</span><span id="__span-4-312"><a id="__codelineno-4-312" name="__codelineno-4-312" href="#__codelineno-4-312"></a>    <span class="c1"># Setup the dataset.</span>
</span><span id="__span-4-313"><a id="__codelineno-4-313" name="__codelineno-4-313" href="#__codelineno-4-313"></a>    <span class="n">train_dataset</span><span class="p">,</span> <span class="n">valid_dataset</span><span class="p">,</span> <span class="n">test_dataset</span> <span class="o">=</span> <span class="n">make_datasets</span><span class="p">(</span>
</span><span id="__span-4-314"><a id="__codelineno-4-314" name="__codelineno-4-314" href="#__codelineno-4-314"></a>        <span class="n">args</span><span class="o">.</span><span class="n">dataset_path</span><span class="p">,</span>
</span><span id="__span-4-315"><a id="__codelineno-4-315" name="__codelineno-4-315" href="#__codelineno-4-315"></a>        <span class="n">val_split_seed</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">val_seed</span><span class="p">,</span>
</span><span id="__span-4-316"><a id="__codelineno-4-316" name="__codelineno-4-316" href="#__codelineno-4-316"></a>        <span class="n">use_fake_data</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">use_fake_data</span><span class="p">,</span>
</span><span id="__span-4-317"><a id="__codelineno-4-317" name="__codelineno-4-317" href="#__codelineno-4-317"></a>    <span class="p">)</span>
</span><span id="__span-4-318"><a id="__codelineno-4-318" name="__codelineno-4-318" href="#__codelineno-4-318"></a>    <span class="c1"># IDEA: Use a smaller subset of the dataset for faster debugging of the checkpointing / validation loop or</span>
</span><span id="__span-4-319"><a id="__codelineno-4-319" name="__codelineno-4-319" href="#__codelineno-4-319"></a>    <span class="c1"># to test if the model can overfit on a small number of samples.</span>
</span><span id="__span-4-320"><a id="__codelineno-4-320" name="__codelineno-4-320" href="#__codelineno-4-320"></a>    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">limit_train_samples</span><span class="p">:</span>
</span><span id="__span-4-321"><a id="__codelineno-4-321" name="__codelineno-4-321" href="#__codelineno-4-321"></a>        <span class="n">train_dataset</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">Subset</span><span class="p">(</span>
</span><span id="__span-4-322"><a id="__codelineno-4-322" name="__codelineno-4-322" href="#__codelineno-4-322"></a>            <span class="n">train_dataset</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">limit_train_samples</span><span class="p">))</span>
</span><span id="__span-4-323"><a id="__codelineno-4-323" name="__codelineno-4-323" href="#__codelineno-4-323"></a>        <span class="p">)</span>
</span><span id="__span-4-324"><a id="__codelineno-4-324" name="__codelineno-4-324" href="#__codelineno-4-324"></a>    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">limit_val_samples</span><span class="p">:</span>
</span><span id="__span-4-325"><a id="__codelineno-4-325" name="__codelineno-4-325" href="#__codelineno-4-325"></a>        <span class="n">valid_dataset</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">Subset</span><span class="p">(</span><span class="n">valid_dataset</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">limit_val_samples</span><span class="p">)))</span>
</span><span id="__span-4-326"><a id="__codelineno-4-326" name="__codelineno-4-326" href="#__codelineno-4-326"></a>
</span><span id="__span-4-327"><a id="__codelineno-4-327" name="__codelineno-4-327" href="#__codelineno-4-327"></a>    <span class="c1"># Restricts data loading to a subset of the dataset exclusive to the current process</span>
</span><span id="__span-4-328"><a id="__codelineno-4-328" name="__codelineno-4-328" href="#__codelineno-4-328"></a>    <span class="n">train_sampler</span> <span class="o">=</span> <span class="n">DistributedSampler</span><span class="p">(</span>
</span><span id="__span-4-329"><a id="__codelineno-4-329" name="__codelineno-4-329" href="#__codelineno-4-329"></a>        <span class="n">dataset</span><span class="o">=</span><span class="n">train_dataset</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">num_replicas</span><span class="o">=</span><span class="n">WORLD_SIZE</span><span class="p">,</span> <span class="n">rank</span><span class="o">=</span><span class="n">RANK</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">seed</span>
</span><span id="__span-4-330"><a id="__codelineno-4-330" name="__codelineno-4-330" href="#__codelineno-4-330"></a>    <span class="p">)</span>
</span><span id="__span-4-331"><a id="__codelineno-4-331" name="__codelineno-4-331" href="#__codelineno-4-331"></a>    <span class="n">valid_sampler</span> <span class="o">=</span> <span class="n">DistributedSampler</span><span class="p">(</span>
</span><span id="__span-4-332"><a id="__codelineno-4-332" name="__codelineno-4-332" href="#__codelineno-4-332"></a>        <span class="n">dataset</span><span class="o">=</span><span class="n">valid_dataset</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">num_replicas</span><span class="o">=</span><span class="n">WORLD_SIZE</span><span class="p">,</span> <span class="n">rank</span><span class="o">=</span><span class="n">RANK</span>
</span><span id="__span-4-333"><a id="__codelineno-4-333" name="__codelineno-4-333" href="#__codelineno-4-333"></a>    <span class="p">)</span>
</span><span id="__span-4-334"><a id="__codelineno-4-334" name="__codelineno-4-334" href="#__codelineno-4-334"></a>    <span class="n">test_sampler</span> <span class="o">=</span> <span class="n">DistributedSampler</span><span class="p">(</span>
</span><span id="__span-4-335"><a id="__codelineno-4-335" name="__codelineno-4-335" href="#__codelineno-4-335"></a>        <span class="n">dataset</span><span class="o">=</span><span class="n">test_dataset</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">num_replicas</span><span class="o">=</span><span class="n">WORLD_SIZE</span><span class="p">,</span> <span class="n">rank</span><span class="o">=</span><span class="n">RANK</span>
</span><span id="__span-4-336"><a id="__codelineno-4-336" name="__codelineno-4-336" href="#__codelineno-4-336"></a>    <span class="p">)</span>
</span><span id="__span-4-337"><a id="__codelineno-4-337" name="__codelineno-4-337" href="#__codelineno-4-337"></a>    <span class="c1"># TODO: make sure that the dataloader workers random state is restored properly.</span>
</span><span id="__span-4-338"><a id="__codelineno-4-338" name="__codelineno-4-338" href="#__codelineno-4-338"></a>    <span class="n">train_dataloader</span> <span class="o">=</span> <span class="n">DataLoader</span><span class="p">(</span>
</span><span id="__span-4-339"><a id="__codelineno-4-339" name="__codelineno-4-339" href="#__codelineno-4-339"></a>        <span class="n">train_dataset</span><span class="p">,</span>
</span><span id="__span-4-340"><a id="__codelineno-4-340" name="__codelineno-4-340" href="#__codelineno-4-340"></a>        <span class="n">batch_size</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">batch_size</span><span class="p">,</span>
</span><span id="__span-4-341"><a id="__codelineno-4-341" name="__codelineno-4-341" href="#__codelineno-4-341"></a>        <span class="n">num_workers</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">num_workers</span><span class="p">,</span>
</span><span id="__span-4-342"><a id="__codelineno-4-342" name="__codelineno-4-342" href="#__codelineno-4-342"></a>        <span class="n">sampler</span><span class="o">=</span><span class="n">train_sampler</span><span class="p">,</span>
</span><span id="__span-4-343"><a id="__codelineno-4-343" name="__codelineno-4-343" href="#__codelineno-4-343"></a>        <span class="n">pin_memory</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="__span-4-344"><a id="__codelineno-4-344" name="__codelineno-4-344" href="#__codelineno-4-344"></a>    <span class="p">)</span>
</span><span id="__span-4-345"><a id="__codelineno-4-345" name="__codelineno-4-345" href="#__codelineno-4-345"></a>    <span class="n">valid_dataloader</span> <span class="o">=</span> <span class="n">DataLoader</span><span class="p">(</span>
</span><span id="__span-4-346"><a id="__codelineno-4-346" name="__codelineno-4-346" href="#__codelineno-4-346"></a>        <span class="n">valid_dataset</span><span class="p">,</span>
</span><span id="__span-4-347"><a id="__codelineno-4-347" name="__codelineno-4-347" href="#__codelineno-4-347"></a>        <span class="n">batch_size</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">batch_size</span><span class="p">,</span>
</span><span id="__span-4-348"><a id="__codelineno-4-348" name="__codelineno-4-348" href="#__codelineno-4-348"></a>        <span class="n">num_workers</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">num_workers</span><span class="p">,</span>
</span><span id="__span-4-349"><a id="__codelineno-4-349" name="__codelineno-4-349" href="#__codelineno-4-349"></a>        <span class="n">sampler</span><span class="o">=</span><span class="n">valid_sampler</span><span class="p">,</span>
</span><span id="__span-4-350"><a id="__codelineno-4-350" name="__codelineno-4-350" href="#__codelineno-4-350"></a>        <span class="n">pin_memory</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="__span-4-351"><a id="__codelineno-4-351" name="__codelineno-4-351" href="#__codelineno-4-351"></a>    <span class="p">)</span>
</span><span id="__span-4-352"><a id="__codelineno-4-352" name="__codelineno-4-352" href="#__codelineno-4-352"></a>    <span class="n">_test_dataloader</span> <span class="o">=</span> <span class="n">DataLoader</span><span class="p">(</span>  <span class="c1"># Not used in this example.</span>
</span><span id="__span-4-353"><a id="__codelineno-4-353" name="__codelineno-4-353" href="#__codelineno-4-353"></a>        <span class="n">test_dataset</span><span class="p">,</span>
</span><span id="__span-4-354"><a id="__codelineno-4-354" name="__codelineno-4-354" href="#__codelineno-4-354"></a>        <span class="n">batch_size</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">batch_size</span><span class="p">,</span>
</span><span id="__span-4-355"><a id="__codelineno-4-355" name="__codelineno-4-355" href="#__codelineno-4-355"></a>        <span class="n">num_workers</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">num_workers</span><span class="p">,</span>
</span><span id="__span-4-356"><a id="__codelineno-4-356" name="__codelineno-4-356" href="#__codelineno-4-356"></a>        <span class="n">sampler</span><span class="o">=</span><span class="n">test_sampler</span><span class="p">,</span>
</span><span id="__span-4-357"><a id="__codelineno-4-357" name="__codelineno-4-357" href="#__codelineno-4-357"></a>        <span class="n">pin_memory</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="__span-4-358"><a id="__codelineno-4-358" name="__codelineno-4-358" href="#__codelineno-4-358"></a>    <span class="p">)</span>
</span><span id="__span-4-359"><a id="__codelineno-4-359" name="__codelineno-4-359" href="#__codelineno-4-359"></a>    <span class="n">effective_batch_size</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">batch_size</span> <span class="o">*</span> <span class="n">WORLD_SIZE</span>
</span><span id="__span-4-360"><a id="__codelineno-4-360" name="__codelineno-4-360" href="#__codelineno-4-360"></a>    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Effective (global) batch size: </span><span class="si">{</span><span class="n">effective_batch_size</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-4-361"><a id="__codelineno-4-361" name="__codelineno-4-361" href="#__codelineno-4-361"></a>
</span><span id="__span-4-362"><a id="__codelineno-4-362" name="__codelineno-4-362" href="#__codelineno-4-362"></a>    <span class="c1"># Load the latest checkpoint if it exists.</span>
</span><span id="__span-4-363"><a id="__codelineno-4-363" name="__codelineno-4-363" href="#__codelineno-4-363"></a>    <span class="k">if</span> <span class="n">previous_checkpoints</span> <span class="o">:=</span> <span class="nb">list</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">checkpoint_dir</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s2">&quot;*.pt&quot;</span><span class="p">)):</span>
</span><span id="__span-4-364"><a id="__codelineno-4-364" name="__codelineno-4-364" href="#__codelineno-4-364"></a>        <span class="c1"># Checkpoints are named like `epoch_0.pt`, `epoch_1.pt`. Find the latest.</span>
</span><span id="__span-4-365"><a id="__codelineno-4-365" name="__codelineno-4-365" href="#__codelineno-4-365"></a>        <span class="c1"># Note: epoch_0 in this case is the initial checkpoint before any training.</span>
</span><span id="__span-4-366"><a id="__codelineno-4-366" name="__codelineno-4-366" href="#__codelineno-4-366"></a>        <span class="c1"># epoch_1 is after one epoch of training, etc.</span>
</span><span id="__span-4-367"><a id="__codelineno-4-367" name="__codelineno-4-367" href="#__codelineno-4-367"></a>        <span class="n">latest_checkpoint</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">previous_checkpoints</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">p</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">stem</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
</span><span id="__span-4-368"><a id="__codelineno-4-368" name="__codelineno-4-368" href="#__codelineno-4-368"></a>        <span class="n">_num_epochs_done</span><span class="p">,</span> <span class="n">step</span><span class="p">,</span> <span class="n">num_samples</span> <span class="o">=</span> <span class="n">load_checkpoint</span><span class="p">(</span>
</span><span id="__span-4-369"><a id="__codelineno-4-369" name="__codelineno-4-369" href="#__codelineno-4-369"></a>            <span class="n">latest_checkpoint</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">,</span> <span class="n">optimizer</span><span class="o">=</span><span class="n">optimizer</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span>
</span><span id="__span-4-370"><a id="__codelineno-4-370" name="__codelineno-4-370" href="#__codelineno-4-370"></a>        <span class="p">)</span>
</span><span id="__span-4-371"><a id="__codelineno-4-371" name="__codelineno-4-371" href="#__codelineno-4-371"></a>        <span class="n">starting_epoch</span> <span class="o">=</span> <span class="n">_num_epochs_done</span>
</span><span id="__span-4-372"><a id="__codelineno-4-372" name="__codelineno-4-372" href="#__codelineno-4-372"></a>        <span class="n">total_updates</span> <span class="o">=</span> <span class="n">step</span>
</span><span id="__span-4-373"><a id="__codelineno-4-373" name="__codelineno-4-373" href="#__codelineno-4-373"></a>        <span class="n">total_samples</span> <span class="o">=</span> <span class="n">num_samples</span>
</span><span id="__span-4-374"><a id="__codelineno-4-374" name="__codelineno-4-374" href="#__codelineno-4-374"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
</span><span id="__span-4-375"><a id="__codelineno-4-375" name="__codelineno-4-375" href="#__codelineno-4-375"></a>            <span class="sa">f</span><span class="s2">&quot;Resuming training from epoch </span><span class="si">{</span><span class="n">starting_epoch</span><span class="si">}</span><span class="s2"> (step </span><span class="si">{</span><span class="n">step</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">total_samples</span><span class="si">}</span><span class="s2"> total samples)&quot;</span>
</span><span id="__span-4-376"><a id="__codelineno-4-376" name="__codelineno-4-376" href="#__codelineno-4-376"></a>        <span class="p">)</span>
</span><span id="__span-4-377"><a id="__codelineno-4-377" name="__codelineno-4-377" href="#__codelineno-4-377"></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="__span-4-378"><a id="__codelineno-4-378" name="__codelineno-4-378" href="#__codelineno-4-378"></a>        <span class="n">starting_epoch</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="__span-4-379"><a id="__codelineno-4-379" name="__codelineno-4-379" href="#__codelineno-4-379"></a>        <span class="n">total_updates</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="__span-4-380"><a id="__codelineno-4-380" name="__codelineno-4-380" href="#__codelineno-4-380"></a>        <span class="n">total_samples</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="__span-4-381"><a id="__codelineno-4-381" name="__codelineno-4-381" href="#__codelineno-4-381"></a>        <span class="n">args</span><span class="o">.</span><span class="n">checkpoint_dir</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="__span-4-382"><a id="__codelineno-4-382" name="__codelineno-4-382" href="#__codelineno-4-382"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Starting training from scratch&quot;</span><span class="p">)</span>
</span><span id="__span-4-383"><a id="__codelineno-4-383" name="__codelineno-4-383" href="#__codelineno-4-383"></a>
</span><span id="__span-4-384"><a id="__codelineno-4-384" name="__codelineno-4-384" href="#__codelineno-4-384"></a>    <span class="c1"># Initialize wandb logging.</span>
</span><span id="__span-4-385"><a id="__codelineno-4-385" name="__codelineno-4-385" href="#__codelineno-4-385"></a>    <span class="n">setup_wandb</span><span class="p">(</span>
</span><span id="__span-4-386"><a id="__codelineno-4-386" name="__codelineno-4-386" href="#__codelineno-4-386"></a>        <span class="n">args</span><span class="p">,</span>
</span><span id="__span-4-387"><a id="__codelineno-4-387" name="__codelineno-4-387" href="#__codelineno-4-387"></a>        <span class="n">effective_batch_size</span><span class="o">=</span><span class="n">effective_batch_size</span><span class="p">,</span>
</span><span id="__span-4-388"><a id="__codelineno-4-388" name="__codelineno-4-388" href="#__codelineno-4-388"></a>        <span class="n">previous_checkpoints</span><span class="o">=</span><span class="n">previous_checkpoints</span><span class="p">,</span>
</span><span id="__span-4-389"><a id="__codelineno-4-389" name="__codelineno-4-389" href="#__codelineno-4-389"></a>        <span class="n">total_updates</span><span class="o">=</span><span class="n">total_updates</span><span class="p">,</span>
</span><span id="__span-4-390"><a id="__codelineno-4-390" name="__codelineno-4-390" href="#__codelineno-4-390"></a>    <span class="p">)</span>
</span><span id="__span-4-391"><a id="__codelineno-4-391" name="__codelineno-4-391" href="#__codelineno-4-391"></a>
</span><span id="__span-4-392"><a id="__codelineno-4-392" name="__codelineno-4-392" href="#__codelineno-4-392"></a>    <span class="c1"># Save an initial checkpoint (epoch 0) before training to make sure we can easily get the exact same initial weights.</span>
</span><span id="__span-4-393"><a id="__codelineno-4-393" name="__codelineno-4-393" href="#__codelineno-4-393"></a>    <span class="c1"># Since code is supposed to be correctly seeded and reproducible, this is just an additional precaution.</span>
</span><span id="__span-4-394"><a id="__codelineno-4-394" name="__codelineno-4-394" href="#__codelineno-4-394"></a>    <span class="c1"># Doing this here also makes it so if there is a checkpoint, there is also a wandb run, so we can resume the wandb run</span>
</span><span id="__span-4-395"><a id="__codelineno-4-395" name="__codelineno-4-395" href="#__codelineno-4-395"></a>    <span class="c1"># more correctly than with just `resume=&quot;allow&quot;`.</span>
</span><span id="__span-4-396"><a id="__codelineno-4-396" name="__codelineno-4-396" href="#__codelineno-4-396"></a>    <span class="k">if</span> <span class="ow">not</span> <span class="n">previous_checkpoints</span> <span class="ow">and</span> <span class="n">RANK</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="__span-4-397"><a id="__codelineno-4-397" name="__codelineno-4-397" href="#__codelineno-4-397"></a>        <span class="n">save_checkpoint</span><span class="p">(</span>
</span><span id="__span-4-398"><a id="__codelineno-4-398" name="__codelineno-4-398" href="#__codelineno-4-398"></a>            <span class="n">checkpoint_path</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">checkpoint_dir</span> <span class="o">/</span> <span class="s2">&quot;epoch_0.pt&quot;</span><span class="p">,</span>
</span><span id="__span-4-399"><a id="__codelineno-4-399" name="__codelineno-4-399" href="#__codelineno-4-399"></a>            <span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">,</span>
</span><span id="__span-4-400"><a id="__codelineno-4-400" name="__codelineno-4-400" href="#__codelineno-4-400"></a>            <span class="n">optimizer</span><span class="o">=</span><span class="n">optimizer</span><span class="p">,</span>
</span><span id="__span-4-401"><a id="__codelineno-4-401" name="__codelineno-4-401" href="#__codelineno-4-401"></a>            <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">,</span>
</span><span id="__span-4-402"><a id="__codelineno-4-402" name="__codelineno-4-402" href="#__codelineno-4-402"></a>            <span class="n">epoch</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
</span><span id="__span-4-403"><a id="__codelineno-4-403" name="__codelineno-4-403" href="#__codelineno-4-403"></a>            <span class="n">step</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
</span><span id="__span-4-404"><a id="__codelineno-4-404" name="__codelineno-4-404" href="#__codelineno-4-404"></a>            <span class="n">num_samples</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
</span><span id="__span-4-405"><a id="__codelineno-4-405" name="__codelineno-4-405" href="#__codelineno-4-405"></a>        <span class="p">)</span>
</span><span id="__span-4-406"><a id="__codelineno-4-406" name="__codelineno-4-406" href="#__codelineno-4-406"></a>
</span><span id="__span-4-407"><a id="__codelineno-4-407" name="__codelineno-4-407" href="#__codelineno-4-407"></a>    <span class="c1"># Create the PyTorch profiler with a schedule that will output some traces that can be inspected with tensorboard.</span>
</span><span id="__span-4-408"><a id="__codelineno-4-408" name="__codelineno-4-408" href="#__codelineno-4-408"></a>    <span class="c1"># https://docs.pytorch.org/tutorials/recipes/recipes/profiler_recipe.html#using-profiler-to-analyze-long-running-jobs</span>
</span><span id="__span-4-409"><a id="__codelineno-4-409" name="__codelineno-4-409" href="#__codelineno-4-409"></a>    <span class="c1"># To view the traces, run `uvx tensorboard --with=torch_tb_profiler --logdir checkpoints`</span>
</span><span id="__span-4-410"><a id="__codelineno-4-410" name="__codelineno-4-410" href="#__codelineno-4-410"></a>    <span class="n">profiler</span> <span class="o">=</span> <span class="n">profile</span><span class="p">(</span>
</span><span id="__span-4-411"><a id="__codelineno-4-411" name="__codelineno-4-411" href="#__codelineno-4-411"></a>        <span class="n">schedule</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">profiler</span><span class="o">.</span><span class="n">schedule</span><span class="p">(</span><span class="n">wait</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">warmup</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">active</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">repeat</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span>
</span><span id="__span-4-412"><a id="__codelineno-4-412" name="__codelineno-4-412" href="#__codelineno-4-412"></a>        <span class="n">on_trace_ready</span><span class="o">=</span><span class="n">tensorboard_trace_handler</span><span class="p">(</span>
</span><span id="__span-4-413"><a id="__codelineno-4-413" name="__codelineno-4-413" href="#__codelineno-4-413"></a>            <span class="nb">str</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">checkpoint_dir</span><span class="p">),</span> <span class="n">worker_name</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;rank_</span><span class="si">{</span><span class="n">RANK</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="__span-4-414"><a id="__codelineno-4-414" name="__codelineno-4-414" href="#__codelineno-4-414"></a>        <span class="p">),</span>
</span><span id="__span-4-415"><a id="__codelineno-4-415" name="__codelineno-4-415" href="#__codelineno-4-415"></a>        <span class="n">record_shapes</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="__span-4-416"><a id="__codelineno-4-416" name="__codelineno-4-416" href="#__codelineno-4-416"></a>        <span class="n">profile_memory</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="__span-4-417"><a id="__codelineno-4-417" name="__codelineno-4-417" href="#__codelineno-4-417"></a>        <span class="c1"># Warning: This can be a bit too verbose while debugging. Only enable this if you really need it.</span>
</span><span id="__span-4-418"><a id="__codelineno-4-418" name="__codelineno-4-418" href="#__codelineno-4-418"></a>        <span class="c1"># with_stack=True if &quot;debugpy&quot; not in sys.modules else True,</span>
</span><span id="__span-4-419"><a id="__codelineno-4-419" name="__codelineno-4-419" href="#__codelineno-4-419"></a>        <span class="n">with_stack</span><span class="o">=</span><span class="kc">True</span> <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">verbose</span> <span class="o">&gt;=</span> <span class="mi">3</span> <span class="k">else</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="__span-4-420"><a id="__codelineno-4-420" name="__codelineno-4-420" href="#__codelineno-4-420"></a>        <span class="n">with_flops</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="__span-4-421"><a id="__codelineno-4-421" name="__codelineno-4-421" href="#__codelineno-4-421"></a>        <span class="n">with_modules</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="__span-4-422"><a id="__codelineno-4-422" name="__codelineno-4-422" href="#__codelineno-4-422"></a>    <span class="p">)</span>
</span><span id="__span-4-423"><a id="__codelineno-4-423" name="__codelineno-4-423" href="#__codelineno-4-423"></a>
</span><span id="__span-4-424"><a id="__codelineno-4-424" name="__codelineno-4-424" href="#__codelineno-4-424"></a>    <span class="c1">###################</span>
</span><span id="__span-4-425"><a id="__codelineno-4-425" name="__codelineno-4-425" href="#__codelineno-4-425"></a>    <span class="c1">## Training loop ##</span>
</span><span id="__span-4-426"><a id="__codelineno-4-426" name="__codelineno-4-426" href="#__codelineno-4-426"></a>    <span class="c1">###################</span>
</span><span id="__span-4-427"><a id="__codelineno-4-427" name="__codelineno-4-427" href="#__codelineno-4-427"></a>
</span><span id="__span-4-428"><a id="__codelineno-4-428" name="__codelineno-4-428" href="#__codelineno-4-428"></a>    <span class="c1"># Used at the end to display overall samples per second.</span>
</span><span id="__span-4-429"><a id="__codelineno-4-429" name="__codelineno-4-429" href="#__codelineno-4-429"></a>    <span class="n">t0</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
</span><span id="__span-4-430"><a id="__codelineno-4-430" name="__codelineno-4-430" href="#__codelineno-4-430"></a>    <span class="n">starting_num_samples</span> <span class="o">=</span> <span class="n">total_samples</span>
</span><span id="__span-4-431"><a id="__codelineno-4-431" name="__codelineno-4-431" href="#__codelineno-4-431"></a>
</span><span id="__span-4-432"><a id="__codelineno-4-432" name="__codelineno-4-432" href="#__codelineno-4-432"></a>    <span class="k">for</span> <span class="n">epoch</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">starting_epoch</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">epochs</span><span class="p">):</span>
</span><span id="__span-4-433"><a id="__codelineno-4-433" name="__codelineno-4-433" href="#__codelineno-4-433"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Starting epoch </span><span class="si">{</span><span class="n">epoch</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">args</span><span class="o">.</span><span class="n">epochs</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-4-434"><a id="__codelineno-4-434" name="__codelineno-4-434" href="#__codelineno-4-434"></a>        <span class="c1"># Important so each epoch uses a different ordering for the training samples.</span>
</span><span id="__span-4-435"><a id="__codelineno-4-435" name="__codelineno-4-435" href="#__codelineno-4-435"></a>        <span class="n">train_sampler</span><span class="o">.</span><span class="n">set_epoch</span><span class="p">(</span><span class="n">epoch</span><span class="p">)</span>
</span><span id="__span-4-436"><a id="__codelineno-4-436" name="__codelineno-4-436" href="#__codelineno-4-436"></a>        <span class="n">model</span><span class="o">.</span><span class="n">train</span><span class="p">()</span>
</span><span id="__span-4-437"><a id="__codelineno-4-437" name="__codelineno-4-437" href="#__codelineno-4-437"></a>
</span><span id="__span-4-438"><a id="__codelineno-4-438" name="__codelineno-4-438" href="#__codelineno-4-438"></a>        <span class="c1"># Using a progress bar when in an interactive terminal. It also shows the throughput in samples/second.</span>
</span><span id="__span-4-439"><a id="__codelineno-4-439" name="__codelineno-4-439" href="#__codelineno-4-439"></a>        <span class="c1"># If we&#39;re going to enable verbose logging within an epoch (for example to help identify issues),</span>
</span><span id="__span-4-440"><a id="__codelineno-4-440" name="__codelineno-4-440" href="#__codelineno-4-440"></a>        <span class="c1"># it makes sense to use the progress bar from rich so that the logs are displayed nicely.</span>
</span><span id="__span-4-441"><a id="__codelineno-4-441" name="__codelineno-4-441" href="#__codelineno-4-441"></a>        <span class="c1"># However, it doesn&#39;t support the `unit_scale` and `unit` arguments atm so we disable those arguments.</span>
</span><span id="__span-4-442"><a id="__codelineno-4-442" name="__codelineno-4-442" href="#__codelineno-4-442"></a>        <span class="n">pbar_type</span> <span class="o">=</span> <span class="n">tqdm</span><span class="o">.</span><span class="n">rich</span><span class="o">.</span><span class="n">tqdm_rich</span> <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">verbose</span> <span class="o">&gt;=</span> <span class="mi">2</span> <span class="k">else</span> <span class="n">tqdm</span><span class="o">.</span><span class="n">tqdm</span>
</span><span id="__span-4-443"><a id="__codelineno-4-443" name="__codelineno-4-443" href="#__codelineno-4-443"></a>        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">train_dataloader</span><span class="o">.</span><span class="n">batch_size</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span>
</span><span id="__span-4-444"><a id="__codelineno-4-444" name="__codelineno-4-444" href="#__codelineno-4-444"></a>        <span class="n">progress_bar</span> <span class="o">=</span> <span class="n">pbar_type</span><span class="p">(</span>
</span><span id="__span-4-445"><a id="__codelineno-4-445" name="__codelineno-4-445" href="#__codelineno-4-445"></a>            <span class="n">train_dataloader</span><span class="p">,</span>
</span><span id="__span-4-446"><a id="__codelineno-4-446" name="__codelineno-4-446" href="#__codelineno-4-446"></a>            <span class="n">desc</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Train epoch </span><span class="si">{</span><span class="n">epoch</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">args</span><span class="o">.</span><span class="n">epochs</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span id="__span-4-447"><a id="__codelineno-4-447" name="__codelineno-4-447" href="#__codelineno-4-447"></a>            <span class="c1"># Don&#39;t use a progress bar if outputting to a slurm output file or when not in task 0</span>
</span><span id="__span-4-448"><a id="__codelineno-4-448" name="__codelineno-4-448" href="#__codelineno-4-448"></a>            <span class="n">disable</span><span class="o">=</span><span class="p">(</span><span class="ow">not</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">isatty</span><span class="p">()</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">is_master</span><span class="p">),</span>
</span><span id="__span-4-449"><a id="__codelineno-4-449" name="__codelineno-4-449" href="#__codelineno-4-449"></a>            <span class="n">unit_scale</span><span class="o">=</span><span class="kc">False</span> <span class="k">if</span> <span class="n">pbar_type</span> <span class="ow">is</span> <span class="n">tqdm</span><span class="o">.</span><span class="n">rich</span><span class="o">.</span><span class="n">tqdm_rich</span> <span class="k">else</span> <span class="n">effective_batch_size</span><span class="p">,</span>
</span><span id="__span-4-450"><a id="__codelineno-4-450" name="__codelineno-4-450" href="#__codelineno-4-450"></a>            <span class="n">unit</span><span class="o">=</span><span class="s2">&quot;batches&quot;</span> <span class="k">if</span> <span class="n">pbar_type</span> <span class="ow">is</span> <span class="n">tqdm</span><span class="o">.</span><span class="n">rich</span><span class="o">.</span><span class="n">tqdm_rich</span> <span class="k">else</span> <span class="s2">&quot;samples&quot;</span><span class="p">,</span>
</span><span id="__span-4-451"><a id="__codelineno-4-451" name="__codelineno-4-451" href="#__codelineno-4-451"></a>            <span class="n">dynamic_ncols</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>  <span class="c1"># allow window resizing</span>
</span><span id="__span-4-452"><a id="__codelineno-4-452" name="__codelineno-4-452" href="#__codelineno-4-452"></a>        <span class="p">)</span>
</span><span id="__span-4-453"><a id="__codelineno-4-453" name="__codelineno-4-453" href="#__codelineno-4-453"></a>        <span class="n">data_transfer_cuda_stream</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">Stream</span><span class="p">(</span><span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
</span><span id="__span-4-454"><a id="__codelineno-4-454" name="__codelineno-4-454" href="#__codelineno-4-454"></a>        <span class="n">epoch_loss</span> <span class="o">=</span> <span class="mf">0.0</span>
</span><span id="__span-4-455"><a id="__codelineno-4-455" name="__codelineno-4-455" href="#__codelineno-4-455"></a>        <span class="n">t</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span>
</span><span id="__span-4-456"><a id="__codelineno-4-456" name="__codelineno-4-456" href="#__codelineno-4-456"></a>        <span class="k">for</span> <span class="n">batch_index</span><span class="p">,</span> <span class="n">batch</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span>
</span><span id="__span-4-457"><a id="__codelineno-4-457" name="__codelineno-4-457" href="#__codelineno-4-457"></a>            <span class="c1"># We only create the profiling traces in the first two epochs.</span>
</span><span id="__span-4-458"><a id="__codelineno-4-458" name="__codelineno-4-458" href="#__codelineno-4-458"></a>            <span class="n">profile_loop</span><span class="p">(</span><span class="n">progress_bar</span><span class="p">,</span> <span class="n">profiler</span><span class="p">)</span> <span class="k">if</span> <span class="n">epoch</span> <span class="o">&lt;=</span> <span class="mi">1</span> <span class="k">else</span> <span class="n">progress_bar</span>
</span><span id="__span-4-459"><a id="__codelineno-4-459" name="__codelineno-4-459" href="#__codelineno-4-459"></a>        <span class="p">):</span>
</span><span id="__span-4-460"><a id="__codelineno-4-460" name="__codelineno-4-460" href="#__codelineno-4-460"></a>            <span class="c1"># This allows the GPU to keep working on the previous step while the data is copied from CPU to GPU!</span>
</span><span id="__span-4-461"><a id="__codelineno-4-461" name="__codelineno-4-461" href="#__codelineno-4-461"></a>            <span class="c1"># https://docs.pytorch.org/tutorials/intermediate/pinmem_nonblock.html</span>
</span><span id="__span-4-462"><a id="__codelineno-4-462" name="__codelineno-4-462" href="#__codelineno-4-462"></a>            <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">stream</span><span class="p">(</span><span class="n">data_transfer_cuda_stream</span><span class="p">):</span>
</span><span id="__span-4-463"><a id="__codelineno-4-463" name="__codelineno-4-463" href="#__codelineno-4-463"></a>                <span class="c1"># Move the batch to the GPU before we pass it to the model</span>
</span><span id="__span-4-464"><a id="__codelineno-4-464" name="__codelineno-4-464" href="#__codelineno-4-464"></a>                <span class="n">batch</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="n">non_blocking</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">batch</span><span class="p">)</span>
</span><span id="__span-4-465"><a id="__codelineno-4-465" name="__codelineno-4-465" href="#__codelineno-4-465"></a>                <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">batch</span>
</span><span id="__span-4-466"><a id="__codelineno-4-466" name="__codelineno-4-466" href="#__codelineno-4-466"></a>
</span><span id="__span-4-467"><a id="__codelineno-4-467" name="__codelineno-4-467" href="#__codelineno-4-467"></a>            <span class="n">loss</span><span class="p">,</span> <span class="n">accuracy</span><span class="p">,</span> <span class="n">n_samples</span> <span class="o">=</span> <span class="n">training_step</span><span class="p">(</span>
</span><span id="__span-4-468"><a id="__codelineno-4-468" name="__codelineno-4-468" href="#__codelineno-4-468"></a>                <span class="n">model</span><span class="p">,</span>
</span><span id="__span-4-469"><a id="__codelineno-4-469" name="__codelineno-4-469" href="#__codelineno-4-469"></a>                <span class="n">x</span><span class="p">,</span>
</span><span id="__span-4-470"><a id="__codelineno-4-470" name="__codelineno-4-470" href="#__codelineno-4-470"></a>                <span class="n">y</span><span class="p">,</span>
</span><span id="__span-4-471"><a id="__codelineno-4-471" name="__codelineno-4-471" href="#__codelineno-4-471"></a>                <span class="n">optimizer</span><span class="p">,</span>
</span><span id="__span-4-472"><a id="__codelineno-4-472" name="__codelineno-4-472" href="#__codelineno-4-472"></a>                <span class="n">scaler</span><span class="o">=</span><span class="n">scaler</span><span class="p">,</span>
</span><span id="__span-4-473"><a id="__codelineno-4-473" name="__codelineno-4-473" href="#__codelineno-4-473"></a>                <span class="n">batch_index</span><span class="o">=</span><span class="n">batch_index</span><span class="p">,</span>
</span><span id="__span-4-474"><a id="__codelineno-4-474" name="__codelineno-4-474" href="#__codelineno-4-474"></a>            <span class="p">)</span>
</span><span id="__span-4-475"><a id="__codelineno-4-475" name="__codelineno-4-475" href="#__codelineno-4-475"></a>
</span><span id="__span-4-476"><a id="__codelineno-4-476" name="__codelineno-4-476" href="#__codelineno-4-476"></a>            <span class="n">epoch_loss</span> <span class="o">+=</span> <span class="n">loss</span>
</span><span id="__span-4-477"><a id="__codelineno-4-477" name="__codelineno-4-477" href="#__codelineno-4-477"></a>            <span class="n">total_updates</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="__span-4-478"><a id="__codelineno-4-478" name="__codelineno-4-478" href="#__codelineno-4-478"></a>            <span class="n">total_samples</span> <span class="o">+=</span> <span class="n">n_samples</span>
</span><span id="__span-4-479"><a id="__codelineno-4-479" name="__codelineno-4-479" href="#__codelineno-4-479"></a>
</span><span id="__span-4-480"><a id="__codelineno-4-480" name="__codelineno-4-480" href="#__codelineno-4-480"></a>            <span class="c1"># Simple training speed calculation in samples/sec using the effective batch size.</span>
</span><span id="__span-4-481"><a id="__codelineno-4-481" name="__codelineno-4-481" href="#__codelineno-4-481"></a>            <span class="n">new_t</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span>
</span><span id="__span-4-482"><a id="__codelineno-4-482" name="__codelineno-4-482" href="#__codelineno-4-482"></a>            <span class="n">dt</span> <span class="o">=</span> <span class="n">new_t</span> <span class="o">-</span> <span class="n">t</span>
</span><span id="__span-4-483"><a id="__codelineno-4-483" name="__codelineno-4-483" href="#__codelineno-4-483"></a>            <span class="n">samples_per_sec</span> <span class="o">=</span> <span class="n">n_samples</span> <span class="o">/</span> <span class="n">dt</span>
</span><span id="__span-4-484"><a id="__codelineno-4-484" name="__codelineno-4-484" href="#__codelineno-4-484"></a>            <span class="n">t</span> <span class="o">=</span> <span class="n">new_t</span>
</span><span id="__span-4-485"><a id="__codelineno-4-485" name="__codelineno-4-485" href="#__codelineno-4-485"></a>
</span><span id="__span-4-486"><a id="__codelineno-4-486" name="__codelineno-4-486" href="#__codelineno-4-486"></a>            <span class="c1"># Move the tensors to CPU so we can log them in the progress bar and to wandb.</span>
</span><span id="__span-4-487"><a id="__codelineno-4-487" name="__codelineno-4-487" href="#__codelineno-4-487"></a>            <span class="c1"># Perform some logging, but only on the first task, and only every `logging_interval` batches.</span>
</span><span id="__span-4-488"><a id="__codelineno-4-488" name="__codelineno-4-488" href="#__codelineno-4-488"></a>            <span class="c1"># Also only do this if wandb logging is enabled or if the progress bar is enabled.</span>
</span><span id="__span-4-489"><a id="__codelineno-4-489" name="__codelineno-4-489" href="#__codelineno-4-489"></a>            <span class="k">if</span> <span class="p">(</span>
</span><span id="__span-4-490"><a id="__codelineno-4-490" name="__codelineno-4-490" href="#__codelineno-4-490"></a>                <span class="n">is_master</span>
</span><span id="__span-4-491"><a id="__codelineno-4-491" name="__codelineno-4-491" href="#__codelineno-4-491"></a>                <span class="ow">and</span> <span class="p">((</span><span class="n">wandb</span><span class="o">.</span><span class="n">run</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">wandb</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">disabled</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="ow">not</span> <span class="n">progress_bar</span><span class="o">.</span><span class="n">disable</span><span class="p">))</span>
</span><span id="__span-4-492"><a id="__codelineno-4-492" name="__codelineno-4-492" href="#__codelineno-4-492"></a>                <span class="ow">and</span> <span class="p">(</span><span class="n">batch_index</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="p">((</span><span class="n">batch_index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">args</span><span class="o">.</span><span class="n">logging_interval</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
</span><span id="__span-4-493"><a id="__codelineno-4-493" name="__codelineno-4-493" href="#__codelineno-4-493"></a>            <span class="p">):</span>
</span><span id="__span-4-494"><a id="__codelineno-4-494" name="__codelineno-4-494" href="#__codelineno-4-494"></a>                <span class="c1"># TODO: if --limit_train_samples=100_000, the logs in wandb have their last logged metrics</span>
</span><span id="__span-4-495"><a id="__codelineno-4-495" name="__codelineno-4-495" href="#__codelineno-4-495"></a>                <span class="c1"># at samples=89_600 (7(updates) * 50(log interval) * 256(batch_size)). It would be nice to</span>
</span><span id="__span-4-496"><a id="__codelineno-4-496" name="__codelineno-4-496" href="#__codelineno-4-496"></a>                <span class="c1"># also log metrics at the last batch (when we reach the limit_num_steps) even if batch_index</span>
</span><span id="__span-4-497"><a id="__codelineno-4-497" name="__codelineno-4-497" href="#__codelineno-4-497"></a>                <span class="c1"># isnt a multiple of logging interval.</span>
</span><span id="__span-4-498"><a id="__codelineno-4-498" name="__codelineno-4-498" href="#__codelineno-4-498"></a>
</span><span id="__span-4-499"><a id="__codelineno-4-499" name="__codelineno-4-499" href="#__codelineno-4-499"></a>                <span class="n">_loss</span> <span class="o">=</span> <span class="n">loss</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
</span><span id="__span-4-500"><a id="__codelineno-4-500" name="__codelineno-4-500" href="#__codelineno-4-500"></a>                <span class="n">_accuracy</span> <span class="o">=</span> <span class="n">accuracy</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
</span><span id="__span-4-501"><a id="__codelineno-4-501" name="__codelineno-4-501" href="#__codelineno-4-501"></a>                <span class="n">progress_bar</span><span class="o">.</span><span class="n">set_postfix</span><span class="p">(</span><span class="n">loss</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">_loss</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">accuracy</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">_accuracy</span><span class="si">:</span><span class="s2">.2%</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-4-502"><a id="__codelineno-4-502" name="__codelineno-4-502" href="#__codelineno-4-502"></a>                <span class="n">wandb</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
</span><span id="__span-4-503"><a id="__codelineno-4-503" name="__codelineno-4-503" href="#__codelineno-4-503"></a>                    <span class="p">{</span>
</span><span id="__span-4-504"><a id="__codelineno-4-504" name="__codelineno-4-504" href="#__codelineno-4-504"></a>                        <span class="s2">&quot;train/loss&quot;</span><span class="p">:</span> <span class="n">_loss</span><span class="p">,</span>
</span><span id="__span-4-505"><a id="__codelineno-4-505" name="__codelineno-4-505" href="#__codelineno-4-505"></a>                        <span class="s2">&quot;train/accuracy&quot;</span><span class="p">:</span> <span class="n">_accuracy</span><span class="p">,</span>
</span><span id="__span-4-506"><a id="__codelineno-4-506" name="__codelineno-4-506" href="#__codelineno-4-506"></a>                        <span class="s2">&quot;train/samples_per_sec&quot;</span><span class="p">:</span> <span class="n">samples_per_sec</span><span class="p">,</span>
</span><span id="__span-4-507"><a id="__codelineno-4-507" name="__codelineno-4-507" href="#__codelineno-4-507"></a>                        <span class="s2">&quot;epoch&quot;</span><span class="p">:</span> <span class="n">epoch</span><span class="p">,</span>
</span><span id="__span-4-508"><a id="__codelineno-4-508" name="__codelineno-4-508" href="#__codelineno-4-508"></a>                        <span class="s2">&quot;updates&quot;</span><span class="p">:</span> <span class="n">total_updates</span><span class="p">,</span>
</span><span id="__span-4-509"><a id="__codelineno-4-509" name="__codelineno-4-509" href="#__codelineno-4-509"></a>                        <span class="s2">&quot;samples&quot;</span><span class="p">:</span> <span class="n">total_samples</span><span class="p">,</span>
</span><span id="__span-4-510"><a id="__codelineno-4-510" name="__codelineno-4-510" href="#__codelineno-4-510"></a>                    <span class="p">}</span>
</span><span id="__span-4-511"><a id="__codelineno-4-511" name="__codelineno-4-511" href="#__codelineno-4-511"></a>                <span class="p">)</span>
</span><span id="__span-4-512"><a id="__codelineno-4-512" name="__codelineno-4-512" href="#__codelineno-4-512"></a>        <span class="n">progress_bar</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span><span id="__span-4-513"><a id="__codelineno-4-513" name="__codelineno-4-513" href="#__codelineno-4-513"></a>
</span><span id="__span-4-514"><a id="__codelineno-4-514" name="__codelineno-4-514" href="#__codelineno-4-514"></a>        <span class="n">t</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span>
</span><span id="__span-4-515"><a id="__codelineno-4-515" name="__codelineno-4-515" href="#__codelineno-4-515"></a>        <span class="n">val_loss</span><span class="p">,</span> <span class="n">val_accuracy</span><span class="p">,</span> <span class="n">val_samples</span> <span class="o">=</span> <span class="n">validation_loop</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">valid_dataloader</span><span class="p">,</span> <span class="n">device</span><span class="p">)</span>
</span><span id="__span-4-516"><a id="__codelineno-4-516" name="__codelineno-4-516" href="#__codelineno-4-516"></a>        <span class="n">dt</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span> <span class="o">-</span> <span class="n">t</span>
</span><span id="__span-4-517"><a id="__codelineno-4-517" name="__codelineno-4-517" href="#__codelineno-4-517"></a>        <span class="n">val_sps</span> <span class="o">=</span> <span class="n">val_samples</span> <span class="o">/</span> <span class="n">dt</span>
</span><span id="__span-4-518"><a id="__codelineno-4-518" name="__codelineno-4-518" href="#__codelineno-4-518"></a>        <span class="k">if</span> <span class="n">RANK</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="__span-4-519"><a id="__codelineno-4-519" name="__codelineno-4-519" href="#__codelineno-4-519"></a>            <span class="n">rich</span><span class="o">.</span><span class="n">print</span><span class="p">(</span>
</span><span id="__span-4-520"><a id="__codelineno-4-520" name="__codelineno-4-520" href="#__codelineno-4-520"></a>                <span class="sa">f</span><span class="s2">&quot;Epoch </span><span class="si">{</span><span class="n">epoch</span><span class="si">}</span><span class="s2">: Val loss: </span><span class="si">{</span><span class="n">val_loss</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> accuracy: </span><span class="si">{</span><span class="n">val_accuracy</span><span class="si">:</span><span class="s2">.2%</span><span class="si">}</span><span class="s2"> samples/sec: </span><span class="si">{</span><span class="n">val_sps</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="__span-4-521"><a id="__codelineno-4-521" name="__codelineno-4-521" href="#__codelineno-4-521"></a>            <span class="p">)</span>
</span><span id="__span-4-522"><a id="__codelineno-4-522" name="__codelineno-4-522" href="#__codelineno-4-522"></a>        <span class="n">wandb</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
</span><span id="__span-4-523"><a id="__codelineno-4-523" name="__codelineno-4-523" href="#__codelineno-4-523"></a>            <span class="p">{</span>
</span><span id="__span-4-524"><a id="__codelineno-4-524" name="__codelineno-4-524" href="#__codelineno-4-524"></a>                <span class="s2">&quot;val/loss&quot;</span><span class="p">:</span> <span class="n">val_loss</span><span class="p">,</span>
</span><span id="__span-4-525"><a id="__codelineno-4-525" name="__codelineno-4-525" href="#__codelineno-4-525"></a>                <span class="s2">&quot;val/accuracy&quot;</span><span class="p">:</span> <span class="n">val_accuracy</span><span class="p">,</span>
</span><span id="__span-4-526"><a id="__codelineno-4-526" name="__codelineno-4-526" href="#__codelineno-4-526"></a>                <span class="s2">&quot;val/samples_per_sec&quot;</span><span class="p">:</span> <span class="n">val_sps</span><span class="p">,</span>
</span><span id="__span-4-527"><a id="__codelineno-4-527" name="__codelineno-4-527" href="#__codelineno-4-527"></a>                <span class="s2">&quot;epoch&quot;</span><span class="p">:</span> <span class="n">epoch</span><span class="p">,</span>
</span><span id="__span-4-528"><a id="__codelineno-4-528" name="__codelineno-4-528" href="#__codelineno-4-528"></a>            <span class="p">}</span>
</span><span id="__span-4-529"><a id="__codelineno-4-529" name="__codelineno-4-529" href="#__codelineno-4-529"></a>        <span class="p">)</span>
</span><span id="__span-4-530"><a id="__codelineno-4-530" name="__codelineno-4-530" href="#__codelineno-4-530"></a>
</span><span id="__span-4-531"><a id="__codelineno-4-531" name="__codelineno-4-531" href="#__codelineno-4-531"></a>        <span class="c1"># Only save the checkpoint from the master process.</span>
</span><span id="__span-4-532"><a id="__codelineno-4-532" name="__codelineno-4-532" href="#__codelineno-4-532"></a>        <span class="c1"># Make sure this doesn&#39;t cause a torch.distributed.timeout if it takes too long.</span>
</span><span id="__span-4-533"><a id="__codelineno-4-533" name="__codelineno-4-533" href="#__codelineno-4-533"></a>        <span class="k">if</span> <span class="n">is_master</span> <span class="ow">and</span> <span class="p">(</span><span class="n">epoch</span> <span class="o">%</span> <span class="n">args</span><span class="o">.</span><span class="n">checkpoint_interval_epochs</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="__span-4-534"><a id="__codelineno-4-534" name="__codelineno-4-534" href="#__codelineno-4-534"></a>            <span class="c1"># save as epoch_1 after having done 1 epoch of training.</span>
</span><span id="__span-4-535"><a id="__codelineno-4-535" name="__codelineno-4-535" href="#__codelineno-4-535"></a>            <span class="n">save_checkpoint</span><span class="p">(</span>
</span><span id="__span-4-536"><a id="__codelineno-4-536" name="__codelineno-4-536" href="#__codelineno-4-536"></a>                <span class="n">checkpoint_path</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">checkpoint_dir</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;epoch_</span><span class="si">{</span><span class="n">epoch</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2">.pt&quot;</span><span class="p">,</span>
</span><span id="__span-4-537"><a id="__codelineno-4-537" name="__codelineno-4-537" href="#__codelineno-4-537"></a>                <span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">,</span>
</span><span id="__span-4-538"><a id="__codelineno-4-538" name="__codelineno-4-538" href="#__codelineno-4-538"></a>                <span class="n">optimizer</span><span class="o">=</span><span class="n">optimizer</span><span class="p">,</span>
</span><span id="__span-4-539"><a id="__codelineno-4-539" name="__codelineno-4-539" href="#__codelineno-4-539"></a>                <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">,</span>
</span><span id="__span-4-540"><a id="__codelineno-4-540" name="__codelineno-4-540" href="#__codelineno-4-540"></a>                <span class="n">epoch</span><span class="o">=</span><span class="n">epoch</span><span class="p">,</span>
</span><span id="__span-4-541"><a id="__codelineno-4-541" name="__codelineno-4-541" href="#__codelineno-4-541"></a>                <span class="n">step</span><span class="o">=</span><span class="n">total_updates</span><span class="p">,</span>
</span><span id="__span-4-542"><a id="__codelineno-4-542" name="__codelineno-4-542" href="#__codelineno-4-542"></a>                <span class="n">num_samples</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">total_samples</span><span class="p">),</span>
</span><span id="__span-4-543"><a id="__codelineno-4-543" name="__codelineno-4-543" href="#__codelineno-4-543"></a>            <span class="p">)</span>
</span><span id="__span-4-544"><a id="__codelineno-4-544" name="__codelineno-4-544" href="#__codelineno-4-544"></a>
</span><span id="__span-4-545"><a id="__codelineno-4-545" name="__codelineno-4-545" href="#__codelineno-4-545"></a>    <span class="n">torch</span><span class="o">.</span><span class="n">distributed</span><span class="o">.</span><span class="n">destroy_process_group</span><span class="p">()</span>
</span><span id="__span-4-546"><a id="__codelineno-4-546" name="__codelineno-4-546" href="#__codelineno-4-546"></a>    <span class="n">total_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">t0</span>
</span><span id="__span-4-547"><a id="__codelineno-4-547" name="__codelineno-4-547" href="#__codelineno-4-547"></a>    <span class="n">overall_samples</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">total_samples</span><span class="p">)</span> <span class="o">-</span> <span class="n">starting_num_samples</span>
</span><span id="__span-4-548"><a id="__codelineno-4-548" name="__codelineno-4-548" href="#__codelineno-4-548"></a>    <span class="n">overall_sps</span> <span class="o">=</span> <span class="n">overall_samples</span> <span class="o">/</span> <span class="n">total_time</span>
</span><span id="__span-4-549"><a id="__codelineno-4-549" name="__codelineno-4-549" href="#__codelineno-4-549"></a>    <span class="k">if</span> <span class="n">wandb</span><span class="o">.</span><span class="n">run</span><span class="p">:</span>
</span><span id="__span-4-550"><a id="__codelineno-4-550" name="__codelineno-4-550" href="#__codelineno-4-550"></a>        <span class="n">wandb</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">summary</span><span class="p">[</span><span class="s2">&quot;overall_train_samples_per_sec&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">overall_sps</span>
</span><span id="__span-4-551"><a id="__codelineno-4-551" name="__codelineno-4-551" href="#__codelineno-4-551"></a>        <span class="n">wandb</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">finish</span><span class="p">()</span>
</span><span id="__span-4-552"><a id="__codelineno-4-552" name="__codelineno-4-552" href="#__codelineno-4-552"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Done in </span><span class="si">{</span><span class="n">total_time</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2"> seconds, with </span><span class="si">{</span><span class="n">overall_sps</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2"> images/second&quot;</span><span class="p">)</span>
</span><span id="__span-4-553"><a id="__codelineno-4-553" name="__codelineno-4-553" href="#__codelineno-4-553"></a>
</span><span id="__span-4-554"><a id="__codelineno-4-554" name="__codelineno-4-554" href="#__codelineno-4-554"></a>
</span><span id="__span-4-555"><a id="__codelineno-4-555" name="__codelineno-4-555" href="#__codelineno-4-555"></a><span class="k">def</span><span class="w"> </span><span class="nf">training_step</span><span class="p">(</span>
</span><span id="__span-4-556"><a id="__codelineno-4-556" name="__codelineno-4-556" href="#__codelineno-4-556"></a>    <span class="n">model</span><span class="p">:</span> <span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">,</span>
</span><span id="__span-4-557"><a id="__codelineno-4-557" name="__codelineno-4-557" href="#__codelineno-4-557"></a>    <span class="n">x</span><span class="p">:</span> <span class="n">Tensor</span><span class="p">,</span>
</span><span id="__span-4-558"><a id="__codelineno-4-558" name="__codelineno-4-558" href="#__codelineno-4-558"></a>    <span class="n">y</span><span class="p">:</span> <span class="n">Tensor</span><span class="p">,</span>
</span><span id="__span-4-559"><a id="__codelineno-4-559" name="__codelineno-4-559" href="#__codelineno-4-559"></a>    <span class="n">optimizer</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">Optimizer</span><span class="p">,</span>
</span><span id="__span-4-560"><a id="__codelineno-4-560" name="__codelineno-4-560" href="#__codelineno-4-560"></a>    <span class="n">scaler</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">amp</span><span class="o">.</span><span class="n">grad_scaler</span><span class="o">.</span><span class="n">GradScaler</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="__span-4-561"><a id="__codelineno-4-561" name="__codelineno-4-561" href="#__codelineno-4-561"></a>    <span class="n">batch_index</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="__span-4-562"><a id="__codelineno-4-562" name="__codelineno-4-562" href="#__codelineno-4-562"></a><span class="p">):</span>
</span><span id="__span-4-563"><a id="__codelineno-4-563" name="__codelineno-4-563" href="#__codelineno-4-563"></a>    <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">autocast</span><span class="p">(</span>
</span><span id="__span-4-564"><a id="__codelineno-4-564" name="__codelineno-4-564" href="#__codelineno-4-564"></a>        <span class="n">device_type</span><span class="o">=</span><span class="s2">&quot;cuda&quot;</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">bfloat16</span><span class="p">,</span> <span class="n">enabled</span><span class="o">=</span><span class="n">scaler</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">scaler</span><span class="o">.</span><span class="n">is_enabled</span><span class="p">()</span>
</span><span id="__span-4-565"><a id="__codelineno-4-565" name="__codelineno-4-565" href="#__codelineno-4-565"></a>    <span class="p">):</span>
</span><span id="__span-4-566"><a id="__codelineno-4-566" name="__codelineno-4-566" href="#__codelineno-4-566"></a>        <span class="c1"># Forward pass</span>
</span><span id="__span-4-567"><a id="__codelineno-4-567" name="__codelineno-4-567" href="#__codelineno-4-567"></a>        <span class="n">logits</span><span class="p">:</span> <span class="n">Tensor</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
</span><span id="__span-4-568"><a id="__codelineno-4-568" name="__codelineno-4-568" href="#__codelineno-4-568"></a>
</span><span id="__span-4-569"><a id="__codelineno-4-569" name="__codelineno-4-569" href="#__codelineno-4-569"></a>        <span class="n">local_loss</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">cross_entropy</span><span class="p">(</span><span class="n">logits</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">reduction</span><span class="o">=</span><span class="s2">&quot;mean&quot;</span><span class="p">)</span>
</span><span id="__span-4-570"><a id="__codelineno-4-570" name="__codelineno-4-570" href="#__codelineno-4-570"></a>
</span><span id="__span-4-571"><a id="__codelineno-4-571" name="__codelineno-4-571" href="#__codelineno-4-571"></a>    <span class="k">if</span> <span class="n">scaler</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="__span-4-572"><a id="__codelineno-4-572" name="__codelineno-4-572" href="#__codelineno-4-572"></a>        <span class="c1"># https://docs.pytorch.org/tutorials/recipes/recipes/amp_recipe.html#all-together-automatic-mixed-precision</span>
</span><span id="__span-4-573"><a id="__codelineno-4-573" name="__codelineno-4-573" href="#__codelineno-4-573"></a>        <span class="n">scaler</span><span class="o">.</span><span class="n">scale</span><span class="p">(</span><span class="n">local_loss</span><span class="p">)</span><span class="o">.</span><span class="n">backward</span><span class="p">()</span>
</span><span id="__span-4-574"><a id="__codelineno-4-574" name="__codelineno-4-574" href="#__codelineno-4-574"></a>        <span class="n">scaler</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="n">optimizer</span><span class="p">)</span>
</span><span id="__span-4-575"><a id="__codelineno-4-575" name="__codelineno-4-575" href="#__codelineno-4-575"></a>        <span class="n">scaler</span><span class="o">.</span><span class="n">update</span><span class="p">()</span>
</span><span id="__span-4-576"><a id="__codelineno-4-576" name="__codelineno-4-576" href="#__codelineno-4-576"></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="__span-4-577"><a id="__codelineno-4-577" name="__codelineno-4-577" href="#__codelineno-4-577"></a>        <span class="c1"># nn.DistributedDataParallel automatically averages the gradients across devices.</span>
</span><span id="__span-4-578"><a id="__codelineno-4-578" name="__codelineno-4-578" href="#__codelineno-4-578"></a>        <span class="n">local_loss</span><span class="o">.</span><span class="n">backward</span><span class="p">()</span>
</span><span id="__span-4-579"><a id="__codelineno-4-579" name="__codelineno-4-579" href="#__codelineno-4-579"></a>        <span class="n">optimizer</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>
</span><span id="__span-4-580"><a id="__codelineno-4-580" name="__codelineno-4-580" href="#__codelineno-4-580"></a>    <span class="n">optimizer</span><span class="o">.</span><span class="n">zero_grad</span><span class="p">()</span>
</span><span id="__span-4-581"><a id="__codelineno-4-581" name="__codelineno-4-581" href="#__codelineno-4-581"></a>
</span><span id="__span-4-582"><a id="__codelineno-4-582" name="__codelineno-4-582" href="#__codelineno-4-582"></a>    <span class="c1"># Calculate some metrics</span>
</span><span id="__span-4-583"><a id="__codelineno-4-583" name="__codelineno-4-583" href="#__codelineno-4-583"></a>
</span><span id="__span-4-584"><a id="__codelineno-4-584" name="__codelineno-4-584" href="#__codelineno-4-584"></a>    <span class="c1"># local metrics calculated with the tensors on the current GPU.</span>
</span><span id="__span-4-585"><a id="__codelineno-4-585" name="__codelineno-4-585" href="#__codelineno-4-585"></a>    <span class="n">local_n_correct_predictions</span> <span class="o">=</span> <span class="n">logits</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">eq</span><span class="p">(</span><span class="n">y</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
</span><span id="__span-4-586"><a id="__codelineno-4-586" name="__codelineno-4-586" href="#__codelineno-4-586"></a>    <span class="n">local_n_samples</span> <span class="o">=</span> <span class="n">logits</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="__span-4-587"><a id="__codelineno-4-587" name="__codelineno-4-587" href="#__codelineno-4-587"></a>    <span class="n">local_accuracy</span> <span class="o">=</span> <span class="n">local_n_correct_predictions</span> <span class="o">/</span> <span class="n">local_n_samples</span>
</span><span id="__span-4-588"><a id="__codelineno-4-588" name="__codelineno-4-588" href="#__codelineno-4-588"></a>
</span><span id="__span-4-589"><a id="__codelineno-4-589" name="__codelineno-4-589" href="#__codelineno-4-589"></a>    <span class="c1"># Global metrics calculated with the results from all workers</span>
</span><span id="__span-4-590"><a id="__codelineno-4-590" name="__codelineno-4-590" href="#__codelineno-4-590"></a>    <span class="c1"># Creating new tensors to hold the &quot;global&quot; values, but this isn&#39;t required.</span>
</span><span id="__span-4-591"><a id="__codelineno-4-591" name="__codelineno-4-591" href="#__codelineno-4-591"></a>    <span class="c1"># Reduce the local metrics across all workers, sending the result to rank 0.</span>
</span><span id="__span-4-592"><a id="__codelineno-4-592" name="__codelineno-4-592" href="#__codelineno-4-592"></a>    <span class="c1"># Summing n_correct and n_samples to get accuracy is resilient to</span>
</span><span id="__span-4-593"><a id="__codelineno-4-593" name="__codelineno-4-593" href="#__codelineno-4-593"></a>    <span class="c1"># workers having different number of samples.</span>
</span><span id="__span-4-594"><a id="__codelineno-4-594" name="__codelineno-4-594" href="#__codelineno-4-594"></a>    <span class="c1"># This could happen if the number of batches is not divisible by the number of batches</span>
</span><span id="__span-4-595"><a id="__codelineno-4-595" name="__codelineno-4-595" href="#__codelineno-4-595"></a>    <span class="c1"># and if the distributed sampler is not set to drop the last incomplete batch.</span>
</span><span id="__span-4-596"><a id="__codelineno-4-596" name="__codelineno-4-596" href="#__codelineno-4-596"></a>    <span class="n">n_correct_predictions</span> <span class="o">=</span> <span class="n">local_n_correct_predictions</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span>
</span><span id="__span-4-597"><a id="__codelineno-4-597" name="__codelineno-4-597" href="#__codelineno-4-597"></a>    <span class="n">n_samples</span> <span class="o">=</span> <span class="n">local_n_samples</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">local_loss</span><span class="o">.</span><span class="n">device</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
</span><span id="__span-4-598"><a id="__codelineno-4-598" name="__codelineno-4-598" href="#__codelineno-4-598"></a>    <span class="n">loss</span> <span class="o">=</span> <span class="n">local_loss</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span>
</span><span id="__span-4-599"><a id="__codelineno-4-599" name="__codelineno-4-599" href="#__codelineno-4-599"></a>
</span><span id="__span-4-600"><a id="__codelineno-4-600" name="__codelineno-4-600" href="#__codelineno-4-600"></a>    <span class="n">torch</span><span class="o">.</span><span class="n">distributed</span><span class="o">.</span><span class="n">reduce</span><span class="p">(</span><span class="n">loss</span><span class="p">,</span> <span class="n">dst</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">op</span><span class="o">=</span><span class="n">ReduceOp</span><span class="o">.</span><span class="n">AVG</span><span class="p">)</span>
</span><span id="__span-4-601"><a id="__codelineno-4-601" name="__codelineno-4-601" href="#__codelineno-4-601"></a>    <span class="n">torch</span><span class="o">.</span><span class="n">distributed</span><span class="o">.</span><span class="n">reduce</span><span class="p">(</span><span class="n">n_correct_predictions</span><span class="p">,</span> <span class="n">dst</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">op</span><span class="o">=</span><span class="n">ReduceOp</span><span class="o">.</span><span class="n">SUM</span><span class="p">)</span>
</span><span id="__span-4-602"><a id="__codelineno-4-602" name="__codelineno-4-602" href="#__codelineno-4-602"></a>    <span class="n">torch</span><span class="o">.</span><span class="n">distributed</span><span class="o">.</span><span class="n">reduce</span><span class="p">(</span><span class="n">n_samples</span><span class="p">,</span> <span class="n">dst</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">op</span><span class="o">=</span><span class="n">ReduceOp</span><span class="o">.</span><span class="n">SUM</span><span class="p">)</span>
</span><span id="__span-4-603"><a id="__codelineno-4-603" name="__codelineno-4-603" href="#__codelineno-4-603"></a>    <span class="n">accuracy</span> <span class="o">=</span> <span class="n">n_correct_predictions</span> <span class="o">/</span> <span class="n">n_samples</span>
</span><span id="__span-4-604"><a id="__codelineno-4-604" name="__codelineno-4-604" href="#__codelineno-4-604"></a>
</span><span id="__span-4-605"><a id="__codelineno-4-605" name="__codelineno-4-605" href="#__codelineno-4-605"></a>    <span class="c1"># Using lazy formatting so these tensors are only moved to cpu when necessary.</span>
</span><span id="__span-4-606"><a id="__codelineno-4-606" name="__codelineno-4-606" href="#__codelineno-4-606"></a>    <span class="k">if</span> <span class="n">RANK</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="__span-4-607"><a id="__codelineno-4-607" name="__codelineno-4-607" href="#__codelineno-4-607"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;(local) Loss: </span><span class="si">%.2f</span><span class="s2"> Accuracy: </span><span class="si">%.2f</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">local_loss</span><span class="p">,</span> <span class="n">local_accuracy</span><span class="p">)</span>
</span><span id="__span-4-608"><a id="__codelineno-4-608" name="__codelineno-4-608" href="#__codelineno-4-608"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Average Loss: </span><span class="si">%.2f</span><span class="s2"> Accuracy: </span><span class="si">%.2%</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">loss</span><span class="p">,</span> <span class="n">accuracy</span><span class="p">)</span>
</span><span id="__span-4-609"><a id="__codelineno-4-609" name="__codelineno-4-609" href="#__codelineno-4-609"></a>    <span class="k">return</span> <span class="n">loss</span><span class="p">,</span> <span class="n">accuracy</span><span class="p">,</span> <span class="n">n_samples</span>
</span><span id="__span-4-610"><a id="__codelineno-4-610" name="__codelineno-4-610" href="#__codelineno-4-610"></a>
</span><span id="__span-4-611"><a id="__codelineno-4-611" name="__codelineno-4-611" href="#__codelineno-4-611"></a>
</span><span id="__span-4-612"><a id="__codelineno-4-612" name="__codelineno-4-612" href="#__codelineno-4-612"></a><span class="nd">@torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">()</span>
</span><span id="__span-4-613"><a id="__codelineno-4-613" name="__codelineno-4-613" href="#__codelineno-4-613"></a><span class="k">def</span><span class="w"> </span><span class="nf">validation_loop</span><span class="p">(</span><span class="n">model</span><span class="p">:</span> <span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">,</span> <span class="n">dataloader</span><span class="p">:</span> <span class="n">DataLoader</span><span class="p">,</span> <span class="n">device</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">):</span>
</span><span id="__span-4-614"><a id="__codelineno-4-614" name="__codelineno-4-614" href="#__codelineno-4-614"></a>    <span class="n">model</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
</span><span id="__span-4-615"><a id="__codelineno-4-615" name="__codelineno-4-615" href="#__codelineno-4-615"></a>
</span><span id="__span-4-616"><a id="__codelineno-4-616" name="__codelineno-4-616" href="#__codelineno-4-616"></a>    <span class="n">epoch_loss</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
</span><span id="__span-4-617"><a id="__codelineno-4-617" name="__codelineno-4-617" href="#__codelineno-4-617"></a>    <span class="n">num_samples</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
</span><span id="__span-4-618"><a id="__codelineno-4-618" name="__codelineno-4-618" href="#__codelineno-4-618"></a>    <span class="n">correct_predictions</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
</span><span id="__span-4-619"><a id="__codelineno-4-619" name="__codelineno-4-619" href="#__codelineno-4-619"></a>    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dataloader</span><span class="o">.</span><span class="n">batch_size</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span>
</span><span id="__span-4-620"><a id="__codelineno-4-620" name="__codelineno-4-620" href="#__codelineno-4-620"></a>
</span><span id="__span-4-621"><a id="__codelineno-4-621" name="__codelineno-4-621" href="#__codelineno-4-621"></a>    <span class="n">progress_bar</span> <span class="o">=</span> <span class="n">tqdm</span><span class="o">.</span><span class="n">tqdm</span><span class="p">(</span>
</span><span id="__span-4-622"><a id="__codelineno-4-622" name="__codelineno-4-622" href="#__codelineno-4-622"></a>        <span class="n">dataloader</span><span class="p">,</span>
</span><span id="__span-4-623"><a id="__codelineno-4-623" name="__codelineno-4-623" href="#__codelineno-4-623"></a>        <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Validation&quot;</span><span class="p">,</span>
</span><span id="__span-4-624"><a id="__codelineno-4-624" name="__codelineno-4-624" href="#__codelineno-4-624"></a>        <span class="n">unit_scale</span><span class="o">=</span><span class="n">dataloader</span><span class="o">.</span><span class="n">batch_size</span> <span class="o">*</span> <span class="n">WORLD_SIZE</span><span class="p">,</span>
</span><span id="__span-4-625"><a id="__codelineno-4-625" name="__codelineno-4-625" href="#__codelineno-4-625"></a>        <span class="n">unit</span><span class="o">=</span><span class="s2">&quot;samples&quot;</span><span class="p">,</span>
</span><span id="__span-4-626"><a id="__codelineno-4-626" name="__codelineno-4-626" href="#__codelineno-4-626"></a>        <span class="c1"># Don&#39;t use a progress bar if outputting to a slurm output file or when not in task 0</span>
</span><span id="__span-4-627"><a id="__codelineno-4-627" name="__codelineno-4-627" href="#__codelineno-4-627"></a>        <span class="n">disable</span><span class="o">=</span><span class="p">(</span><span class="ow">not</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">isatty</span><span class="p">()</span> <span class="ow">or</span> <span class="n">RANK</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">),</span>
</span><span id="__span-4-628"><a id="__codelineno-4-628" name="__codelineno-4-628" href="#__codelineno-4-628"></a>    <span class="p">)</span>
</span><span id="__span-4-629"><a id="__codelineno-4-629" name="__codelineno-4-629" href="#__codelineno-4-629"></a>    <span class="c1"># NOTE: Because of DDP and distributed sampler, the last batch might have repeated samples,</span>
</span><span id="__span-4-630"><a id="__codelineno-4-630" name="__codelineno-4-630" href="#__codelineno-4-630"></a>    <span class="c1"># leading to slightly imprecise metrics.</span>
</span><span id="__span-4-631"><a id="__codelineno-4-631" name="__codelineno-4-631" href="#__codelineno-4-631"></a>    <span class="k">for</span> <span class="n">batch</span> <span class="ow">in</span> <span class="n">progress_bar</span><span class="p">:</span>
</span><span id="__span-4-632"><a id="__codelineno-4-632" name="__codelineno-4-632" href="#__codelineno-4-632"></a>        <span class="n">batch</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">batch</span><span class="p">)</span>
</span><span id="__span-4-633"><a id="__codelineno-4-633" name="__codelineno-4-633" href="#__codelineno-4-633"></a>        <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">batch</span>
</span><span id="__span-4-634"><a id="__codelineno-4-634" name="__codelineno-4-634" href="#__codelineno-4-634"></a>
</span><span id="__span-4-635"><a id="__codelineno-4-635" name="__codelineno-4-635" href="#__codelineno-4-635"></a>        <span class="n">logits</span><span class="p">:</span> <span class="n">Tensor</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
</span><span id="__span-4-636"><a id="__codelineno-4-636" name="__codelineno-4-636" href="#__codelineno-4-636"></a>        <span class="n">loss</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">cross_entropy</span><span class="p">(</span><span class="n">logits</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">reduction</span><span class="o">=</span><span class="s2">&quot;sum&quot;</span><span class="p">)</span>
</span><span id="__span-4-637"><a id="__codelineno-4-637" name="__codelineno-4-637" href="#__codelineno-4-637"></a>
</span><span id="__span-4-638"><a id="__codelineno-4-638" name="__codelineno-4-638" href="#__codelineno-4-638"></a>        <span class="n">batch_n_samples</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="__span-4-639"><a id="__codelineno-4-639" name="__codelineno-4-639" href="#__codelineno-4-639"></a>        <span class="n">batch_correct_predictions</span> <span class="o">=</span> <span class="n">logits</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">eq</span><span class="p">(</span><span class="n">y</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
</span><span id="__span-4-640"><a id="__codelineno-4-640" name="__codelineno-4-640" href="#__codelineno-4-640"></a>
</span><span id="__span-4-641"><a id="__codelineno-4-641" name="__codelineno-4-641" href="#__codelineno-4-641"></a>        <span class="n">epoch_loss</span> <span class="o">+=</span> <span class="n">loss</span>
</span><span id="__span-4-642"><a id="__codelineno-4-642" name="__codelineno-4-642" href="#__codelineno-4-642"></a>        <span class="n">num_samples</span> <span class="o">+=</span> <span class="n">batch_n_samples</span>
</span><span id="__span-4-643"><a id="__codelineno-4-643" name="__codelineno-4-643" href="#__codelineno-4-643"></a>        <span class="n">correct_predictions</span> <span class="o">+=</span> <span class="n">batch_correct_predictions</span>
</span><span id="__span-4-644"><a id="__codelineno-4-644" name="__codelineno-4-644" href="#__codelineno-4-644"></a>    <span class="c1"># Here we only need to reduce metrics once, after iterating over the entire dataset.</span>
</span><span id="__span-4-645"><a id="__codelineno-4-645" name="__codelineno-4-645" href="#__codelineno-4-645"></a>    <span class="n">torch</span><span class="o">.</span><span class="n">distributed</span><span class="o">.</span><span class="n">reduce</span><span class="p">(</span><span class="n">epoch_loss</span><span class="p">,</span> <span class="n">dst</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">op</span><span class="o">=</span><span class="n">ReduceOp</span><span class="o">.</span><span class="n">SUM</span><span class="p">)</span>
</span><span id="__span-4-646"><a id="__codelineno-4-646" name="__codelineno-4-646" href="#__codelineno-4-646"></a>    <span class="n">torch</span><span class="o">.</span><span class="n">distributed</span><span class="o">.</span><span class="n">reduce</span><span class="p">(</span><span class="n">num_samples</span><span class="p">,</span> <span class="n">dst</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">op</span><span class="o">=</span><span class="n">ReduceOp</span><span class="o">.</span><span class="n">SUM</span><span class="p">)</span>
</span><span id="__span-4-647"><a id="__codelineno-4-647" name="__codelineno-4-647" href="#__codelineno-4-647"></a>    <span class="n">torch</span><span class="o">.</span><span class="n">distributed</span><span class="o">.</span><span class="n">reduce</span><span class="p">(</span><span class="n">correct_predictions</span><span class="p">,</span> <span class="n">dst</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">op</span><span class="o">=</span><span class="n">ReduceOp</span><span class="o">.</span><span class="n">SUM</span><span class="p">)</span>
</span><span id="__span-4-648"><a id="__codelineno-4-648" name="__codelineno-4-648" href="#__codelineno-4-648"></a>    <span class="n">epoch_average_loss</span> <span class="o">=</span> <span class="n">epoch_loss</span> <span class="o">/</span> <span class="n">num_samples</span>
</span><span id="__span-4-649"><a id="__codelineno-4-649" name="__codelineno-4-649" href="#__codelineno-4-649"></a>    <span class="n">accuracy</span> <span class="o">=</span> <span class="n">correct_predictions</span> <span class="o">/</span> <span class="n">num_samples</span>
</span><span id="__span-4-650"><a id="__codelineno-4-650" name="__codelineno-4-650" href="#__codelineno-4-650"></a>    <span class="k">return</span> <span class="n">epoch_average_loss</span><span class="o">.</span><span class="n">item</span><span class="p">(),</span> <span class="n">accuracy</span><span class="o">.</span><span class="n">item</span><span class="p">(),</span> <span class="n">num_samples</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
</span><span id="__span-4-651"><a id="__codelineno-4-651" name="__codelineno-4-651" href="#__codelineno-4-651"></a>
</span><span id="__span-4-652"><a id="__codelineno-4-652" name="__codelineno-4-652" href="#__codelineno-4-652"></a>
</span><span id="__span-4-653"><a id="__codelineno-4-653" name="__codelineno-4-653" href="#__codelineno-4-653"></a><span class="k">def</span><span class="w"> </span><span class="nf">setup_wandb</span><span class="p">(</span>
</span><span id="__span-4-654"><a id="__codelineno-4-654" name="__codelineno-4-654" href="#__codelineno-4-654"></a>    <span class="n">args</span><span class="p">:</span> <span class="n">Args</span><span class="p">,</span> <span class="n">effective_batch_size</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">previous_checkpoints</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">Path</span><span class="p">],</span> <span class="n">total_updates</span><span class="p">:</span> <span class="nb">int</span>
</span><span id="__span-4-655"><a id="__codelineno-4-655" name="__codelineno-4-655" href="#__codelineno-4-655"></a><span class="p">):</span>
</span><span id="__span-4-656"><a id="__codelineno-4-656" name="__codelineno-4-656" href="#__codelineno-4-656"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Calls `wandb.init` with the appropriate arguments.&quot;&quot;&quot;</span>
</span><span id="__span-4-657"><a id="__codelineno-4-657" name="__codelineno-4-657" href="#__codelineno-4-657"></a>    <span class="c1"># Normally you would only do this in the first task (rank 0), but here we do it in all tasks</span>
</span><span id="__span-4-658"><a id="__codelineno-4-658" name="__codelineno-4-658" href="#__codelineno-4-658"></a>    <span class="c1"># using the new &quot;shared&quot; feature of wandb. This makes it much easier to track the GPU util of</span>
</span><span id="__span-4-659"><a id="__codelineno-4-659" name="__codelineno-4-659" href="#__codelineno-4-659"></a>    <span class="c1"># all gpus on all nodes in the job.</span>
</span><span id="__span-4-660"><a id="__codelineno-4-660" name="__codelineno-4-660" href="#__codelineno-4-660"></a>    <span class="c1"># See this link for more info:</span>
</span><span id="__span-4-661"><a id="__codelineno-4-661" name="__codelineno-4-661" href="#__codelineno-4-661"></a>    <span class="c1"># - https://docs.wandb.ai/guides/track/log/distributed-training/#track-all-processes-to-a-single-run</span>
</span><span id="__span-4-662"><a id="__codelineno-4-662" name="__codelineno-4-662" href="#__codelineno-4-662"></a>    <span class="n">is_master</span> <span class="o">=</span> <span class="n">RANK</span> <span class="o">==</span> <span class="mi">0</span>
</span><span id="__span-4-663"><a id="__codelineno-4-663" name="__codelineno-4-663" href="#__codelineno-4-663"></a>    <span class="k">with</span> <span class="n">goes_first</span><span class="p">(</span><span class="n">is_master</span><span class="p">):</span>
</span><span id="__span-4-664"><a id="__codelineno-4-664" name="__codelineno-4-664" href="#__codelineno-4-664"></a>        <span class="n">run</span> <span class="o">=</span> <span class="n">wandb</span><span class="o">.</span><span class="n">init</span><span class="p">(</span>
</span><span id="__span-4-665"><a id="__codelineno-4-665" name="__codelineno-4-665" href="#__codelineno-4-665"></a>            <span class="n">project</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">wandb_project</span><span class="p">,</span>
</span><span id="__span-4-666"><a id="__codelineno-4-666" name="__codelineno-4-666" href="#__codelineno-4-666"></a>            <span class="c1"># if None, wandb will use a random name.</span>
</span><span id="__span-4-667"><a id="__codelineno-4-667" name="__codelineno-4-667" href="#__codelineno-4-667"></a>            <span class="n">name</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">run_name</span> <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">run_name</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="__span-4-668"><a id="__codelineno-4-668" name="__codelineno-4-668" href="#__codelineno-4-668"></a>            <span class="nb">id</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">wandb_run_id</span><span class="p">,</span>
</span><span id="__span-4-669"><a id="__codelineno-4-669" name="__codelineno-4-669" href="#__codelineno-4-669"></a>            <span class="c1"># It&#39;s a good idea to log the SLURM environment variables to wandb.</span>
</span><span id="__span-4-670"><a id="__codelineno-4-670" name="__codelineno-4-670" href="#__codelineno-4-670"></a>            <span class="n">config</span><span class="o">=</span><span class="p">(</span>
</span><span id="__span-4-671"><a id="__codelineno-4-671" name="__codelineno-4-671" href="#__codelineno-4-671"></a>                <span class="n">dataclasses</span><span class="o">.</span><span class="n">asdict</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
</span><span id="__span-4-672"><a id="__codelineno-4-672" name="__codelineno-4-672" href="#__codelineno-4-672"></a>                <span class="o">|</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;SLURM_&quot;</span><span class="p">)}</span>
</span><span id="__span-4-673"><a id="__codelineno-4-673" name="__codelineno-4-673" href="#__codelineno-4-673"></a>                <span class="o">|</span> <span class="nb">dict</span><span class="p">(</span>
</span><span id="__span-4-674"><a id="__codelineno-4-674" name="__codelineno-4-674" href="#__codelineno-4-674"></a>                    <span class="n">effective_batch_size</span><span class="o">=</span><span class="n">effective_batch_size</span><span class="p">,</span>
</span><span id="__span-4-675"><a id="__codelineno-4-675" name="__codelineno-4-675" href="#__codelineno-4-675"></a>                    <span class="n">WORLD_SIZE</span><span class="o">=</span><span class="n">WORLD_SIZE</span><span class="p">,</span>
</span><span id="__span-4-676"><a id="__codelineno-4-676" name="__codelineno-4-676" href="#__codelineno-4-676"></a>                    <span class="n">MASTER_ADDR</span><span class="o">=</span><span class="n">MASTER_ADDR</span><span class="p">,</span>
</span><span id="__span-4-677"><a id="__codelineno-4-677" name="__codelineno-4-677" href="#__codelineno-4-677"></a>                    <span class="n">MASTER_PORT</span><span class="o">=</span><span class="n">MASTER_PORT</span><span class="p">,</span>
</span><span id="__span-4-678"><a id="__codelineno-4-678" name="__codelineno-4-678" href="#__codelineno-4-678"></a>                <span class="p">)</span>
</span><span id="__span-4-679"><a id="__codelineno-4-679" name="__codelineno-4-679" href="#__codelineno-4-679"></a>            <span class="p">),</span>
</span><span id="__span-4-680"><a id="__codelineno-4-680" name="__codelineno-4-680" href="#__codelineno-4-680"></a>            <span class="n">group</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">wandb_group</span><span class="p">,</span>
</span><span id="__span-4-681"><a id="__codelineno-4-681" name="__codelineno-4-681" href="#__codelineno-4-681"></a>            <span class="c1"># Use the new &quot;shared&quot; mode to log system utilization metrics from all tasks in the job:</span>
</span><span id="__span-4-682"><a id="__codelineno-4-682" name="__codelineno-4-682" href="#__codelineno-4-682"></a>            <span class="n">settings</span><span class="o">=</span><span class="n">wandb</span><span class="o">.</span><span class="n">Settings</span><span class="p">(</span>
</span><span id="__span-4-683"><a id="__codelineno-4-683" name="__codelineno-4-683" href="#__codelineno-4-683"></a>                <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;disabled&quot;</span> <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">no_wandb</span> <span class="k">else</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;WANDB_MODE&quot;</span><span class="p">,</span> <span class="s2">&quot;shared&quot;</span><span class="p">),</span>  <span class="c1"># type: ignore</span>
</span><span id="__span-4-684"><a id="__codelineno-4-684" name="__codelineno-4-684" href="#__codelineno-4-684"></a>                <span class="n">x_primary</span><span class="o">=</span><span class="n">is_master</span><span class="p">,</span>
</span><span id="__span-4-685"><a id="__codelineno-4-685" name="__codelineno-4-685" href="#__codelineno-4-685"></a>                <span class="n">x_label</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;task_</span><span class="si">{</span><span class="n">RANK</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span id="__span-4-686"><a id="__codelineno-4-686" name="__codelineno-4-686" href="#__codelineno-4-686"></a>                <span class="n">x_stats_gpu_device_ids</span><span class="o">=</span><span class="p">[</span><span class="n">LOCAL_RANK</span><span class="p">],</span>
</span><span id="__span-4-687"><a id="__codelineno-4-687" name="__codelineno-4-687" href="#__codelineno-4-687"></a>                <span class="n">x_update_finish_state</span><span class="o">=</span><span class="ow">not</span> <span class="n">is_master</span><span class="p">,</span>
</span><span id="__span-4-688"><a id="__codelineno-4-688" name="__codelineno-4-688" href="#__codelineno-4-688"></a>            <span class="p">),</span>
</span><span id="__span-4-689"><a id="__codelineno-4-689" name="__codelineno-4-689" href="#__codelineno-4-689"></a>            <span class="c1"># Resume an existing run with the same ID if the job is restarting after being preempted.</span>
</span><span id="__span-4-690"><a id="__codelineno-4-690" name="__codelineno-4-690" href="#__codelineno-4-690"></a>            <span class="c1"># It would be *really* nice to use this resume feature, but this is new</span>
</span><span id="__span-4-691"><a id="__codelineno-4-691" name="__codelineno-4-691" href="#__codelineno-4-691"></a>            <span class="c1"># at the time of writing (2025-09) and needs to be enabled for your project</span>
</span><span id="__span-4-692"><a id="__codelineno-4-692" name="__codelineno-4-692" href="#__codelineno-4-692"></a>            <span class="c1"># by contacting wandb support.</span>
</span><span id="__span-4-693"><a id="__codelineno-4-693" name="__codelineno-4-693" href="#__codelineno-4-693"></a>            <span class="c1"># resume_from=(</span>
</span><span id="__span-4-694"><a id="__codelineno-4-694" name="__codelineno-4-694" href="#__codelineno-4-694"></a>            <span class="c1">#     f&quot;{args.wandb_run_id}?_step={total_updates}&quot;</span>
</span><span id="__span-4-695"><a id="__codelineno-4-695" name="__codelineno-4-695" href="#__codelineno-4-695"></a>            <span class="c1">#     if previous_checkpoints and args.wandb_run_id</span>
</span><span id="__span-4-696"><a id="__codelineno-4-696" name="__codelineno-4-696" href="#__codelineno-4-696"></a>            <span class="c1">#     else None</span>
</span><span id="__span-4-697"><a id="__codelineno-4-697" name="__codelineno-4-697" href="#__codelineno-4-697"></a>            <span class="c1"># ),</span>
</span><span id="__span-4-698"><a id="__codelineno-4-698" name="__codelineno-4-698" href="#__codelineno-4-698"></a>            <span class="c1"># resume=None if previous_checkpoints and args.wandb_run_id else &quot;allow&quot;,</span>
</span><span id="__span-4-699"><a id="__codelineno-4-699" name="__codelineno-4-699" href="#__codelineno-4-699"></a>            <span class="c1"># Use this for the time being instead:</span>
</span><span id="__span-4-700"><a id="__codelineno-4-700" name="__codelineno-4-700" href="#__codelineno-4-700"></a>            <span class="n">resume</span><span class="o">=</span><span class="s2">&quot;allow&quot;</span><span class="p">,</span>
</span><span id="__span-4-701"><a id="__codelineno-4-701" name="__codelineno-4-701" href="#__codelineno-4-701"></a>        <span class="p">)</span>
</span><span id="__span-4-702"><a id="__codelineno-4-702" name="__codelineno-4-702" href="#__codelineno-4-702"></a>        <span class="c1"># Wait a bit to make sure the run is created properly in wandb by the first task before other workers try to</span>
</span><span id="__span-4-703"><a id="__codelineno-4-703" name="__codelineno-4-703" href="#__codelineno-4-703"></a>        <span class="c1"># also create it. Otherwise we can get a 409 error from the wandb server.</span>
</span><span id="__span-4-704"><a id="__codelineno-4-704" name="__codelineno-4-704" href="#__codelineno-4-704"></a>        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
</span><span id="__span-4-705"><a id="__codelineno-4-705" name="__codelineno-4-705" href="#__codelineno-4-705"></a>
</span><span id="__span-4-706"><a id="__codelineno-4-706" name="__codelineno-4-706" href="#__codelineno-4-706"></a>    <span class="c1"># Specify the step metric (x-axis) and the metric to log against it (y-axis)</span>
</span><span id="__span-4-707"><a id="__codelineno-4-707" name="__codelineno-4-707" href="#__codelineno-4-707"></a>    <span class="n">run</span><span class="o">.</span><span class="n">define_metric</span><span class="p">(</span><span class="s2">&quot;train/*&quot;</span><span class="p">,</span> <span class="n">step_metric</span><span class="o">=</span><span class="s2">&quot;updates&quot;</span><span class="p">)</span>
</span><span id="__span-4-708"><a id="__codelineno-4-708" name="__codelineno-4-708" href="#__codelineno-4-708"></a>    <span class="n">run</span><span class="o">.</span><span class="n">define_metric</span><span class="p">(</span><span class="s2">&quot;val/*&quot;</span><span class="p">,</span> <span class="n">step_metric</span><span class="o">=</span><span class="s2">&quot;epoch&quot;</span><span class="p">)</span>
</span><span id="__span-4-709"><a id="__codelineno-4-709" name="__codelineno-4-709" href="#__codelineno-4-709"></a>    <span class="c1"># https://docs.wandb.ai/guides/track/log/log-summary/#customize-summary-metrics</span>
</span><span id="__span-4-710"><a id="__codelineno-4-710" name="__codelineno-4-710" href="#__codelineno-4-710"></a>    <span class="n">run</span><span class="o">.</span><span class="n">define_metric</span><span class="p">(</span><span class="s2">&quot;train/samples_per_sec&quot;</span><span class="p">,</span> <span class="n">summary</span><span class="o">=</span><span class="s2">&quot;max&quot;</span><span class="p">)</span>
</span><span id="__span-4-711"><a id="__codelineno-4-711" name="__codelineno-4-711" href="#__codelineno-4-711"></a>    <span class="n">run</span><span class="o">.</span><span class="n">define_metric</span><span class="p">(</span><span class="s2">&quot;train/samples_per_sec&quot;</span><span class="p">,</span> <span class="n">summary</span><span class="o">=</span><span class="s2">&quot;mean&quot;</span><span class="p">)</span>
</span><span id="__span-4-712"><a id="__codelineno-4-712" name="__codelineno-4-712" href="#__codelineno-4-712"></a>    <span class="n">run</span><span class="o">.</span><span class="n">define_metric</span><span class="p">(</span><span class="s2">&quot;train/samples_per_sec&quot;</span><span class="p">,</span> <span class="n">summary</span><span class="o">=</span><span class="s2">&quot;min&quot;</span><span class="p">)</span>
</span><span id="__span-4-713"><a id="__codelineno-4-713" name="__codelineno-4-713" href="#__codelineno-4-713"></a>    <span class="n">run</span><span class="o">.</span><span class="n">define_metric</span><span class="p">(</span><span class="s2">&quot;val/samples_per_sec&quot;</span><span class="p">,</span> <span class="n">summary</span><span class="o">=</span><span class="s2">&quot;max&quot;</span><span class="p">)</span>
</span><span id="__span-4-714"><a id="__codelineno-4-714" name="__codelineno-4-714" href="#__codelineno-4-714"></a>    <span class="n">run</span><span class="o">.</span><span class="n">define_metric</span><span class="p">(</span><span class="s2">&quot;val/samples_per_sec&quot;</span><span class="p">,</span> <span class="n">summary</span><span class="o">=</span><span class="s2">&quot;mean&quot;</span><span class="p">)</span>
</span><span id="__span-4-715"><a id="__codelineno-4-715" name="__codelineno-4-715" href="#__codelineno-4-715"></a>    <span class="n">run</span><span class="o">.</span><span class="n">define_metric</span><span class="p">(</span><span class="s2">&quot;val/samples_per_sec&quot;</span><span class="p">,</span> <span class="n">summary</span><span class="o">=</span><span class="s2">&quot;min&quot;</span><span class="p">)</span>
</span><span id="__span-4-716"><a id="__codelineno-4-716" name="__codelineno-4-716" href="#__codelineno-4-716"></a>
</span><span id="__span-4-717"><a id="__codelineno-4-717" name="__codelineno-4-717" href="#__codelineno-4-717"></a>
</span><span id="__span-4-718"><a id="__codelineno-4-718" name="__codelineno-4-718" href="#__codelineno-4-718"></a><span class="n">T</span> <span class="o">=</span> <span class="n">TypeVar</span><span class="p">(</span><span class="s2">&quot;T&quot;</span><span class="p">)</span>
</span><span id="__span-4-719"><a id="__codelineno-4-719" name="__codelineno-4-719" href="#__codelineno-4-719"></a>
</span><span id="__span-4-720"><a id="__codelineno-4-720" name="__codelineno-4-720" href="#__codelineno-4-720"></a>
</span><span id="__span-4-721"><a id="__codelineno-4-721" name="__codelineno-4-721" href="#__codelineno-4-721"></a><span class="k">def</span><span class="w"> </span><span class="nf">profile_loop</span><span class="p">(</span><span class="n">dataloader</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="n">T</span><span class="p">],</span> <span class="n">profiler</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">profiler</span><span class="o">.</span><span class="n">profile</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterable</span><span class="p">[</span><span class="n">T</span><span class="p">]:</span>
</span><span id="__span-4-722"><a id="__codelineno-4-722" name="__codelineno-4-722" href="#__codelineno-4-722"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Wraps the dataloader (or progress bar) and calls .step after each batch.</span>
</span><span id="__span-4-723"><a id="__codelineno-4-723" name="__codelineno-4-723" href="#__codelineno-4-723"></a>
</span><span id="__span-4-724"><a id="__codelineno-4-724" name="__codelineno-4-724" href="#__codelineno-4-724"></a><span class="sd">    This is used to save one level of indentation (with profiler block) and to call prof.step() at each step.</span>
</span><span id="__span-4-725"><a id="__codelineno-4-725" name="__codelineno-4-725" href="#__codelineno-4-725"></a>
</span><span id="__span-4-726"><a id="__codelineno-4-726" name="__codelineno-4-726" href="#__codelineno-4-726"></a><span class="sd">    Note, this doesn&#39;t need to be done at every epoch. It creates files used by tensorboard.</span>
</span><span id="__span-4-727"><a id="__codelineno-4-727" name="__codelineno-4-727" href="#__codelineno-4-727"></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="__span-4-728"><a id="__codelineno-4-728" name="__codelineno-4-728" href="#__codelineno-4-728"></a>    <span class="k">with</span> <span class="n">profiler</span> <span class="k">as</span> <span class="n">prof</span><span class="p">:</span>
</span><span id="__span-4-729"><a id="__codelineno-4-729" name="__codelineno-4-729" href="#__codelineno-4-729"></a>        <span class="k">for</span> <span class="n">batch</span> <span class="ow">in</span> <span class="n">dataloader</span><span class="p">:</span>
</span><span id="__span-4-730"><a id="__codelineno-4-730" name="__codelineno-4-730" href="#__codelineno-4-730"></a>            <span class="k">yield</span> <span class="n">batch</span>
</span><span id="__span-4-731"><a id="__codelineno-4-731" name="__codelineno-4-731" href="#__codelineno-4-731"></a>            <span class="n">prof</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>
</span><span id="__span-4-732"><a id="__codelineno-4-732" name="__codelineno-4-732" href="#__codelineno-4-732"></a>
</span><span id="__span-4-733"><a id="__codelineno-4-733" name="__codelineno-4-733" href="#__codelineno-4-733"></a>
</span><span id="__span-4-734"><a id="__codelineno-4-734" name="__codelineno-4-734" href="#__codelineno-4-734"></a><span class="k">def</span><span class="w"> </span><span class="nf">make_datasets</span><span class="p">(</span>
</span><span id="__span-4-735"><a id="__codelineno-4-735" name="__codelineno-4-735" href="#__codelineno-4-735"></a>    <span class="n">path</span><span class="p">:</span> <span class="n">Path</span><span class="p">,</span>
</span><span id="__span-4-736"><a id="__codelineno-4-736" name="__codelineno-4-736" href="#__codelineno-4-736"></a>    <span class="n">val_split</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">,</span>
</span><span id="__span-4-737"><a id="__codelineno-4-737" name="__codelineno-4-737" href="#__codelineno-4-737"></a>    <span class="n">val_split_seed</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">42</span><span class="p">,</span>
</span><span id="__span-4-738"><a id="__codelineno-4-738" name="__codelineno-4-738" href="#__codelineno-4-738"></a>    <span class="n">use_fake_data</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="__span-4-739"><a id="__codelineno-4-739" name="__codelineno-4-739" href="#__codelineno-4-739"></a><span class="p">):</span>
</span><span id="__span-4-740"><a id="__codelineno-4-740" name="__codelineno-4-740" href="#__codelineno-4-740"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Returns the training, validation, and test splits.&quot;&quot;&quot;</span>
</span><span id="__span-4-741"><a id="__codelineno-4-741" name="__codelineno-4-741" href="#__codelineno-4-741"></a>    <span class="k">if</span> <span class="n">use_fake_data</span><span class="p">:</span>
</span><span id="__span-4-742"><a id="__codelineno-4-742" name="__codelineno-4-742" href="#__codelineno-4-742"></a>        <span class="n">train_dataset</span> <span class="o">=</span> <span class="n">torchvision</span><span class="o">.</span><span class="n">datasets</span><span class="o">.</span><span class="n">FakeData</span><span class="p">(</span>
</span><span id="__span-4-743"><a id="__codelineno-4-743" name="__codelineno-4-743" href="#__codelineno-4-743"></a>            <span class="n">size</span><span class="o">=</span><span class="mi">1_281_167</span><span class="p">,</span>
</span><span id="__span-4-744"><a id="__codelineno-4-744" name="__codelineno-4-744" href="#__codelineno-4-744"></a>            <span class="n">image_size</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">224</span><span class="p">,</span> <span class="mi">224</span><span class="p">),</span>
</span><span id="__span-4-745"><a id="__codelineno-4-745" name="__codelineno-4-745" href="#__codelineno-4-745"></a>            <span class="n">num_classes</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span>
</span><span id="__span-4-746"><a id="__codelineno-4-746" name="__codelineno-4-746" href="#__codelineno-4-746"></a>            <span class="n">transform</span><span class="o">=</span><span class="n">transforms</span><span class="o">.</span><span class="n">ToTensor</span><span class="p">(),</span>
</span><span id="__span-4-747"><a id="__codelineno-4-747" name="__codelineno-4-747" href="#__codelineno-4-747"></a>        <span class="p">)</span>
</span><span id="__span-4-748"><a id="__codelineno-4-748" name="__codelineno-4-748" href="#__codelineno-4-748"></a>        <span class="n">valid_dataset</span> <span class="o">=</span> <span class="n">torchvision</span><span class="o">.</span><span class="n">datasets</span><span class="o">.</span><span class="n">FakeData</span><span class="p">(</span>
</span><span id="__span-4-749"><a id="__codelineno-4-749" name="__codelineno-4-749" href="#__codelineno-4-749"></a>            <span class="n">size</span><span class="o">=</span><span class="mi">20_000</span><span class="p">,</span>
</span><span id="__span-4-750"><a id="__codelineno-4-750" name="__codelineno-4-750" href="#__codelineno-4-750"></a>            <span class="n">image_size</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">224</span><span class="p">,</span> <span class="mi">224</span><span class="p">),</span>
</span><span id="__span-4-751"><a id="__codelineno-4-751" name="__codelineno-4-751" href="#__codelineno-4-751"></a>            <span class="n">num_classes</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span>
</span><span id="__span-4-752"><a id="__codelineno-4-752" name="__codelineno-4-752" href="#__codelineno-4-752"></a>            <span class="n">transform</span><span class="o">=</span><span class="n">transforms</span><span class="o">.</span><span class="n">Compose</span><span class="p">(</span>
</span><span id="__span-4-753"><a id="__codelineno-4-753" name="__codelineno-4-753" href="#__codelineno-4-753"></a>                <span class="p">[</span><span class="n">transforms</span><span class="o">.</span><span class="n">ToImage</span><span class="p">(),</span> <span class="n">transforms</span><span class="o">.</span><span class="n">ToDtype</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="kc">True</span><span class="p">)]</span>
</span><span id="__span-4-754"><a id="__codelineno-4-754" name="__codelineno-4-754" href="#__codelineno-4-754"></a>            <span class="p">),</span>
</span><span id="__span-4-755"><a id="__codelineno-4-755" name="__codelineno-4-755" href="#__codelineno-4-755"></a>        <span class="p">)</span>
</span><span id="__span-4-756"><a id="__codelineno-4-756" name="__codelineno-4-756" href="#__codelineno-4-756"></a>        <span class="n">test_dataset</span> <span class="o">=</span> <span class="n">torchvision</span><span class="o">.</span><span class="n">datasets</span><span class="o">.</span><span class="n">FakeData</span><span class="p">(</span>
</span><span id="__span-4-757"><a id="__codelineno-4-757" name="__codelineno-4-757" href="#__codelineno-4-757"></a>            <span class="n">size</span><span class="o">=</span><span class="mi">50_000</span><span class="p">,</span>
</span><span id="__span-4-758"><a id="__codelineno-4-758" name="__codelineno-4-758" href="#__codelineno-4-758"></a>            <span class="n">image_size</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">224</span><span class="p">,</span> <span class="mi">224</span><span class="p">),</span>
</span><span id="__span-4-759"><a id="__codelineno-4-759" name="__codelineno-4-759" href="#__codelineno-4-759"></a>            <span class="n">num_classes</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span>
</span><span id="__span-4-760"><a id="__codelineno-4-760" name="__codelineno-4-760" href="#__codelineno-4-760"></a>            <span class="n">transform</span><span class="o">=</span><span class="n">transforms</span><span class="o">.</span><span class="n">Compose</span><span class="p">(</span>
</span><span id="__span-4-761"><a id="__codelineno-4-761" name="__codelineno-4-761" href="#__codelineno-4-761"></a>                <span class="p">[</span><span class="n">transforms</span><span class="o">.</span><span class="n">ToImage</span><span class="p">(),</span> <span class="n">transforms</span><span class="o">.</span><span class="n">ToDtype</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="kc">True</span><span class="p">)]</span>
</span><span id="__span-4-762"><a id="__codelineno-4-762" name="__codelineno-4-762" href="#__codelineno-4-762"></a>            <span class="p">),</span>
</span><span id="__span-4-763"><a id="__codelineno-4-763" name="__codelineno-4-763" href="#__codelineno-4-763"></a>        <span class="p">)</span>
</span><span id="__span-4-764"><a id="__codelineno-4-764" name="__codelineno-4-764" href="#__codelineno-4-764"></a>        <span class="k">return</span> <span class="n">train_dataset</span><span class="p">,</span> <span class="n">valid_dataset</span><span class="p">,</span> <span class="n">test_dataset</span>
</span><span id="__span-4-765"><a id="__codelineno-4-765" name="__codelineno-4-765" href="#__codelineno-4-765"></a>    <span class="c1"># todo: torchvision transforms can apparently moved to the GPU now? Would that speed up the training?</span>
</span><span id="__span-4-766"><a id="__codelineno-4-766" name="__codelineno-4-766" href="#__codelineno-4-766"></a>    <span class="n">train_transforms</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Sequential</span><span class="p">(</span>
</span><span id="__span-4-767"><a id="__codelineno-4-767" name="__codelineno-4-767" href="#__codelineno-4-767"></a>        <span class="n">transforms</span><span class="o">.</span><span class="n">RandomResizedCrop</span><span class="p">(</span><span class="mi">224</span><span class="p">),</span>
</span><span id="__span-4-768"><a id="__codelineno-4-768" name="__codelineno-4-768" href="#__codelineno-4-768"></a>        <span class="n">transforms</span><span class="o">.</span><span class="n">RandomHorizontalFlip</span><span class="p">(),</span>
</span><span id="__span-4-769"><a id="__codelineno-4-769" name="__codelineno-4-769" href="#__codelineno-4-769"></a>        <span class="n">transforms</span><span class="o">.</span><span class="n">ToImage</span><span class="p">(),</span>
</span><span id="__span-4-770"><a id="__codelineno-4-770" name="__codelineno-4-770" href="#__codelineno-4-770"></a>        <span class="n">transforms</span><span class="o">.</span><span class="n">ToDtype</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
</span><span id="__span-4-771"><a id="__codelineno-4-771" name="__codelineno-4-771" href="#__codelineno-4-771"></a>        <span class="n">transforms</span><span class="o">.</span><span class="n">Normalize</span><span class="p">(</span><span class="n">mean</span><span class="o">=</span><span class="p">[</span><span class="mf">0.485</span><span class="p">,</span> <span class="mf">0.456</span><span class="p">,</span> <span class="mf">0.406</span><span class="p">],</span> <span class="n">std</span><span class="o">=</span><span class="p">[</span><span class="mf">0.229</span><span class="p">,</span> <span class="mf">0.224</span><span class="p">,</span> <span class="mf">0.225</span><span class="p">]),</span>
</span><span id="__span-4-772"><a id="__codelineno-4-772" name="__codelineno-4-772" href="#__codelineno-4-772"></a>    <span class="p">)</span>
</span><span id="__span-4-773"><a id="__codelineno-4-773" name="__codelineno-4-773" href="#__codelineno-4-773"></a>    <span class="n">test_transforms</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Sequential</span><span class="p">(</span>
</span><span id="__span-4-774"><a id="__codelineno-4-774" name="__codelineno-4-774" href="#__codelineno-4-774"></a>        <span class="n">transforms</span><span class="o">.</span><span class="n">Resize</span><span class="p">(</span><span class="mi">256</span><span class="p">),</span>
</span><span id="__span-4-775"><a id="__codelineno-4-775" name="__codelineno-4-775" href="#__codelineno-4-775"></a>        <span class="n">transforms</span><span class="o">.</span><span class="n">CenterCrop</span><span class="p">(</span><span class="mi">224</span><span class="p">),</span>
</span><span id="__span-4-776"><a id="__codelineno-4-776" name="__codelineno-4-776" href="#__codelineno-4-776"></a>        <span class="n">transforms</span><span class="o">.</span><span class="n">ToImage</span><span class="p">(),</span>
</span><span id="__span-4-777"><a id="__codelineno-4-777" name="__codelineno-4-777" href="#__codelineno-4-777"></a>        <span class="n">transforms</span><span class="o">.</span><span class="n">ToDtype</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
</span><span id="__span-4-778"><a id="__codelineno-4-778" name="__codelineno-4-778" href="#__codelineno-4-778"></a>        <span class="n">transforms</span><span class="o">.</span><span class="n">Normalize</span><span class="p">(</span><span class="n">mean</span><span class="o">=</span><span class="p">[</span><span class="mf">0.485</span><span class="p">,</span> <span class="mf">0.456</span><span class="p">,</span> <span class="mf">0.406</span><span class="p">],</span> <span class="n">std</span><span class="o">=</span><span class="p">[</span><span class="mf">0.229</span><span class="p">,</span> <span class="mf">0.224</span><span class="p">,</span> <span class="mf">0.225</span><span class="p">]),</span>
</span><span id="__span-4-779"><a id="__codelineno-4-779" name="__codelineno-4-779" href="#__codelineno-4-779"></a>    <span class="p">)</span>
</span><span id="__span-4-780"><a id="__codelineno-4-780" name="__codelineno-4-780" href="#__codelineno-4-780"></a>    <span class="c1"># This takes ~12-15 minutes on the Mila cluster. The timeout value for the distributed process group</span>
</span><span id="__span-4-781"><a id="__codelineno-4-781" name="__codelineno-4-781" href="#__codelineno-4-781"></a>    <span class="c1"># needs to be higher than this to avoid a timeout.</span>
</span><span id="__span-4-782"><a id="__codelineno-4-782" name="__codelineno-4-782" href="#__codelineno-4-782"></a>    <span class="c1"># TODO: Could we setup a new process group just for this operation, with a high enough timeout,</span>
</span><span id="__span-4-783"><a id="__codelineno-4-783" name="__codelineno-4-783" href="#__codelineno-4-783"></a>    <span class="c1"># that way the default process group can keep a short timeout value to waste less time in case of errors.</span>
</span><span id="__span-4-784"><a id="__codelineno-4-784" name="__codelineno-4-784" href="#__codelineno-4-784"></a>    <span class="k">with</span> <span class="n">goes_first</span><span class="p">(</span><span class="n">LOCAL_RANK</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
</span><span id="__span-4-785"><a id="__codelineno-4-785" name="__codelineno-4-785" href="#__codelineno-4-785"></a>        <span class="kn">from</span><span class="w"> </span><span class="nn">prepare_data</span><span class="w"> </span><span class="kn">import</span> <span class="n">prepare_imagenet</span>
</span><span id="__span-4-786"><a id="__codelineno-4-786" name="__codelineno-4-786" href="#__codelineno-4-786"></a>
</span><span id="__span-4-787"><a id="__codelineno-4-787" name="__codelineno-4-787" href="#__codelineno-4-787"></a>        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Preparing the ImageNet dataset in </span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-4-788"><a id="__codelineno-4-788" name="__codelineno-4-788" href="#__codelineno-4-788"></a>        <span class="n">prepare_imagenet</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
</span><span id="__span-4-789"><a id="__codelineno-4-789" name="__codelineno-4-789" href="#__codelineno-4-789"></a>        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Done preparing the ImageNet dataset in </span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-4-790"><a id="__codelineno-4-790" name="__codelineno-4-790" href="#__codelineno-4-790"></a>
</span><span id="__span-4-791"><a id="__codelineno-4-791" name="__codelineno-4-791" href="#__codelineno-4-791"></a>    <span class="n">train_dataset</span> <span class="o">=</span> <span class="n">ImageNet</span><span class="p">(</span><span class="n">root</span><span class="o">=</span><span class="n">path</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">train_transforms</span><span class="p">,</span> <span class="n">split</span><span class="o">=</span><span class="s2">&quot;train&quot;</span><span class="p">)</span>
</span><span id="__span-4-792"><a id="__codelineno-4-792" name="__codelineno-4-792" href="#__codelineno-4-792"></a>    <span class="n">valid_dataset</span> <span class="o">=</span> <span class="n">ImageNet</span><span class="p">(</span><span class="n">root</span><span class="o">=</span><span class="n">path</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">test_transforms</span><span class="p">,</span> <span class="n">split</span><span class="o">=</span><span class="s2">&quot;train&quot;</span><span class="p">)</span>
</span><span id="__span-4-793"><a id="__codelineno-4-793" name="__codelineno-4-793" href="#__codelineno-4-793"></a>    <span class="n">test_dataset</span> <span class="o">=</span> <span class="n">ImageNet</span><span class="p">(</span><span class="n">root</span><span class="o">=</span><span class="n">path</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">test_transforms</span><span class="p">,</span> <span class="n">split</span><span class="o">=</span><span class="s2">&quot;val&quot;</span><span class="p">)</span>
</span><span id="__span-4-794"><a id="__codelineno-4-794" name="__codelineno-4-794" href="#__codelineno-4-794"></a>
</span><span id="__span-4-795"><a id="__codelineno-4-795" name="__codelineno-4-795" href="#__codelineno-4-795"></a>    <span class="c1"># Split the training dataset into a training and validation set, based on a stratified split.</span>
</span><span id="__span-4-796"><a id="__codelineno-4-796" name="__codelineno-4-796" href="#__codelineno-4-796"></a>    <span class="c1"># This is important to have a balanced distribution of classes in both sets.</span>
</span><span id="__span-4-797"><a id="__codelineno-4-797" name="__codelineno-4-797" href="#__codelineno-4-797"></a>    <span class="c1"># See the sklearn.model_selection.train_test_split documentation for more info.</span>
</span><span id="__span-4-798"><a id="__codelineno-4-798" name="__codelineno-4-798" href="#__codelineno-4-798"></a>    <span class="n">n_samples</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">train_dataset</span><span class="p">)</span>
</span><span id="__span-4-799"><a id="__codelineno-4-799" name="__codelineno-4-799" href="#__codelineno-4-799"></a>    <span class="n">n_valid</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">val_split</span> <span class="o">*</span> <span class="n">n_samples</span><span class="p">)</span>
</span><span id="__span-4-800"><a id="__codelineno-4-800" name="__codelineno-4-800" href="#__codelineno-4-800"></a>    <span class="n">n_train</span> <span class="o">=</span> <span class="n">n_samples</span> <span class="o">-</span> <span class="n">n_valid</span>
</span><span id="__span-4-801"><a id="__codelineno-4-801" name="__codelineno-4-801" href="#__codelineno-4-801"></a>    <span class="n">train_indices</span><span class="p">,</span> <span class="n">val_indices</span> <span class="o">=</span> <span class="n">sklearn</span><span class="o">.</span><span class="n">model_selection</span><span class="o">.</span><span class="n">train_test_split</span><span class="p">(</span>
</span><span id="__span-4-802"><a id="__codelineno-4-802" name="__codelineno-4-802" href="#__codelineno-4-802"></a>        <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">n_samples</span><span class="p">),</span>
</span><span id="__span-4-803"><a id="__codelineno-4-803" name="__codelineno-4-803" href="#__codelineno-4-803"></a>        <span class="n">train_size</span><span class="o">=</span><span class="n">n_train</span><span class="p">,</span>
</span><span id="__span-4-804"><a id="__codelineno-4-804" name="__codelineno-4-804" href="#__codelineno-4-804"></a>        <span class="n">test_size</span><span class="o">=</span><span class="n">n_valid</span><span class="p">,</span>
</span><span id="__span-4-805"><a id="__codelineno-4-805" name="__codelineno-4-805" href="#__codelineno-4-805"></a>        <span class="n">random_state</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">RandomState</span><span class="p">(</span><span class="n">val_split_seed</span><span class="p">),</span>
</span><span id="__span-4-806"><a id="__codelineno-4-806" name="__codelineno-4-806" href="#__codelineno-4-806"></a>        <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="__span-4-807"><a id="__codelineno-4-807" name="__codelineno-4-807" href="#__codelineno-4-807"></a>        <span class="n">stratify</span><span class="o">=</span><span class="n">train_dataset</span><span class="o">.</span><span class="n">targets</span><span class="p">,</span>
</span><span id="__span-4-808"><a id="__codelineno-4-808" name="__codelineno-4-808" href="#__codelineno-4-808"></a>    <span class="p">)</span>
</span><span id="__span-4-809"><a id="__codelineno-4-809" name="__codelineno-4-809" href="#__codelineno-4-809"></a>    <span class="n">train_dataset</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">Subset</span><span class="p">(</span><span class="n">train_dataset</span><span class="p">,</span> <span class="n">train_indices</span><span class="p">)</span>
</span><span id="__span-4-810"><a id="__codelineno-4-810" name="__codelineno-4-810" href="#__codelineno-4-810"></a>    <span class="n">valid_dataset</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">Subset</span><span class="p">(</span><span class="n">valid_dataset</span><span class="p">,</span> <span class="n">val_indices</span><span class="p">)</span>
</span><span id="__span-4-811"><a id="__codelineno-4-811" name="__codelineno-4-811" href="#__codelineno-4-811"></a>
</span><span id="__span-4-812"><a id="__codelineno-4-812" name="__codelineno-4-812" href="#__codelineno-4-812"></a>    <span class="k">return</span> <span class="n">train_dataset</span><span class="p">,</span> <span class="n">valid_dataset</span><span class="p">,</span> <span class="n">test_dataset</span>
</span><span id="__span-4-813"><a id="__codelineno-4-813" name="__codelineno-4-813" href="#__codelineno-4-813"></a>
</span><span id="__span-4-814"><a id="__codelineno-4-814" name="__codelineno-4-814" href="#__codelineno-4-814"></a>
</span><span id="__span-4-815"><a id="__codelineno-4-815" name="__codelineno-4-815" href="#__codelineno-4-815"></a><span class="k">def</span><span class="w"> </span><span class="nf">load_checkpoint</span><span class="p">(</span>
</span><span id="__span-4-816"><a id="__codelineno-4-816" name="__codelineno-4-816" href="#__codelineno-4-816"></a>    <span class="n">checkpoint_path</span><span class="p">:</span> <span class="n">Path</span><span class="p">,</span>
</span><span id="__span-4-817"><a id="__codelineno-4-817" name="__codelineno-4-817" href="#__codelineno-4-817"></a>    <span class="n">model</span><span class="p">:</span> <span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">,</span>
</span><span id="__span-4-818"><a id="__codelineno-4-818" name="__codelineno-4-818" href="#__codelineno-4-818"></a>    <span class="n">optimizer</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">Optimizer</span><span class="p">,</span>
</span><span id="__span-4-819"><a id="__codelineno-4-819" name="__codelineno-4-819" href="#__codelineno-4-819"></a>    <span class="n">device</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">,</span>
</span><span id="__span-4-820"><a id="__codelineno-4-820" name="__codelineno-4-820" href="#__codelineno-4-820"></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]:</span>
</span><span id="__span-4-821"><a id="__codelineno-4-821" name="__codelineno-4-821" href="#__codelineno-4-821"></a>    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Loading checkpoint </span><span class="si">{</span><span class="n">checkpoint_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-4-822"><a id="__codelineno-4-822" name="__codelineno-4-822" href="#__codelineno-4-822"></a>    <span class="n">checkpoint</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">checkpoint_path</span><span class="p">,</span> <span class="n">map_location</span><span class="o">=</span><span class="n">device</span><span class="p">,</span> <span class="n">weights_only</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="__span-4-823"><a id="__codelineno-4-823" name="__codelineno-4-823" href="#__codelineno-4-823"></a>    <span class="n">model</span><span class="o">.</span><span class="n">load_state_dict</span><span class="p">(</span><span class="n">checkpoint</span><span class="p">[</span><span class="s2">&quot;model&quot;</span><span class="p">])</span>
</span><span id="__span-4-824"><a id="__codelineno-4-824" name="__codelineno-4-824" href="#__codelineno-4-824"></a>    <span class="n">optimizer</span><span class="o">.</span><span class="n">load_state_dict</span><span class="p">(</span><span class="n">checkpoint</span><span class="p">[</span><span class="s2">&quot;optimizer&quot;</span><span class="p">])</span>
</span><span id="__span-4-825"><a id="__codelineno-4-825" name="__codelineno-4-825" href="#__codelineno-4-825"></a>    <span class="n">epoch</span> <span class="o">=</span> <span class="n">checkpoint</span><span class="p">[</span><span class="s2">&quot;epoch&quot;</span><span class="p">]</span>
</span><span id="__span-4-826"><a id="__codelineno-4-826" name="__codelineno-4-826" href="#__codelineno-4-826"></a>    <span class="n">step</span> <span class="o">=</span> <span class="n">checkpoint</span><span class="p">[</span><span class="s2">&quot;step&quot;</span><span class="p">]</span>
</span><span id="__span-4-827"><a id="__codelineno-4-827" name="__codelineno-4-827" href="#__codelineno-4-827"></a>    <span class="n">nsamples</span> <span class="o">=</span> <span class="n">checkpoint</span><span class="p">[</span><span class="s2">&quot;num_samples&quot;</span><span class="p">]</span>
</span><span id="__span-4-828"><a id="__codelineno-4-828" name="__codelineno-4-828" href="#__codelineno-4-828"></a>    <span class="n">random</span><span class="o">.</span><span class="n">setstate</span><span class="p">(</span><span class="n">checkpoint</span><span class="p">[</span><span class="s2">&quot;python_rng_state&quot;</span><span class="p">])</span>
</span><span id="__span-4-829"><a id="__codelineno-4-829" name="__codelineno-4-829" href="#__codelineno-4-829"></a>    <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">set_state</span><span class="p">(</span><span class="n">checkpoint</span><span class="p">[</span><span class="s2">&quot;numpy_rng_state&quot;</span><span class="p">])</span>
</span><span id="__span-4-830"><a id="__codelineno-4-830" name="__codelineno-4-830" href="#__codelineno-4-830"></a>    <span class="n">cpu_rng_state</span> <span class="o">=</span> <span class="n">checkpoint</span><span class="p">[</span><span class="s2">&quot;torch_rng_state_cpu&quot;</span><span class="p">]</span>
</span><span id="__span-4-831"><a id="__codelineno-4-831" name="__codelineno-4-831" href="#__codelineno-4-831"></a>    <span class="n">torch</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">set_rng_state</span><span class="p">(</span><span class="n">cpu_rng_state</span><span class="o">.</span><span class="n">cpu</span><span class="p">())</span>
</span><span id="__span-4-832"><a id="__codelineno-4-832" name="__codelineno-4-832" href="#__codelineno-4-832"></a>    <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">set_rng_state_all</span><span class="p">([</span><span class="n">t</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">checkpoint</span><span class="p">[</span><span class="s2">&quot;torch_rng_state_gpu&quot;</span><span class="p">]])</span>
</span><span id="__span-4-833"><a id="__codelineno-4-833" name="__codelineno-4-833" href="#__codelineno-4-833"></a>    <span class="k">return</span> <span class="n">epoch</span><span class="p">,</span> <span class="n">step</span><span class="p">,</span> <span class="n">nsamples</span>
</span><span id="__span-4-834"><a id="__codelineno-4-834" name="__codelineno-4-834" href="#__codelineno-4-834"></a>
</span><span id="__span-4-835"><a id="__codelineno-4-835" name="__codelineno-4-835" href="#__codelineno-4-835"></a>
</span><span id="__span-4-836"><a id="__codelineno-4-836" name="__codelineno-4-836" href="#__codelineno-4-836"></a><span class="k">def</span><span class="w"> </span><span class="nf">save_checkpoint</span><span class="p">(</span>
</span><span id="__span-4-837"><a id="__codelineno-4-837" name="__codelineno-4-837" href="#__codelineno-4-837"></a>    <span class="n">checkpoint_path</span><span class="p">:</span> <span class="n">Path</span><span class="p">,</span>
</span><span id="__span-4-838"><a id="__codelineno-4-838" name="__codelineno-4-838" href="#__codelineno-4-838"></a>    <span class="n">model</span><span class="p">:</span> <span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">,</span>
</span><span id="__span-4-839"><a id="__codelineno-4-839" name="__codelineno-4-839" href="#__codelineno-4-839"></a>    <span class="n">optimizer</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">Optimizer</span><span class="p">,</span>
</span><span id="__span-4-840"><a id="__codelineno-4-840" name="__codelineno-4-840" href="#__codelineno-4-840"></a>    <span class="n">device</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">,</span>
</span><span id="__span-4-841"><a id="__codelineno-4-841" name="__codelineno-4-841" href="#__codelineno-4-841"></a>    <span class="n">epoch</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
</span><span id="__span-4-842"><a id="__codelineno-4-842" name="__codelineno-4-842" href="#__codelineno-4-842"></a>    <span class="n">step</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
</span><span id="__span-4-843"><a id="__codelineno-4-843" name="__codelineno-4-843" href="#__codelineno-4-843"></a>    <span class="n">num_samples</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
</span><span id="__span-4-844"><a id="__codelineno-4-844" name="__codelineno-4-844" href="#__codelineno-4-844"></a><span class="p">):</span>
</span><span id="__span-4-845"><a id="__codelineno-4-845" name="__codelineno-4-845" href="#__codelineno-4-845"></a>    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Saving checkpoint at </span><span class="si">{</span><span class="n">checkpoint_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-4-846"><a id="__codelineno-4-846" name="__codelineno-4-846" href="#__codelineno-4-846"></a>    <span class="n">checkpoint</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="__span-4-847"><a id="__codelineno-4-847" name="__codelineno-4-847" href="#__codelineno-4-847"></a>        <span class="s2">&quot;model&quot;</span><span class="p">:</span> <span class="n">model</span><span class="o">.</span><span class="n">state_dict</span><span class="p">(),</span>
</span><span id="__span-4-848"><a id="__codelineno-4-848" name="__codelineno-4-848" href="#__codelineno-4-848"></a>        <span class="s2">&quot;optimizer&quot;</span><span class="p">:</span> <span class="n">optimizer</span><span class="o">.</span><span class="n">state_dict</span><span class="p">(),</span>
</span><span id="__span-4-849"><a id="__codelineno-4-849" name="__codelineno-4-849" href="#__codelineno-4-849"></a>        <span class="s2">&quot;epoch&quot;</span><span class="p">:</span> <span class="n">epoch</span><span class="p">,</span>
</span><span id="__span-4-850"><a id="__codelineno-4-850" name="__codelineno-4-850" href="#__codelineno-4-850"></a>        <span class="s2">&quot;step&quot;</span><span class="p">:</span> <span class="n">step</span><span class="p">,</span>
</span><span id="__span-4-851"><a id="__codelineno-4-851" name="__codelineno-4-851" href="#__codelineno-4-851"></a>        <span class="s2">&quot;num_samples&quot;</span><span class="p">:</span> <span class="n">num_samples</span><span class="p">,</span>
</span><span id="__span-4-852"><a id="__codelineno-4-852" name="__codelineno-4-852" href="#__codelineno-4-852"></a>        <span class="s2">&quot;python_rng_state&quot;</span><span class="p">:</span> <span class="n">random</span><span class="o">.</span><span class="n">getstate</span><span class="p">(),</span>
</span><span id="__span-4-853"><a id="__codelineno-4-853" name="__codelineno-4-853" href="#__codelineno-4-853"></a>        <span class="s2">&quot;numpy_rng_state&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">get_state</span><span class="p">(),</span>
</span><span id="__span-4-854"><a id="__codelineno-4-854" name="__codelineno-4-854" href="#__codelineno-4-854"></a>        <span class="s2">&quot;torch_rng_state_cpu&quot;</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">get_rng_state</span><span class="p">(),</span>
</span><span id="__span-4-855"><a id="__codelineno-4-855" name="__codelineno-4-855" href="#__codelineno-4-855"></a>        <span class="s2">&quot;torch_rng_state_gpu&quot;</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">get_rng_state_all</span><span class="p">(),</span>
</span><span id="__span-4-856"><a id="__codelineno-4-856" name="__codelineno-4-856" href="#__codelineno-4-856"></a>    <span class="p">}</span>
</span><span id="__span-4-857"><a id="__codelineno-4-857" name="__codelineno-4-857" href="#__codelineno-4-857"></a>    <span class="n">tmp_checkpoint_path</span> <span class="o">=</span> <span class="n">checkpoint_path</span><span class="o">.</span><span class="n">with_suffix</span><span class="p">(</span><span class="s2">&quot;.temp&quot;</span><span class="p">)</span>
</span><span id="__span-4-858"><a id="__codelineno-4-858" name="__codelineno-4-858" href="#__codelineno-4-858"></a>    <span class="n">torch</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">checkpoint</span><span class="p">,</span> <span class="n">tmp_checkpoint_path</span><span class="p">)</span>
</span><span id="__span-4-859"><a id="__codelineno-4-859" name="__codelineno-4-859" href="#__codelineno-4-859"></a>    <span class="n">tmp_checkpoint_path</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">checkpoint_path</span><span class="p">)</span>
</span><span id="__span-4-860"><a id="__codelineno-4-860" name="__codelineno-4-860" href="#__codelineno-4-860"></a>
</span><span id="__span-4-861"><a id="__codelineno-4-861" name="__codelineno-4-861" href="#__codelineno-4-861"></a>
</span><span id="__span-4-862"><a id="__codelineno-4-862" name="__codelineno-4-862" href="#__codelineno-4-862"></a><span class="nd">@contextlib</span><span class="o">.</span><span class="n">contextmanager</span>
</span><span id="__span-4-863"><a id="__codelineno-4-863" name="__codelineno-4-863" href="#__codelineno-4-863"></a><span class="k">def</span><span class="w"> </span><span class="nf">goes_first</span><span class="p">(</span><span class="n">condition</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span> <span class="n">group</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">distributed</span><span class="o">.</span><span class="n">ProcessGroup</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
</span><span id="__span-4-864"><a id="__codelineno-4-864" name="__codelineno-4-864" href="#__codelineno-4-864"></a>    <span class="k">if</span> <span class="n">condition</span><span class="p">:</span>
</span><span id="__span-4-865"><a id="__codelineno-4-865" name="__codelineno-4-865" href="#__codelineno-4-865"></a>        <span class="k">yield</span>
</span><span id="__span-4-866"><a id="__codelineno-4-866" name="__codelineno-4-866" href="#__codelineno-4-866"></a>        <span class="n">torch</span><span class="o">.</span><span class="n">distributed</span><span class="o">.</span><span class="n">barrier</span><span class="p">(</span><span class="n">group</span><span class="o">=</span><span class="n">group</span><span class="p">,</span> <span class="n">device_ids</span><span class="o">=</span><span class="p">[</span><span class="n">LOCAL_RANK</span><span class="p">])</span>
</span><span id="__span-4-867"><a id="__codelineno-4-867" name="__codelineno-4-867" href="#__codelineno-4-867"></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="__span-4-868"><a id="__codelineno-4-868" name="__codelineno-4-868" href="#__codelineno-4-868"></a>        <span class="n">torch</span><span class="o">.</span><span class="n">distributed</span><span class="o">.</span><span class="n">barrier</span><span class="p">(</span><span class="n">group</span><span class="o">=</span><span class="n">group</span><span class="p">,</span> <span class="n">device_ids</span><span class="o">=</span><span class="p">[</span><span class="n">LOCAL_RANK</span><span class="p">])</span>
</span><span id="__span-4-869"><a id="__codelineno-4-869" name="__codelineno-4-869" href="#__codelineno-4-869"></a>        <span class="k">yield</span>
</span><span id="__span-4-870"><a id="__codelineno-4-870" name="__codelineno-4-870" href="#__codelineno-4-870"></a>
</span><span id="__span-4-871"><a id="__codelineno-4-871" name="__codelineno-4-871" href="#__codelineno-4-871"></a>
</span><span id="__span-4-872"><a id="__codelineno-4-872" name="__codelineno-4-872" href="#__codelineno-4-872"></a><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
</span><span id="__span-4-873"><a id="__codelineno-4-873" name="__codelineno-4-873" href="#__codelineno-4-873"></a>    <span class="n">main</span><span class="p">()</span>
</span></code></pre></div>
<h2 id="running-this-example">Running this example<a class="headerlink" href="#running-this-example" title="Permanent link">&para;</a></h2>
<p>You can submit this as a batch job with sbatch, or you can run it in an interactive job with <code>srun</code>:</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-5-1"><a id="__codelineno-5-1" name="__codelineno-5-1" href="#__codelineno-5-1"></a>$<span class="w"> </span>sbatch<span class="w"> </span>job.sh
</span></code></pre></div>
<p>or, for example in an interactive job:</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-6-1"><a id="__codelineno-6-1" name="__codelineno-6-1" href="#__codelineno-6-1"></a>$<span class="w"> </span>ssh<span class="w"> </span>mila<span class="w"> </span><span class="s1">&#39;git clone https://github.com/mila-iqia/mila-docs&#39;</span>
</span><span id="__span-6-2"><a id="__codelineno-6-2" name="__codelineno-6-2" href="#__codelineno-6-2"></a>
</span><span id="__span-6-3"><a id="__codelineno-6-3" name="__codelineno-6-3" href="#__codelineno-6-3"></a><span class="c1"># Get an interactive job. You can use as many nodes or gpus, in whatever configuration you wish.</span>
</span><span id="__span-6-4"><a id="__codelineno-6-4" name="__codelineno-6-4" href="#__codelineno-6-4"></a><span class="c1"># Here we choose to use between 1 and 2 nodes, with 4 GPUs distributed in any between the two nodes. (could be 4-0, 3-1, 2-2, etc.)</span>
</span><span id="__span-6-5"><a id="__codelineno-6-5" name="__codelineno-6-5" href="#__codelineno-6-5"></a>$<span class="w"> </span>ssh<span class="w"> </span>-tt<span class="w"> </span>mila<span class="w"> </span>salloc<span class="w"> </span>--nodes<span class="o">=</span><span class="m">1</span>-2<span class="w"> </span>--ntasks<span class="o">=</span><span class="m">4</span><span class="w"> </span>--gpus-per-task<span class="o">=</span>l40s:1<span class="w"> </span>--cpus-per-task<span class="o">=</span><span class="m">4</span><span class="w"> </span>--mem<span class="o">=</span>32G<span class="w"> </span>--tmp<span class="o">=</span>200G<span class="w"> </span>--time<span class="o">=</span><span class="m">02</span>:59:00<span class="w"> </span>--partition<span class="o">=</span>short-unkillable
</span><span id="__span-6-6"><a id="__codelineno-6-6" name="__codelineno-6-6" href="#__codelineno-6-6"></a>salloc:<span class="w"> </span>Granted<span class="w"> </span>job<span class="w"> </span>allocation<span class="w"> </span><span class="m">7782523</span>
</span><span id="__span-6-7"><a id="__codelineno-6-7" name="__codelineno-6-7" href="#__codelineno-6-7"></a>salloc:<span class="w"> </span>Waiting<span class="w"> </span><span class="k">for</span><span class="w"> </span>resource<span class="w"> </span>configuration
</span><span id="__span-6-8"><a id="__codelineno-6-8" name="__codelineno-6-8" href="#__codelineno-6-8"></a>salloc:<span class="w"> </span>Nodes<span class="w"> </span>cn-l<span class="o">[</span><span class="m">023</span>,054<span class="o">]</span><span class="w"> </span>are<span class="w"> </span>ready<span class="w"> </span><span class="k">for</span><span class="w"> </span>job
</span><span id="__span-6-9"><a id="__codelineno-6-9" name="__codelineno-6-9" href="#__codelineno-6-9"></a>
</span><span id="__span-6-10"><a id="__codelineno-6-10" name="__codelineno-6-10" href="#__codelineno-6-10"></a><span class="c1"># Run the dataset preparation on each node:</span>
</span><span id="__span-6-11"><a id="__codelineno-6-11" name="__codelineno-6-11" href="#__codelineno-6-11"></a>$<span class="w"> </span><span class="nb">cd</span><span class="w"> </span>mila-docs/docs/examples/advanced/imagenet
</span><span id="__span-6-12"><a id="__codelineno-6-12" name="__codelineno-6-12" href="#__codelineno-6-12"></a>$<span class="w"> </span>srun<span class="w"> </span>--ntasks-per-node<span class="o">=</span><span class="m">1</span><span class="w"> </span>uv<span class="w"> </span>run<span class="w"> </span>python<span class="w"> </span>prepare_data.py
</span><span id="__span-6-13"><a id="__codelineno-6-13" name="__codelineno-6-13" href="#__codelineno-6-13"></a>
</span><span id="__span-6-14"><a id="__codelineno-6-14" name="__codelineno-6-14" href="#__codelineno-6-14"></a><span class="c1"># Run the training script on each gpu on each node</span>
</span><span id="__span-6-15"><a id="__codelineno-6-15" name="__codelineno-6-15" href="#__codelineno-6-15"></a><span class="c1"># NOTE: this only works in an interactive terminal with salloc! For the VsCode integrated terminal, see below.</span>
</span><span id="__span-6-16"><a id="__codelineno-6-16" name="__codelineno-6-16" href="#__codelineno-6-16"></a>$<span class="w"> </span>srun<span class="w"> </span>uv<span class="w"> </span>run<span class="w"> </span>python<span class="w"> </span>prepare_data.py
</span></code></pre></div>
<p>To open this example with VsCode:</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-7-1"><a id="__codelineno-7-1" name="__codelineno-7-1" href="#__codelineno-7-1"></a>$<span class="w"> </span>mila<span class="w"> </span>code<span class="w"> </span>mila-docs/docs/examples/advanced/imagenet<span class="w"> </span>--alloc<span class="w"> </span>--ntasks<span class="o">=</span><span class="m">4</span><span class="w"> </span>--gpus-per-task<span class="o">=</span>l40s:1<span class="w"> </span>--mem<span class="o">=</span>32G<span class="w"> </span>--tmp<span class="o">=</span>200G<span class="w"> </span>--time<span class="o">=</span><span class="m">02</span>:59:00<span class="w"> </span>--partition<span class="o">=</span>short-unkillable
</span><span id="__span-7-2"><a id="__codelineno-7-2" name="__codelineno-7-2" href="#__codelineno-7-2"></a><span class="c1"># Or, if you are already in a terminal in an interactive job:</span>
</span><span id="__span-7-3"><a id="__codelineno-7-3" name="__codelineno-7-3" href="#__codelineno-7-3"></a>$<span class="w"> </span>mila<span class="w"> </span>code<span class="w"> </span>mila-docs/docs/examples/advanced/imagenet<span class="w"> </span>--job<span class="w"> </span><span class="m">7782523</span>
</span></code></pre></div>
<p>Then, in the vscode terminal, you will have to explicitly list out the number of nodes and tasks to use, since those
can't be inferred from the SLURM environment variables (which are not present, since you are SSH-ing into the compute node).</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-8-1"><a id="__codelineno-8-1" name="__codelineno-8-1" href="#__codelineno-8-1"></a><span class="c1"># If your job has 2 nodes, for example:</span>
</span><span id="__span-8-2"><a id="__codelineno-8-2" name="__codelineno-8-2" href="#__codelineno-8-2"></a>$<span class="w"> </span>srun<span class="w"> </span>--ntasks-per-node<span class="o">=</span><span class="m">1</span><span class="w"> </span>--nodes<span class="o">=</span><span class="m">2</span><span class="w"> </span>uv<span class="w"> </span>run<span class="w"> </span>python<span class="w"> </span>prepare_data.py
</span><span id="__span-8-3"><a id="__codelineno-8-3" name="__codelineno-8-3" href="#__codelineno-8-3"></a><span class="c1"># Launch the training script on each gpu on each node</span>
</span><span id="__span-8-4"><a id="__codelineno-8-4" name="__codelineno-8-4" href="#__codelineno-8-4"></a>$<span class="w"> </span>srun<span class="w"> </span>--ntasks<span class="o">=</span><span class="m">4</span><span class="w"> </span>--nodes<span class="o">=</span><span class="m">2</span><span class="w"> </span>uv<span class="w"> </span>run<span class="w"> </span>python<span class="w"> </span>main.py
</span></code></pre></div>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      
      <script id="__config" type="application/json">{"annotate": null, "base": "../../..", "features": ["announce.dismiss", "content.code.copy", "content.code.select", "content.code.annotate", "navigation.tracking", "navigation.sections", "navigation.path", "navigation.indexes", "search.suggest", "search.highlight", "search.share"], "search": "../../../assets/javascripts/workers/search.2c215733.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../../../assets/javascripts/bundle.79ae519e.min.js"></script>
      
    
  </body>
</html>